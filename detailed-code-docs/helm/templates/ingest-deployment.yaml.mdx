---
title: "ingest-deployment.yaml"
---

## High-level description
This YAML file defines a Kubernetes Deployment for an "ingest" application. It specifies the container configuration, environment variables, and optional Cloud SQL proxy setup for Google Cloud deployments.

## Table of contents
- Metadata
- Deployment Specification
- Pod Template
- Container Configuration
- Environment Variables
- Cloud SQL Proxy Configuration (conditional)

## Code Structure
The main structure is a Kubernetes Deployment resource. It contains metadata, a selector for pod management, and a pod template specification. The pod template includes container configurations with extensive environment variable settings.

## Symbols

### Deployment
#### Description
Defines a Kubernetes Deployment named "ingest" with labels for identification and management.

#### Internal Logic
- Sets up a selector to manage pods
- Defines a pod template with container specifications
- Conditionally includes a Cloud SQL proxy container for Google Cloud deployments

### Container: ingest
#### Description
Specifies the main application container for the ingest service.

#### Internal Logic
- Uses a dynamically constructed image name based on the deployment environment
- Sets up numerous environment variables for application configuration

### Container: cloud-sql-proxy (conditional)
#### Description
Includes a Cloud SQL proxy container when deployed in Google Cloud environment.

#### Internal Logic
- Uses the Cloud SQL Auth Proxy image
- Configures proxy arguments for secure database connection
- Sets resource requests and limits

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Helm | Template rendering and value substitution |
| Kubernetes | Deployment and container orchestration |
| Cloud SQL Auth Proxy | Secure connection to Cloud SQL (Google Cloud only) |

## Configuration
The deployment heavily relies on Helm values for configuration. Key configuration areas include:

- Environment-specific settings (e.g., `$.Values.environment`)
- Container image and tag (`$.Values.containers.ingest.tag`)
- Various application configurations (e.g., database, Redis, Qdrant, SMTP, OpenAI, S3, etc.)
- Service account for Google Cloud deployments

## Future Improvements
1. Consider using Kubernetes Secrets for sensitive information like API keys and passwords.
2. Implement resource requests and limits for the main ingest container to ensure proper resource allocation.
3. Use init containers for any necessary setup tasks before the main container starts.
4. Implement readiness and liveness probes to improve the reliability of the deployment.
5. Consider breaking down the large list of environment variables into ConfigMaps for better manageability.
6. Evaluate the use of Kubernetes Volumes for persistent storage needs, if any.
7. Implement network policies to restrict communication between pods if needed for enhanced security.