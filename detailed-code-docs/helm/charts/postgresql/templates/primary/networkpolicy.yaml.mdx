---
title: "networkpolicy.yaml"
---

## High-level description
This YAML file defines a Kubernetes NetworkPolicy for the primary PostgreSQL instance in a Helm chart. It controls ingress and egress traffic for the primary PostgreSQL pod, allowing specific connections and optionally restricting external access.

## Table of contents
- NetworkPolicy definition
- Metadata
- Spec
  - Pod selector
  - Policy types
  - Egress rules
  - Ingress rules

## Code Structure
The file uses Helm templating to dynamically generate the NetworkPolicy based on various configuration values. It references several helper templates and uses conditional statements to include or exclude certain rules based on the provided values.

## Symbols

### NetworkPolicy
#### Description
Defines a Kubernetes NetworkPolicy resource to control network traffic for the primary PostgreSQL pod.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| .Values.primary.networkPolicy | Object | Configuration for the NetworkPolicy |
| .Values.commonLabels | Object | Common labels to apply to resources |
| .Values.commonAnnotations | Object | Common annotations to apply to resources |
| .Values.containerPorts | Object | Container port configurations |
| .Values.metrics | Object | Metrics-related configurations |

#### Internal Logic
1. Checks if NetworkPolicy is enabled for the primary instance
2. Sets metadata including name, namespace, labels, and annotations
3. Defines pod selector using merged labels
4. Specifies policy types (Ingress and Egress)
5. Configures egress rules based on allowExternalEgress flag
6. Configures ingress rules, including optional restrictions on external access
7. Includes additional custom egress and ingress rules if specified

## Side Effects
This NetworkPolicy affects the network traffic to and from the primary PostgreSQL pod, potentially restricting or allowing specific connections based on the configuration.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| common.capabilities.networkPolicy.apiVersion | Determines the appropriate API version for NetworkPolicy |
| common.names.namespace | Provides the namespace for the resource |
| common.labels.standard | Generates standard labels |
| common.tplvalues.render | Renders template values |
| common.labels.matchLabels | Generates match labels for selectors |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| primary.networkPolicy.enabled | boolean | - | Enables or disables the NetworkPolicy |
| primary.networkPolicy.allowExternalEgress | boolean | - | Allows all egress traffic if true |
| primary.networkPolicy.allowExternal | boolean | - | Allows ingress from external sources if true |
| primary.networkPolicy.extraEgress | array | - | Additional custom egress rules |
| primary.networkPolicy.extraIngress | array | - | Additional custom ingress rules |
| primary.networkPolicy.ingressNSMatchLabels | object | - | Namespace match labels for ingress |
| primary.networkPolicy.ingressNSPodMatchLabels | object | - | Pod match labels for ingress from specific namespaces |

## Future Improvements
1. Consider adding support for more granular egress rules, such as allowing connections to specific external services.
2. Implement options for customizing the DNS resolution ports (currently hardcoded to 53).
3. Add support for IPv6 policies if not already present in the broader chart context.
4. Consider separating the ingress rules for PostgreSQL and metrics ports for better clarity and easier customization.