---
title: "metrics-svc.yaml"
---

## High-level description
This YAML template defines a Kubernetes Service for PostgreSQL metrics in a read-replica setup. It's conditionally created based on metrics being enabled and the architecture being set to replication.

## Table of contents
- Service metadata
- Service specification
- Port configuration
- Selector

## Code Structure
The template uses Helm functions and conditionals to dynamically generate a Kubernetes Service manifest. It references various values from the Helm chart's configuration.

## Symbols

### Service Definition
#### Description
Defines a Kubernetes Service for exposing PostgreSQL metrics from read replicas.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| .Values.metrics.enabled | boolean | Determines if metrics are enabled |
| .Values.architecture | string | The PostgreSQL architecture type |
| .Values.commonLabels | map | Common labels to apply |
| .Values.commonAnnotations | map | Common annotations to apply |
| .Values.metrics.service | map | Configuration for the metrics service |
| .Values.readReplicas.podLabels | map | Labels for read replica pods |

#### Outputs
A Kubernetes Service manifest for PostgreSQL metrics on read replicas.

#### Internal Logic
1. Checks if metrics are enabled and architecture is replication
2. Sets metadata including name, namespace, labels, and annotations
3. Defines service spec with type, session affinity, and optional clusterIP
4. Configures a single port for HTTP metrics
5. Sets selector to target read replica pods

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| common | Provides helper templates for labels, annotations, and value merging |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| metrics.enabled | boolean | - | Enables or disables metrics |
| architecture | string | - | PostgreSQL architecture type |
| metrics.service.sessionAffinity | string | - | Session affinity for the service |
| metrics.service.clusterIP | string | - | Optional ClusterIP for the service |
| metrics.service.ports.metrics | number | - | Port number for metrics |

## Future Improvements
- Consider adding support for multiple metric ports if needed
- Implement optional TLS configuration for secure metrics collection
- Add support for different service types (e.g., NodePort, LoadBalancer) based on configuration