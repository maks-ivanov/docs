---
title: "statefulset.yaml"
---

## High-level description
This YAML file defines a Kubernetes StatefulSet for deploying and managing Qdrant, a vector database. It configures the deployment, including container specifications, volume mounts, security contexts, and probes for health checking.

## Table of contents
- Metadata
- StatefulSet Specification
- Pod Template
- Container Specification
- Volume Mounts
- Probes (Liveness, Readiness, Startup)
- Security Contexts
- Volumes
- Volume Claim Templates

## Code Structure
The YAML file is structured as a Kubernetes StatefulSet resource, with nested specifications for the pod template, containers, volumes, and persistent volume claims. It uses Helm templating to inject values and create a flexible, configurable deployment.

## Symbols

### StatefulSet
#### Description
Defines a StatefulSet for Qdrant, managing the deployment and scaling of a set of Pods.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| .Values | Object | Helm values for configuring the StatefulSet |
| .Chart | Object | Helm chart metadata |

#### Internal Logic
1. Sets up metadata and labels
2. Configures replica count and pod management policy
3. Defines pod template with annotations, labels, and spec
4. Sets up containers, including init containers if needed
5. Configures probes, resources, and security contexts
6. Defines volumes and volume mounts
7. Sets up persistent volume claim template

### Container Specification
#### Description
Defines the main Qdrant container within the pod template.

#### Internal Logic
1. Sets container image and pull policy
2. Configures environment variables
3. Sets up ports for the service
4. Configures probes (liveness, readiness, startup)
5. Sets resource limits and requests
6. Configures security context and lifecycle hooks
7. Sets up volume mounts

### Probes
#### Description
Configures liveness, readiness, and startup probes for health checking the Qdrant container.

#### Internal Logic
1. Checks if probes are enabled and ports have checks enabled
2. Configures HTTP or gRPC probes based on the port name
3. Sets probe parameters (delay, timeout, period, thresholds)

### Volume Mounts
#### Description
Configures the volumes to be mounted in the Qdrant container.

#### Internal Logic
1. Mounts storage, config, and snapshots volumes
2. Conditionally mounts secrets for API keys
3. Adds additional volume mounts if specified in values

### Volumes
#### Description
Defines the volumes used by the StatefulSet.

#### Internal Logic
1. Creates config volume from ConfigMap
2. Sets up snapshots volume (either persistent or emptyDir)
3. Creates init volume as emptyDir
4. Conditionally creates secret volume for API keys
5. Adds additional volumes if specified in values

### Volume Claim Templates
#### Description
Defines the persistent volume claim template for Qdrant storage.

#### Internal Logic
1. Sets metadata and labels for the claim
2. Configures storage class, access modes, and size based on values

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Kubernetes | The target platform for deploying the StatefulSet |
| Helm | Used for templating and value injection |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| .Values.replicaCount | Integer | N/A | Number of replicas for the StatefulSet |
| .Values.image.repository | String | N/A | Docker image repository for Qdrant |
| .Values.image.tag | String | N/A | Docker image tag for Qdrant |
| .Values.persistence.size | String | N/A | Size of the persistent volume for storage |

## Future Improvements
1. Consider adding support for auto-scaling the StatefulSet based on resource usage or custom metrics.
2. Implement a more robust update strategy, possibly using rolling updates with partition.
3. Add support for backup and restore operations, potentially using Kubernetes CronJobs for scheduled backups.
4. Enhance security by implementing network policies and more granular RBAC rules.
5. Consider adding support for multi-zone deployments to improve availability and disaster recovery capabilities.