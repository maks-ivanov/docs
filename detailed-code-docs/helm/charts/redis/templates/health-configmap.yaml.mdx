---
title: "health-configmap.yaml"
---

## High-level description
This YAML file defines a Kubernetes ConfigMap for Redis health checks. It contains shell scripts for checking the readiness and liveness of Redis instances, including local instances, master instances, and Sentinel instances (if enabled).

## Table of contents
- ConfigMap metadata
- Data section containing shell scripts:
  - ping_readiness_local.sh
  - ping_liveness_local.sh
  - ping_sentinel.sh (conditional)
  - parse_sentinels.awk (conditional)
  - ping_readiness_master.sh
  - ping_liveness_master.sh
  - ping_readiness_local_and_master.sh
  - ping_liveness_local_and_master.sh

## Code Structure
The ConfigMap is structured with metadata and a data section. The data section contains multiple shell scripts for different health check scenarios, with some scripts being conditionally included based on the Helm chart values.

## Symbols

### ConfigMap
#### Description
Defines a Kubernetes ConfigMap named with the suffix "-health" appended to the full name of the Redis release. It contains shell scripts for health checks.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| .Values | Object | Helm values for the Redis chart |
| $ | Object | The root context of the Helm chart |

### ping_readiness_local.sh
#### Description
A shell script that checks the readiness of a local Redis instance by sending a PING command and expecting a PONG response.

#### Internal Logic
1. Sets up authentication if a password is provided
2. Uses `redis-cli` to send a PING command to the local Redis instance
3. Checks for timeout and correct response

### ping_liveness_local.sh
#### Description
Similar to the readiness script, but also accepts LOADING and MASTERDOWN as valid responses for liveness.

### ping_sentinel.sh (conditional)
#### Description
Checks the health of a Redis Sentinel instance. Only included if Sentinel is enabled.

### parse_sentinels.awk
#### Description
An AWK script to parse Sentinel information. Only included if Sentinel is enabled.

### ping_readiness_master.sh
#### Description
Checks the readiness of the Redis master instance.

### ping_liveness_master.sh
#### Description
Checks the liveness of the Redis master instance, allowing for LOADING state.

### ping_readiness_local_and_master.sh
#### Description
Combines readiness checks for both local and master instances.

### ping_liveness_local_and_master.sh
#### Description
Combines liveness checks for both local and master instances.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| redis-cli | Used in scripts to send commands to Redis instances |

## Configuration
The ConfigMap uses various Helm chart values for configuration:

| Option | Type | Description |
|:-------|:-----|:------------|
| .Values.tls.enabled | boolean | Enables TLS configuration for Redis connections |
| .Values.sentinel.enabled | boolean | Enables Sentinel-specific configurations |
| .Values.auth.sentinel | boolean | Enables Sentinel authentication |

## Error Handling
The scripts use exit codes to indicate success (0) or failure (1). Timeouts and unexpected responses are treated as errors.

## Future Improvements
- Consider adding more detailed health checks beyond simple PING commands
- Implement retries for transient failures
- Add support for custom health check scripts defined in Helm values