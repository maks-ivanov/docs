---
title: "ports-configmap.yaml"
---

## High-level description
This Helm chart template generates a ConfigMap for Redis Sentinel, specifically for managing NodePort assignments in a Kubernetes environment. It dynamically selects available NodePorts and creates a ConfigMap to store these port assignments for Redis and Sentinel services.

## Table of contents
- Conditional checks and variable initialization
- NodePort selection logic
- ConfigMap creation
- Port assignment for Redis and Sentinel services

## Code Structure
The code is structured as a single Helm template file that performs two main tasks:
1. Dynamically selects available NodePorts
2. Creates a ConfigMap with the selected ports

The first part of the code focuses on port selection, while the latter part creates the ConfigMap using the selected ports.

## Symbols

### NodePort Selection Logic
#### Description
This section of the code selects available NodePorts for Redis and Sentinel services.

#### Internal Logic
1. Initialize empty lists for chosen ports and used ports
2. Retrieve all used NodePorts from existing services
3. Sort the list of used ports
4. Calculate the number of required ports based on replica count
5. Iterate through potential NodePorts (starting from 30000)
6. Check if each port is available and not already chosen
7. Add selected ports to the chosen ports list

### ConfigMap Creation
#### Description
This section creates a ConfigMap to store the selected NodePorts for Redis and Sentinel services.

#### Internal Logic
1. Check if a ConfigMap with the same name already exists
2. If it exists, use the existing data
3. If it doesn't exist, create a new ConfigMap with the selected ports
4. Assign ports to services (main Sentinel, main Redis, and replica nodes)

## Side Effects
- Creates or updates a ConfigMap in the Kubernetes cluster
- Modifies the cluster's state by adding new port assignments

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Helm | Template rendering and Kubernetes resource management |
| Kubernetes API | Lookup existing services and ConfigMaps |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| .Values.architecture | string | - | Must be "replication" for this template to be applied |
| .Values.sentinel.enabled | boolean | - | Must be true for this template to be applied |
| .Values.sentinel.service.type | string | - | Must be "NodePort" for this template to be applied |
| .Values.replica.replicaCount | integer | - | Determines the number of replica nodes |

## Future Improvements
- Consider implementing a more efficient algorithm for port selection to reduce iteration
- Add error handling for scenarios where no available ports are found
- Implement a mechanism to handle port conflicts that may arise after initial deployment
- Consider adding support for custom port ranges or exclusions

This template provides a flexible and dynamic way to manage NodePort assignments for Redis Sentinel deployments in Kubernetes, ensuring that port conflicts are avoided and assignments are consistent across deployments.