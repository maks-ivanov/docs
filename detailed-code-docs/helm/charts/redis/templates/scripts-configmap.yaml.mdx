---
title: "scripts-configmap.yaml"
---

## High-level description
This file defines a ConfigMap for Redis and Redis Sentinel scripts used in a Helm chart. It contains shell scripts for starting and managing Redis master, replica, and sentinel nodes in various deployment scenarios.

## Table of contents
- start-node.sh
- start-sentinel.sh
- prestop-sentinel.sh
- prestop-redis.sh
- start-master.sh
- start-replica.sh

## Code Structure
The file defines a ConfigMap with multiple shell scripts. The scripts are conditionally included based on the Redis architecture (sentinel or replication) and other configuration options.

## Symbols

### start-node.sh
#### Description
This script is used to start a Redis node in a sentinel-managed cluster. It determines whether the node should be a master or replica based on the current cluster state and sentinel configuration.

#### Internal Logic
1. Defines utility functions for getting ports and hostnames
2. Determines the Redis replication mode (master or replica)
3. Configures the node based on its role
4. Handles TLS configuration if enabled
5. Executes the Redis server with appropriate arguments

### start-sentinel.sh
#### Description
This script starts a Redis Sentinel node. It configures the sentinel to monitor the Redis master and manages the sentinel's configuration file.

#### Internal Logic
1. Defines utility functions for getting ports and hostnames
2. Determines the current master node
3. Configures the sentinel.conf file
4. Handles TLS configuration if enabled
5. Executes the Redis server in sentinel mode

### prestop-sentinel.sh
#### Description
This script is executed before stopping a sentinel node. It ensures that a master failover is completed if necessary before the node is terminated.

#### Internal Logic
1. Checks if the current node is the master
2. If it is the master, initiates a failover
3. Waits for the failover to complete before allowing the node to stop

### prestop-redis.sh
#### Description
This script is executed before stopping a Redis node. It ensures that a master node initiates a failover before shutting down to prevent data loss.

#### Internal Logic
1. Checks if the current node is the master
2. If it is the master, pauses client write connections
3. Initiates a failover through the sentinel
4. Waits for the failover to complete before allowing the node to stop

### start-master.sh
#### Description
This script starts a Redis master node in a replication setup without sentinels.

#### Internal Logic
1. Configures the Redis server
2. Handles TLS configuration if enabled
3. Executes the Redis server with appropriate arguments

### start-replica.sh
#### Description
This script starts a Redis replica node in a replication setup without sentinels.

#### Internal Logic
1. Configures the Redis server as a replica
2. Handles TLS configuration if enabled
3. Executes the Redis server with appropriate arguments

## Dependencies
The scripts rely on the following external tools and libraries:
- redis-cli
- redis-server
- Various Bash utilities (awk, sed, openssl)

## Configuration
The scripts use various environment variables and Helm chart values for configuration, including:
- Redis passwords
- TLS settings
- Sentinel settings
- Replication settings

## Error Handling
The scripts include basic error handling, such as retrying operations and checking for required configuration values.

## Future Improvements
1. Enhance error handling and logging for better diagnostics
2. Implement more robust health checks before allowing node termination
3. Consider separating the scripts into individual ConfigMap entries for easier management
4. Add more comments to explain complex logic sections
5. Implement unit tests for critical functions in the scripts