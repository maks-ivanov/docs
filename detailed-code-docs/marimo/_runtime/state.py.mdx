---
title: "state.py"
---

## High-level description

The code in `marimo/_runtime/state.py` defines a reactive state management system for the Marimo library. It provides a `State` class that encapsulates a mutable value and a `SetFunctor` class to update this value. The `state` function is a utility to create a `State` instance and its associated setter function, allowing for reactive programming patterns where changes to state automatically trigger updates in dependent components.

## Code Structure

- The `State` class is the core component that holds a mutable value and provides a mechanism to update it.
- The `SetFunctor` class is tightly coupled with the `State` class, providing a callable interface to update the state's value.
- The `state` function is a higher-level utility that simplifies the creation and management of `State` instances by returning both a getter and a setter function.

## References

- The `get_context` function from `marimo._runtime.context` is used to retrieve the current runtime context, which is necessary for registering state updates.
- The `ContextNotInitializedError` is handled to ensure that state updates are only registered when a context is available.
- The `mddoc` decorator from `marimo._output.rich_help` is used to enhance the documentation of the `state` function.

## Symbols

### `State`
#### Description
The `State` class represents a mutable reactive state. It holds a value that can be updated, and optionally allows self-referential updates (self-loops).

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| value | T | The initial value of the state. |
| allow_self_loops | bool | Whether the state allows self-referential updates. Defaults to `False`. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| _value | T | The current value of the state. |

#### Internal Logic
- The constructor initializes the state with a given value and a flag for self-loops.
- The `__call__` method returns the current value of the state.

### `SetFunctor`
#### Description
The `SetFunctor` class provides a typed function interface to update the value of a `State` instance.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| state | State[T] | The state instance to be updated. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| None | None | This class does not return a value but updates the state. |

#### Internal Logic
- The constructor binds the `SetFunctor` to a specific `State` instance.
- The `__call__` method updates the state's value. If the update is a callable, it is invoked with the current state value; otherwise, the state is set directly to the new value.
- After updating, it attempts to register the state update with the current context, if available.

### `state`
#### Description
The `state` function is a utility to create a `State` instance and its associated setter function. It facilitates reactive programming by ensuring that changes to the state trigger updates in dependent components.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| value | T | The initial value of the state. |
| allow_self_loops | bool | Whether the state allows self-referential updates. Defaults to `False`. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| state_instance | State[T] | The created state instance. |
| state_instance._set_value | Callable[[T], None] | The setter function for the state. |

#### Internal Logic
- The function creates a `State` instance with the provided initial value and self-loop setting.
- It returns a tuple containing the state instance and its setter function.

## Side Effects
- The `SetFunctor` class registers state updates with the current context, which may trigger re-execution of dependent components.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `marimo._output.rich_help.mddoc` | Used to enhance the documentation of the `state` function. |
| `marimo._runtime.context.get_context` | Retrieves the current runtime context for state update registration. |
| `marimo._runtime.context.ContextNotInitializedError` | Exception handling for uninitialized contexts. |

## Error Handling
- The `SetFunctor` class handles `ContextNotInitializedError` to ensure that state updates are only registered when a context is available.

## Logging
- There is no explicit logging in this code, but the use of context registration implies that state changes may be logged or tracked elsewhere in the system.

## TODOs
- There are no TODOs or notes left in the code.