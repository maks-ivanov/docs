---
title: "up.sql"
---

## High-level description
This SQL script creates a table named `last_collapsed_dataset` in ClickHouse, designed to track the last collapse operation for datasets. It uses a ReplacingMergeTree engine for efficient updates and partitioning for optimized query performance.

## Table of contents
- Table creation
- Table structure
- Engine specification
- Ordering and partitioning

## Symbols

### `last_collapsed_dataset` Table
#### Description
This table is created to store information about the last collapse operation performed on datasets. It uses ClickHouse-specific syntax and features for optimized storage and retrieval.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Unique identifier for each record |
| last_collapsed | DateTime | Timestamp of the last collapse operation |
| dataset_id | UUID | Identifier of the dataset |
| created_at | DateTime | Timestamp of record creation |

#### Internal Logic
1. The table is created only if it doesn't already exist (`CREATE TABLE IF NOT EXISTS`).
2. It uses the ReplacingMergeTree engine, which allows for efficient updates by replacing rows with the same primary key.
3. The table is ordered by `dataset_id` for faster lookups.
4. Partitioning is done based on the year and month of `created_at` and the `dataset_id`, which can improve query performance and data management.

## Performance Considerations
- The use of ReplacingMergeTree engine allows for efficient updates of existing records.
- Ordering by `dataset_id` enables fast lookups when querying for specific datasets.
- Partitioning by year-month and dataset_id can significantly improve query performance for time-range and dataset-specific queries.

## Future Improvements
- Consider adding indices on frequently queried columns if query performance needs improvement.
- If the table grows large, evaluate the partitioning scheme to ensure it remains optimal for the query patterns.
- Implement a retention policy if historical data is not needed indefinitely.