---
title: "Overview"
---

## High-level description
The `server/src/middleware` directory houses custom middleware components for an Actix Web server. These middleware handle essential tasks such as API versioning, user authentication, and ensuring consistent JSON handling in requests.

## What does it do?
This directory acts as a gatekeeper for incoming HTTP requests to the server. Before a request reaches its intended handler, these middleware components spring into action:

1. **API Version Check:** The `api_version` middleware determines the appropriate API version for the request. It does this by checking a specific header or by looking at the creation date of the dataset being accessed. This ensures that the server can handle requests compatible with different versions of the API.

2. **User Authentication:** The `auth_middleware` verifies the identity of the user making the request. It checks for valid user sessions, API keys, and ensures that the user has the necessary permissions to access the requested resources. This is crucial for securing the application and protecting sensitive data.

3. **JSON Handling:** The `json_middleware` ensures that all requests are treated as JSON data. It does this by automatically adding the `Content-Type: application/json` header to any request that doesn't already have it. This simplifies request handling for APIs that primarily deal with JSON payloads.

## Entry points
The `mod.rs` file serves as the entry point to this directory, re-exporting the individual middleware modules: `api_version`, `auth_middleware`, and `json_middleware`. Each of these submodules contains its own logic for handling a specific aspect of the request pipeline.

Data flow is generally linear: a request enters the middleware pipeline, each middleware component potentially modifies the request or its context, and finally, the processed request is passed to the next middleware or the final request handler.

## Key Files
### server/src/middleware/api_version.rs
This file defines the `APIVersion` enum and the `ApiVersionMiddleware` struct. The `APIVersion` enum represents the different versions of the API supported by the server. The `ApiVersionMiddleware` is responsible for:

1. **Determining the API Version:** It checks the `X-API-Version` header and if not present or invalid, it infers the version from the dataset's creation date.
2. **Setting Request Extension:** It stores the determined `APIVersion` in the request extensions for later use by other parts of the application.
3. **Adding Response Header:** It adds the determined `APIVersion` to the response headers as `x-api-version` to inform the client about the API version used to process the request.

### server/src/middleware/auth_middleware.rs
This file houses the `AuthenticationMiddleware` struct, which is responsible for:

1. **User Authentication:** It attempts to authenticate the user by checking for session cookies or API keys provided in the request headers.
2. **Authorization:** It verifies if the authenticated user has the necessary permissions to access the requested resources based on their role within the organization.
3. **Contextual Information:** It retrieves and stores information about the user, organization, and dataset associated with the request in the request extensions for use by downstream handlers.

### server/src/middleware/json_middleware.rs
This file defines the `JsonMiddleware` struct, which ensures that all requests have the `Content-Type: application/json` header set. If the header is missing in the incoming request, the middleware adds it, ensuring consistent handling of JSON payloads throughout the application.
