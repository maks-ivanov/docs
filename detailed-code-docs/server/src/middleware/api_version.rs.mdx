---
title: "api_version.rs"
---

## High-level description
This code defines a middleware in Actix Web that checks and manages the API version used for requests. It determines the appropriate API version based on the dataset's creation date or a provided header, inserts it into the request extensions, and adds it to the response headers.

## Table of contents
- `APIVersion` enum
- `ApiVersionCheckFactory` struct
- `ApiVersionMiddleware` struct

## Code Structure
The `ApiVersionCheckFactory` is a transform that creates an instance of `ApiVersionMiddleware`. The `ApiVersionMiddleware` then uses the `APIVersion` enum to determine and manage the API version for each request.

## References
- `DatasetAndOrgWithSubAndPlan` from `crate::data::models`
- `ServiceError` from `crate::errors`

## Symbols

### `APIVersion`
#### Description
This enum represents the different API versions supported by the application.

#### Internal Logic
- `V1` represents API version 1.0.
- `V2` represents API version 2.0.
- The `from_dataset` method determines the API version based on the dataset's creation date. If the dataset was created after the date specified by the `V2_VERSIONING_DATE` environment variable, it uses `V2`; otherwise, it uses `V1`.

### `ApiVersionCheckFactory`
#### Description
This struct is a transform that creates an instance of `ApiVersionMiddleware`.

#### Internal Logic
- The `new_transform` method creates an instance of `ApiVersionMiddleware` with the provided service.

### `ApiVersionMiddleware`
#### Description
This struct is a middleware that checks and manages the API version for each request.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | ServiceRequest | The incoming service request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| res | ServiceResponse | The outgoing service response. |

#### Internal Logic
- It retrieves the `DatasetAndOrgWithSubAndPlan` from the request extensions.
- It checks for the `X-API-Version` header to determine the requested API version.
- If the header is not present or invalid, it uses the `APIVersion::from_dataset` method to determine the API version based on the dataset's creation date.
- It inserts the determined `APIVersion` into the request extensions.
- It calls the next service in the chain.
- It adds the determined `APIVersion` to the response headers as `x-api-version`.

## Dependencies
- `actix-web`: For web framework functionality.
- `chrono`: For date and time handling.
- `derive_more`: For deriving traits like `Display`.
- `futures-util`: For asynchronous programming utilities.
- `serde`: For serialization and deserialization.
- `utoipa`: For generating API documentation.

## Configuration
- `V2_VERSIONING_DATE`: An environment variable that specifies the date after which new datasets will use API version 2.0. The default value is "2024-07-14".

## Error Handling
- If the `DatasetAndOrgWithSubAndPlan` is not found in the request extensions, it returns an `InternalServerError` with a message indicating that the dataset was not found.

## Logging
- The `from_dataset` method logs an error if there is an issue parsing the `V2_VERSIONING_DATE` environment variable.

## Future Improvements
- The error handling could be improved to provide more specific error types for different scenarios, such as an invalid `X-API-Version` header.
- The middleware could be extended to support version negotiation, allowing clients to request a specific API version and the server to respond with the best-supported version.
