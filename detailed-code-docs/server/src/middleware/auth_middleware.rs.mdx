---
title: "auth_middleware.rs"
---

## High-level description
This Rust code implements an authentication middleware for a web server. It handles user authentication, API key validation, and role-based access control for different organizations and datasets.

## Table of contents
- AuthenticationMiddleware struct and implementation
- Helper functions for user and API key authentication
- Header parsing functions
- Role verification functions

## Code Structure
The main component is the `AuthenticationMiddleware` struct, which implements the `Service` trait. It uses helper functions like `get_user`, `auth_with_api_key`, and various header parsing functions to authenticate requests. The code also defines role verification functions for different user roles within organizations.

## Symbols

### AuthenticationMiddleware
#### Description
A middleware struct that handles authentication and authorization for incoming requests.

#### Internal Logic
1. Extracts user information from the request (either from session or API key)
2. Retrieves dataset and organization information if provided in headers
3. Verifies user permissions for the requested organization
4. Inserts authenticated user and organization role into request extensions

### get_user
#### Description
Attempts to retrieve user information from the session identity or Redis cache.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | &HttpRequest | The incoming HTTP request |
| pl | &mut Payload | The request payload |
| tx | Transaction | Sentry transaction for performance monitoring |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Option&lt;LoggedUser&gt; | Option&lt;LoggedUser&gt; | The authenticated user, if found |

### auth_with_api_key
#### Description
Authenticates a user using an API key provided in the request headers.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | &HttpRequest | The incoming HTTP request |
| tx | Transaction | Sentry transaction for performance monitoring |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(Option&lt;LoggedUser&gt;, Option&lt;UserApiKey&gt;), ServiceError&gt; | Result | The authenticated user and API key, or an error |

### get_api_key_from_headers, get_dataset_id_from_headers, get_org_id_from_headers
#### Description
Helper functions to extract API keys, dataset IDs, and organization IDs from request headers.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| headers | &HeaderMap | The request headers |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Option&lt;String&gt; | Option&lt;String&gt; | The extracted value, if found |

### verify_owner, verify_admin, verify_member
#### Description
Functions to verify user roles within an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | &OwnerOnly/&AdminOnly/&LoggedUser | The user to verify |
| org_id | &uuid::Uuid | The organization ID |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| bool | bool | Whether the user has the required role |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| actix_web | Web framework for request handling |
| actix_identity | Session management |
| sentry | Error tracking and performance monitoring |
| redis | Caching user information |
| futures_util | Asynchronous programming utilities |

## Error Handling
The code uses a `ServiceError` enum for error handling, which is converted into `actix_web::Error` when needed. Common errors include `Unauthorized`, `Forbidden`, and `BadRequest`.

## Logging
The code uses Sentry for performance monitoring and error tracking, creating transactions and spans for different operations.

## Future Improvements
1. Implement caching for API key validation to reduce database queries.
2. Add more granular scopes for API key permissions.
3. Refactor the `call` method of `AuthenticationMiddleware` to improve readability and maintainability.
4. Implement rate limiting for API key usage.
5. Add more comprehensive error logging and handling for edge cases.