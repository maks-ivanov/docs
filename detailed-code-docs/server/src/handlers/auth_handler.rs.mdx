---
title: "auth_handler.rs"
---

## High-level description
This code defines the authentication handler for the Trieve API. It handles user login, logout, and callback from the OpenID Connect provider. It also defines extractor types for authenticated users and users with specific roles.

## Table of contents
- `build_oidc_client`
- `create_account`
- `logout`
- `login`
- `callback`
- `get_me`
- `health_check`
- `login_cli`

## References
- `crate::data::models::{Organization, RedisPool, StripePlan, UserRole}`
- `crate::operators::invitation_operator::check_inv_valid`
- `crate::operators::organization_operator::{get_org_from_id_query, get_user_org_count}`
- `crate::operators::user_operator::{add_user_to_organization, create_user_query, get_user_by_id_query}`

## Symbols

### `build_oidc_client`
#### Description
This function builds an OpenID Connect client using configuration values from environment variables.

#### Inputs
None

#### Outputs
- `CoreClient`: An OpenID Connect client.

#### Internal Logic
- Reads environment variables for OpenID Connect provider configuration.
- Discovers the OpenID Connect provider metadata.
- Creates a `CoreClient` instance with the discovered metadata and configuration values.

### `create_account`
#### Description
This function creates a new user account in the database. If an organization ID is provided, the user is added to that organization with the specified role. If no organization ID is provided, a new organization is created for the user and they are assigned the owner role.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| email | String | The user's email address. |
| name | String | The user's name. |
| user_id | uuid::Uuid | The user's ID. |
| organization_id | Option&lt;uuid::Uuid&gt; | The ID of the organization to add the user to. |
| inv_code | Option&lt;uuid::Uuid&gt; | The invitation code, if any. |
| pool | web::Data&lt;Pool&gt; | The database connection pool. |

#### Outputs
- `Result&lt;(User, Vec&lt;UserOrganization&gt;, Vec&lt;Organization&gt;), ServiceError&gt;`: A result containing the created user, their organization memberships, and the organizations they belong to.

#### Internal Logic
- Determines the user's role and organization based on the provided organization ID and invitation code.
- Creates a new user in the database using `create_user_query`.
- Returns the created user, their organization memberships, and the organizations they belong to.

### `logout`
#### Description
This function handles user logout by invalidating the current authentication token stored in the cookie.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | Identity | The user's identity. |
| data | web::Query&lt;LogoutRequest&gt; | The logout request data. |
| req | HttpRequest | The HTTP request. |

#### Outputs
- `HttpResponse`: An HTTP response indicating the logout status.

#### Internal Logic
- Logs the user out using `id.logout()`.
- Constructs a logout URL for the OpenID Connect provider.
- Returns an HTTP response with the logout URL.

### `login`
#### Description
This function handles user login by redirecting the user to the OpenID Connect provider for authentication.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | HttpRequest | The HTTP request. |
| session | Session | The user's session. |
| data | web::Query&lt;AuthQuery&gt; | The authentication query data. |
| oidc_client | web::Data&lt;CoreClient&gt; | The OpenID Connect client. |

#### Outputs
- `Result&lt;HttpResponse, Error&gt;`: A result containing an HTTP response indicating the login status.

#### Internal Logic
- Generates a PKCE code challenge and verifier.
- Constructs an authorization URL for the OpenID Connect provider.
- Stores the OpenID Connect state in the session.
- Stores the login state (redirect URI, organization ID, invitation code) in the session.
- Returns an HTTP response redirecting the user to the authorization URL.

### `callback`
#### Description
This function handles the callback from the OpenID Connect provider after user authentication.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | HttpRequest | The HTTP request. |
| session | Session | The user's session. |
| oidc_client | web::Data&lt;CoreClient&gt; | The OpenID Connect client. |
| redis_pool | web::Data&lt;RedisPool&gt; | The Redis connection pool. |
| pool | web::Data&lt;Pool&gt; | The database connection pool. |
| query | web::Query&lt;OpCallback&gt; | The callback query data. |

#### Outputs
- `Result&lt;HttpResponse, Error&gt;`: A result containing an HTTP response indicating the callback status.

#### Internal Logic
- Retrieves the OpenID Connect state from the session.
- Exchanges the authorization code for an access token.
- Verifies the ID token and extracts user claims.
- Creates a new user account if the user does not exist in the database.
- Adds the user to the specified organization, if any.
- Stores the user information in Redis.
- Logs the user in using `Identity::login`.
- Removes the OpenID Connect state and login state from the session.
- Returns an HTTP response redirecting the user to the redirect URI.

### `get_me`
#### Description
This function retrieves the currently authenticated user's information.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| logged_user | LoggedUser | The logged-in user. |
| pool | web::Data&lt;Pool&gt; | The database connection pool. |

#### Outputs
- `Result&lt;HttpResponse, actix_web::Error&gt;`: A result containing an HTTP response with the user's information.

#### Internal Logic
- Retrieves the user's ID from the `logged_user` extractor.
- Fetches the user's information from the database using `get_user_by_id_query`.
- Returns an HTTP response with the user's information.

### `health_check`
#### Description
This function performs a health check of the service.

#### Inputs
None

#### Outputs
- `Result&lt;HttpResponse, actix_web::Error&gt;`: A result containing an HTTP response indicating the health status.

#### Internal Logic
- Returns an HTTP 200 OK response.

### `login_cli`
#### Description
This function serves a local login page for the CLI.

#### Inputs
None

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: A result containing an HTTP response with the login page.

#### Internal Logic
- Reads the login page HTML from a file.
- Returns an HTTP response with the login page HTML.

## Dependencies
- `actix-identity`
- `actix-session`
- `actix-web`
- `oauth2`
- `openidconnect`
- `redis`
- `serde`
- `serde_json`
- `tracing`
- `utoipa`

## Configuration
The following environment variables are used for configuration:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| OIDC_ISSUER_URL | String |  | The issuer URL for the OpenID Connect provider. |
| OIDC_CLIENT_ID | String |  | The client ID for the OpenID Connect provider. |
| OIDC_AUTH_REDIRECT_URL | String |  | The authorization redirect URL for the OpenID Connect provider. |
| OIDC_CLIENT_SECRET | String |  | The client secret for the OpenID Connect provider. |
| BASE_SERVER_URL | String |  | The base URL of the Trieve server. |

## Error Handling
The code uses the `ServiceError` enum to represent errors. Errors are returned as HTTP responses with appropriate status codes.

## Logging
The code uses the `tracing` crate for logging.

## API/Interface Reference
The code defines the following API endpoints:
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /auth | GET | `AuthQuery` | 303 SeeOther | Redirects the user to the OpenID Connect provider for authentication. |
| /auth/callback | GET | `OpCallback` | 200 OK | Handles the callback from the OpenID Connect provider after user authentication. |
| /auth | DELETE | `LogoutRequest` | 204 No Content | Logs the user out. |
| /auth/me | GET |  | 200 OK | Retrieves the currently authenticated user's information. |
| /health | GET |  | 200 OK | Performs a health check of the service. |

## Future Improvements
- Implement support for multiple OAuth providers.
- Add more granular role-based access control.
- Improve error handling and logging.
- Add unit tests for the authentication handler.
