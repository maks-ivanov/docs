---
title: "invitation_handler.rs"
---

## High-level description
This code implements the invitation functionality for the Trieve application. It allows admins to invite new users to their organization, sends out invitation emails, and handles the registration process for invited users.

## Table of contents
- `email_regex` function
- `InvitationResponse` struct
- `InvitationData` struct
- `post_invitation` function
- `InvitationWithUrl` struct
- `create_invitation` function
- `get_invitations` function
- `delete_invitation` function

## References
- `crate::data::models::{Invitation, Pool, RedisPool}`
- `crate::errors::ServiceError`
- `crate::middleware::auth_middleware::verify_admin`
- `crate::operators::invitation_operator::{create_invitation_query, delete_invitation_by_id_query, get_invitation_by_id_query, get_invitations_for_organization_query, send_invitation, send_invitation_for_existing_user}`
- `crate::operators::organization_operator::get_org_from_id_query`
- `crate::operators::user_operator::add_existing_user_to_org`

## Symbols

### `email_regex`
#### Description
Defines a regular expression used to validate email addresses.

#### Inputs
None

#### Outputs
- `regex::Regex`: A compiled regular expression object.

### `InvitationResponse`
#### Description
Represents the response structure for successful invitation requests.

#### Inputs
None

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `registration_url` | `String` | The URL where the invited user can register. |

### `InvitationData`
#### Description
Represents the data structure for sending invitations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `organization_id` | `uuid::Uuid` | The ID of the organization to invite the user to. |
| `user_role` | `i32` | The role the user will have in the organization (0 = User, 1 = Admin, 2 = Owner). |
| `email` | `String` | The email address of the user to invite. |
| `app_url` | `String` | The base URL of the Trieve application. |
| `redirect_uri` | `String` | The URL to redirect the user to after registration. |

#### Outputs
None

### `post_invitation`
#### Description
Handles POST requests to send invitations. It validates the request data, checks user permissions, creates an invitation record in the database, and sends the invitation email.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `invitation_data` | `web::Json&lt;InvitationData&gt;` | The invitation data sent in the request body. |
| `pool` | `web::Data&lt;Pool&gt;` | A connection pool for the database. |
| `redis_pool` | `web::Data&lt;RedisPool&gt;` | A connection pool for the Redis cache. |
| `user` | `AdminOnly` | The authenticated user making the request. |

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: Returns a `204 No Content` response on success, or a `ServiceError` on failure.

#### Internal Logic
1. Validates the email address using the `email_regex`.
2. Checks if the user is trying to invite themselves.
3. Verifies if the user has sufficient permissions to invite a user with the specified role.
4. Checks if the user already exists in the organization. If so, it sends an invitation for an existing user.
5. Creates a new invitation record in the database using the `create_invitation` function.
6. Sends the invitation email using the `send_invitation` function.

### `InvitationWithUrl`
#### Description
A helper struct that combines an `Invitation` object with its corresponding registration URL.

#### Inputs
None

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `invitation` | `Invitation` | The invitation object. |
| `registration_url` | `String` | The registration URL for the invitation. |

### `create_invitation`
#### Description
Creates a new invitation record in the database and generates its registration URL.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `app_url` | `String` | The base URL of the Trieve application. |
| `email` | `String` | The email address of the invited user. |
| `organization_id` | `uuid::Uuid` | The ID of the organization the invitation belongs to. |
| `redirect_uri` | `String` | The URL to redirect the user to after registration. |
| `user_role` | `i32` | The role the invited user will have in the organization. |
| `pool` | `web::Data&lt;Pool&gt;` | A connection pool for the database. |

#### Outputs
- `Result&lt;InvitationWithUrl, ServiceError&gt;`: Returns an `InvitationWithUrl` object on success, or a `ServiceError` on failure.

#### Internal Logic
1. Creates a new invitation record in the database using the `create_invitation_query` function.
2. Generates the registration URL based on the invitation ID, organization ID, and redirect URI.

### `get_invitations`
#### Description
Handles GET requests to retrieve invitations for an organization. It verifies user permissions and returns a list of invitations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `user` | `AdminOnly` | The authenticated user making the request. |
| `org_id` | `web::Path&lt;uuid::Uuid&gt;` | The ID of the organization to retrieve invitations for. |
| `pool` | `web::Data&lt;Pool&gt;` | A connection pool for the database. |

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: Returns a `200 OK` response with a list of invitations on success, or a `ServiceError` on failure.

#### Internal Logic
1. Verifies if the user has admin or owner permissions for the specified organization.
2. Retrieves the invitations from the database using the `get_invitations_for_organization_query` function.

### `delete_invitation`
#### Description
Handles DELETE requests to delete an invitation by ID. It verifies user permissions and deletes the invitation from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `user` | `AdminOnly` | The authenticated user making the request. |
| `invitation_id` | `web::Path&lt;uuid::Uuid&gt;` | The ID of the invitation to delete. |
| `pool` | `web::Data&lt;Pool&gt;` | A connection pool for the database. |

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: Returns a `204 No Content` response on success, or a `ServiceError` on failure.

#### Internal Logic
1. Retrieves the invitation from the database using the `get_invitation_by_id_query` function.
2. Verifies if the user has admin or owner permissions for the organization the invitation belongs to.
3. Deletes the invitation from the database using the `delete_invitation_by_id_query` function.


## Future Improvements
- The `create_invitation` function has a TODO comment about figuring out how to get the redirect URI. This should be addressed to ensure the redirect functionality works as intended.
- Consider adding error handling for the email sending process. Currently, if the `send_invitation` function fails, the API will return a 204 No Content response, even though the email was not sent.
- The validation logic for checking user permissions in `post_invitation` could be extracted into a separate function for better readability and reusability.
- The code currently uses i32 for user roles. Consider using an enum or a more descriptive type for better code clarity.
- Add unit tests to cover the functionality of each function and handle different edge cases.
