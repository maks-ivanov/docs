---
title: "analytics_handler.rs"
---

## High-level description
This code defines a set of API endpoints for retrieving and managing analytics data related to search, RAG, recommendations, and CTR within a dataset. It leverages ClickHouse as the primary data store for analytics and interacts with a PostgreSQL database for metadata retrieval.

## Table of contents
- `get_cluster_analytics`
- `set_query_rating`
- `get_search_analytics`
- `get_rag_analytics`
- `get_recommendation_analytics`
- `send_ctr_data`
- `get_ctr_analytics`

## References
- `AdminOnly` from `super::auth_handler`
- Various data models from `crate::data::models`
- Analytics operators from `crate::operators::analytics_operator`

## Symbols
### `get_cluster_analytics`
#### Description
Retrieves cluster analytics for a dataset, either cluster topics or queries associated with a specific cluster.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;ClusterAnalytics&gt;` | JSON payload specifying the type of cluster analytics requested and optional filters. |
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for querying analytics data. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response containing the cluster analytics data or a service error. |

#### Internal Logic
- Destructures the `data` payload to determine the requested cluster analytics type.
- Executes a ClickHouse query based on the requested type and provided filters.
- Constructs a `ClusterAnalyticsResponse` based on the query results.
- Returns an HTTP response with the analytics data.

### `set_query_rating`
#### Description
Allows an admin user to rate a specific search query and optionally provide a note.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;RateQueryRequest&gt;` | JSON payload containing the query ID, rating, and optional note. |
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for updating the query rating. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response indicating success (204 No Content) or a service error. |

#### Internal Logic
- Extracts the query ID, rating, and note from the `data` payload.
- Executes a ClickHouse query to update the `query_rating` field for the specified query ID and dataset.
- Returns an HTTP response with a 204 No Content status.

### `get_search_analytics`
#### Description
Retrieves various search analytics for a dataset, including latency graphs, search usage graphs, search metrics, and lists of queries.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;SearchAnalytics&gt;` | JSON payload specifying the type of search analytics requested and optional filters. |
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for querying analytics data. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response containing the search analytics data or a service error. |

#### Internal Logic
- Destructures the `data` payload to determine the requested search analytics type.
- Executes a ClickHouse query based on the requested type and provided filters.
- Constructs a `SearchAnalyticsResponse` based on the query results.
- Returns an HTTP response with the analytics data.

### `get_rag_analytics`
#### Description
Retrieves RAG analytics for a dataset, including RAG usage statistics, queries, and usage graphs.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;RAGAnalytics&gt;` | JSON payload specifying the type of RAG analytics requested and optional filters. |
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for querying analytics data. |
| pool | `web::Data&lt;Pool&gt;` | PostgreSQL database connection pool for retrieving chunk metadata. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response containing the RAG analytics data or a service error. |

#### Internal Logic
- Destructures the `data` payload to determine the requested RAG analytics type.
- Executes a ClickHouse query based on the requested type and provided filters.
- For `RAGQueries`, retrieves chunk metadata from PostgreSQL based on chunk IDs from the ClickHouse results.
- Constructs a `RAGAnalyticsResponse` based on the query results and retrieved metadata.
- Returns an HTTP response with the analytics data.

### `get_recommendation_analytics`
#### Description
Retrieves recommendation analytics for a dataset, including low-confidence recommendations and a list of recommendation queries.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;RecommendationAnalytics&gt;` | JSON payload specifying the type of recommendation analytics requested and optional filters. |
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for querying analytics data. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response containing the recommendation analytics data or a service error. |

#### Internal Logic
- Destructures the `data` payload to determine the requested recommendation analytics type.
- Executes a ClickHouse query based on the requested type and provided filters.
- Constructs a `RecommendationAnalyticsResponse` based on the query results.
- Returns an HTTP response with the analytics data.

### `send_ctr_data`
#### Description
Receives and stores CTR data for a dataset, associating clicks with specific requests (search or recommendation).

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| data | `web::Json&lt;CTRDataRequestBody&gt;` | JSON payload containing the CTR data, including request ID, CTR type, clicked chunk ID, position, and optional metadata. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for storing CTR data. |
| pool | `web::Data&lt;Pool&gt;` | PostgreSQL database connection pool for retrieving chunk metadata if `clicked_chunk_id` is not provided. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response indicating success (204 No Content) or a service error. |

#### Internal Logic
- Retrieves the clicked chunk ID, either directly from the payload or by looking up the chunk metadata using the provided `clicked_chunk_tracking_id`.
- Executes a ClickHouse query to insert the CTR data into the `ctr_data` table.
- Returns an HTTP response with a 204 No Content status.

### `get_ctr_analytics`
#### Description
Retrieves CTR analytics for a dataset, including search and recommendation CTR metrics, and lists of searches or recommendations with and without clicks.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| _user | `AdminOnly` | Authentication guard ensuring only admin users can access this endpoint. |
| data | `web::Json&lt;CTRAnalytics&gt;` | JSON payload specifying the type of CTR analytics requested and optional filters. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | ClickHouse client instance for querying analytics data. |
| pool | `web::Data&lt;Pool&gt;` | PostgreSQL database connection pool for retrieving chunk metadata for searches or recommendations with clicks. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, subscription plan, and user information associated with the request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response containing the CTR analytics data or a service error. |

#### Internal Logic
- Destructures the `data` payload to determine the requested CTR analytics type.
- Executes a ClickHouse query based on the requested type and provided filters.
- For analytics types involving clicks, retrieves chunk metadata from PostgreSQL based on chunk IDs from the ClickHouse results.
- Constructs a `CTRAnalyticsResponse` based on the query results and retrieved metadata.
- Returns an HTTP response with the analytics data.

## Dependencies
- `actix-web` for web framework functionality.
- `clickhouse` for interacting with the ClickHouse database.
- `diesel` for interacting with the PostgreSQL database.
- `futures` for asynchronous programming.
- `itertools` for iterator utilities.
- `serde` for serialization and deserialization.
- `ureq` for making HTTP requests.
- `utoipa` for API documentation generation.

## Error Handling
The code uses a custom `ServiceError` enum to represent various error conditions, which are then mapped to appropriate HTTP responses using the `ResponseError` trait.

## Logging
The code uses `log::error!` to log errors encountered during database queries and other operations.

## API/Interface Reference
The code defines a set of API endpoints for managing and retrieving analytics data, documented using `utoipa` annotations. Each endpoint is secured using the `AdminOnly` authentication guard, ensuring only authorized users can access the analytics data.
