---
title: "event_handler.rs"
---

## High-level description
This code defines a handler function `get_events` that retrieves events for a specific dataset from a Clickhouse database. It uses a JSON payload to specify pagination and filter events by type.

## Table of contents
- `GetEventsData` struct
- `get_events` function
- `EventId` struct

## References
- `LoggedUser` from `auth_handler` module
- `DatasetAndOrgWithSubAndPlan`, `EventType`, `EventTypeRequest` from `data::models` module
- `get_events_query` from `operators::event_operator` module

## Symbols

### `GetEventsData`
#### Description
This struct defines the JSON payload for the `get_events` function. It allows specifying pagination parameters and filtering events by type.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| page | `Option&lt;i64&gt;` | The page number to retrieve. Defaults to 1. |
| page_size | `Option&lt;i64&gt;` | The number of events per page. Defaults to 10. |
| event_types | `Option&lt;Vec&lt;EventTypeRequest&gt;&gt;` | A list of event types to filter by. If empty or undefined, retrieves all event types. |

#### Outputs
None

### `get_events`
#### Description
This function retrieves events for a specific dataset from a Clickhouse database. It uses the `GetEventsData` payload to specify pagination and filter events by type.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| _user | `LoggedUser` | The logged-in user. Not used in this function. |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Contains information about the dataset, organization, subscription plan, and user. |
| get_events_data | `web::Json&lt;GetEventsData&gt;` | The JSON payload containing pagination and filtering parameters. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | A shared Clickhouse client instance. |

#### Outputs
Returns a `Result&lt;HttpResponse, actix_web::Error&gt;`. On success, returns an HTTP response with a JSON body containing the retrieved events. On error, returns an HTTP error response.

#### Internal Logic
1. Extracts the requested event types from the `get_events_data` payload. If no types are specified, defaults to retrieving all event types.
2. Calls the `get_events_query` function to retrieve events from the Clickhouse database based on the provided dataset ID, pagination parameters, and event types.
3. Maps any errors from `get_events_query` to a `ServiceError::BadRequest`.
4. Returns an HTTP response with the retrieved events as a JSON body.

### `EventId`
#### Description
This struct defines a simple payload containing a notification ID. It is not used in the current code but might be intended for future use, possibly for deleting or acknowledging specific events.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| notification_id | `uuid::Uuid` | The ID of the notification. |

#### Outputs
None

## Dependencies
- `actix-web` for web framework functionality
- `serde` for serialization and deserialization
- `utoipa` for API documentation
- `clickhouse` for interacting with the Clickhouse database
- `tracing` for logging

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /events | POST | `GetEventsData` JSON payload | JSON array of `WorkerEvent` | Retrieves events for a specific dataset. |

## Future Improvements
- The `EventId` struct is currently unused and its purpose is unclear. It might be beneficial to either implement its functionality or remove it from the code.
- The `get_events` function does not currently utilize the `LoggedUser` information. It might be useful to incorporate user-specific filtering or permissions in the future.
- Consider adding more detailed error handling and logging to provide better insights into potential issues.
