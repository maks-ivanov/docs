---
title: "dataset_handler.rs"
---

## High-level description
This code file defines API endpoints for managing datasets within the Trieve application. It handles creating, updating, deleting, and retrieving datasets, as well as managing dataset usage and clearing dataset contents. 

## Table of contents
- `create_dataset`
- `update_dataset`
- `delete_dataset`
- `clear_dataset`
- `delete_dataset_by_tracking_id`
- `get_dataset`
- `get_usage_by_dataset_id`
- `get_dataset_by_tracking_id`
- `get_datasets_from_organization`

## References
This file references several other symbols within the codebase, including:
- `crate::data::models`: This module defines the data models used throughout the application, including `Dataset`, `Organization`, `StripePlan`, etc.
- `crate::errors::ServiceError`: This enum defines the various error types that can occur within the application.
- `crate::middleware::auth_middleware`: This module contains middleware functions for handling authentication and authorization, such as `verify_admin` and `verify_owner`.
- `crate::operators`: This module contains functions for interacting with various data stores, such as the database and the Redis cache.

## Symbols

### `create_dataset`
#### Description
This function handles the `/dataset` POST endpoint, creating a new dataset within a specified organization. It verifies the user's ownership of the organization and checks if the organization's plan allows for additional datasets.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Json&lt;CreateDatasetRequest&gt; | JSON payload containing the dataset name, organization ID, optional tracking ID, and server configuration. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| _user | OwnerOnly | Extracted user information from the request, ensuring the user is an owner of the organization. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `200 OK`: Dataset created successfully, returning the created `Dataset` object.
- `400 Bad Request`: Service error encountered while creating the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `422 Unprocessable Entity`: Organization's plan does not allow for additional datasets.

### `update_dataset`
#### Description
This function handles the `/dataset` PUT endpoint, updating an existing dataset. It allows updating the dataset name, server configuration, and tracking ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Json&lt;UpdateDatasetRequest&gt; | JSON payload containing the dataset ID or tracking ID, optional new name, server configuration, and new tracking ID. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| user | OwnerOnly | Extracted user information from the request, ensuring the user is an owner of the organization. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `200 OK`: Dataset updated successfully, returning the updated `Dataset` object.
- `400 Bad Request`: Service error encountered while updating the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `delete_dataset`
#### Description
This function handles the `/dataset/{dataset_id}` DELETE endpoint, deleting a dataset by its ID. It verifies the user's ownership of the dataset's organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Path&lt;uuid::Uuid&gt; | Dataset ID extracted from the request path. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| redis_pool | web::Data&lt;RedisPool&gt; | Redis connection pool. |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | Extracted dataset, organization, plan, and subscription information from the request. |
| user | OwnerOnly | Extracted user information from the request, ensuring the user is an owner of the organization. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `204 No Content`: Dataset deleted successfully.
- `400 Bad Request`: Service error encountered while deleting the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `clear_dataset`
#### Description
This function handles the `/dataset/clear/{dataset_id}` PUT endpoint, clearing a dataset by removing all chunks, files, and groups while retaining analytics and the dataset itself.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Path&lt;uuid::Uuid&gt; | Dataset ID extracted from the request path. |
| redis_pool | web::Data&lt;RedisPool&gt; | Redis connection pool. |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | Extracted dataset, organization, plan, and subscription information from the request. |
| user | OwnerOnly | Extracted user information from the request, ensuring the user is an owner of the organization. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `204 No Content`: Dataset cleared successfully.
- `400 Bad Request`: Service error encountered while clearing the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `delete_dataset_by_tracking_id`
#### Description
This function handles the `/dataset/tracking_id/{tracking_id}` DELETE endpoint, deleting a dataset by its tracking ID. It verifies the user's ownership of the dataset's organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tracking_id | web::Path&lt;String&gt; | Dataset tracking ID extracted from the request path. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | Extracted dataset, organization, plan, and subscription information from the request. |
| redis_pool | web::Data&lt;RedisPool&gt; | Redis connection pool. |
| user | OwnerOnly | Extracted user information from the request, ensuring the user is an owner of the organization. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `204 No Content`: Dataset deleted successfully.
- `400 Bad Request`: Service error encountered while deleting the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `get_dataset`
#### Description
This function handles the `/dataset/{dataset_id}` GET endpoint, retrieving a dataset by its ID. It verifies the user's admin or owner role for the dataset's organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| dataset_id | web::Path&lt;uuid::Uuid&gt; | Dataset ID extracted from the request path. |
| user | AdminOnly | Extracted user information from the request, ensuring the user has admin privileges. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `200 OK`: Dataset retrieved successfully, returning the `Dataset` object.
- `400 Bad Request`: Service error encountered while retrieving the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `get_usage_by_dataset_id`
#### Description
This function handles the `/dataset/usage/{dataset_id}` GET endpoint, retrieving the usage statistics for a dataset by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| dataset_id | web::Path&lt;uuid::Uuid&gt; | Dataset ID extracted from the request path. |
| user | AdminOnly | Extracted user information from the request, ensuring the user has admin privileges. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `200 OK`: Dataset usage retrieved successfully, returning a `DatasetUsageCount` object.
- `400 Bad Request`: Service error encountered while retrieving the dataset usage, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `get_dataset_by_tracking_id`
#### Description
This function handles the `/dataset/tracking_id/{tracking_id}` GET endpoint, retrieving a dataset by its tracking ID. It verifies the user's admin or owner role for the dataset's organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tracking_id | web::Path&lt;String&gt; | Dataset tracking ID extracted from the request path. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| user | AdminOnly | Extracted user information from the request, ensuring the user has admin privileges. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `200 OK`: Dataset retrieved successfully, returning the `Dataset` object.
- `400 Bad Request`: Service error encountered while retrieving the dataset, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Dataset not found.

### `get_datasets_from_organization`
#### Description
This function handles the `/dataset/organization/{organization_id}` GET endpoint, retrieving all datasets associated with a specific organization. It verifies the user's admin or owner role for the organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | web::Path&lt;uuid::Uuid&gt; | Organization ID extracted from the request path. |
| pagination | web::Query&lt;GetDatasetsPagination&gt; | Pagination parameters for limiting and offsetting the results. |
| user | AdminOnly | Extracted user information from the request, ensuring the user has admin privileges. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |

#### Outputs
Returns an `HttpResponse` indicating success or failure.
- `200 OK`: Datasets retrieved successfully, returning a vector of `DatasetAndUsage` objects.
- `400 Bad Request`: Service error encountered while retrieving the datasets, returning an `ErrorResponseBody`.
- `401 Unauthorized`: User is not authenticated or lacks sufficient permissions.
- `404 Not Found`: Organization not found.

## Error Handling
This code utilizes the `ServiceError` enum to represent various error conditions. These errors are returned as `HttpResponse` objects with appropriate status codes and error messages.

## Future Improvements
- Implement more robust error handling for database and Redis operations, providing more informative error messages to the user.
- Consider adding pagination support to the `get_datasets_from_organization` endpoint to handle large numbers of datasets efficiently.
- Add logging to track dataset creation, updates, and deletions for auditing and debugging purposes.
