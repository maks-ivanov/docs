---
title: "user_handler.rs"
---

## High-level description
The `user_handler.rs` file provides a set of API endpoints for managing user-related operations within the application. This includes updating user roles within organizations, managing user API keys, and retrieving user information.

## Table of contents
- `update_user`
- `set_user_api_key`
- `get_user_api_keys`
- `delete_user_api_key`

## References
- `auth_handler::LoggedUser`
- `data::models::Pool`
- `data::models::RedisPool`
- `data::models::UserRole`
- `errors::ServiceError`
- `operators::user_operator::delete_user_api_keys_query`
- `operators::user_operator::get_user_api_keys_query`
- `operators::user_operator::get_user_by_id_query`
- `operators::user_operator::set_user_api_key_query`
- `operators::user_operator::update_user_org_role_query`

## Symbols
### `update_user`
#### Description
This function handles the `/user` PUT endpoint, allowing users to update their role within an organization. The authenticated user can update their own role or the role of another user within an organization they belong to, provided they have sufficient permissions.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Json&lt;UpdateUserOrgRoleData&gt; | JSON payload containing the organization ID, optional user ID, and the new role. |
| user | LoggedUser | The authenticated user making the request. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |
| redis_pool | web::Data&lt;RedisPool&gt; | Redis connection pool. |

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: Returns a 204 No Content response on success, or a ServiceError with an appropriate HTTP status code on failure.

#### Internal Logic
1. Extracts the organization ID, user ID (if provided), and the new role from the request payload.
2. Retrieves the authenticated user's role within the specified organization.
3. Checks if the authenticated user has sufficient permissions to update the role:
    - If updating their own role, no further checks are required.
    - If updating another user's role, the authenticated user must be an admin or owner of the organization.
4. If a user ID is provided, verifies that the user belongs to the specified organization.
5. Updates the user's role in the database using the `update_user_org_role_query` function.
6. Clears the user's cache entry in Redis to ensure the updated role is reflected in subsequent requests.
7. Returns a 204 No Content response on success.

### `set_user_api_key`
#### Description
This function handles the `/user/api_key` POST endpoint, allowing users to create a new API key for themselves.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | LoggedUser | The authenticated user making the request. |
| data | web::Json&lt;SetUserApiKeyRequest&gt; | JSON payload containing the API key name, role, optional dataset IDs, optional organization IDs, and optional scopes. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |

#### Outputs
- `Result&lt;HttpResponse, actix_web::Error&gt;`: Returns a 200 OK response with the newly created API key on success, or a ServiceError with an appropriate HTTP status code on failure.

#### Internal Logic
1. Extracts the API key name, role, dataset IDs, organization IDs, and scopes from the request payload.
2. Generates a new random API key string.
3. Hashes the API key using the `hash_api_key` function.
4. Creates a new `UserApiKey` struct with the provided details.
5. Inserts the new API key into the database using the `set_user_api_key_query` function.
6. Returns a 200 OK response with the newly created API key.

### `get_user_api_keys`
#### Description
This function handles the `/user/api_key` POST endpoint, allowing users to retrieve a list of their API keys.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | LoggedUser | The authenticated user making the request. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |

#### Outputs
- `Result&lt;HttpResponse, actix_web::Error&gt;`: Returns a 200 OK response with a list of the user's API keys on success, or a ServiceError with an appropriate HTTP status code on failure.

#### Internal Logic
1. Retrieves the authenticated user's ID.
2. Queries the database for all API keys associated with the user's ID using the `get_user_api_keys_query` function.
3. Maps the retrieved API keys to `ApiKeyRespBody` structs.
4. Returns a 200 OK response with the list of API keys.

### `delete_user_api_key`
#### Description
This function handles the `/user/api_key/{api_key_id}` DELETE endpoint, allowing users to delete one of their API keys.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | LoggedUser | The authenticated user making the request. |
| data | web::Path&lt;uuid::Uuid&gt; | The ID of the API key to delete, extracted from the request path. |
| pool | web::Data&lt;Pool&gt; | Database connection pool. |

#### Outputs
- `Result&lt;HttpResponse, actix_web::Error&gt;`: Returns a 204 No Content response on success, or a ServiceError with an appropriate HTTP status code on failure.

#### Internal Logic
1. Retrieves the authenticated user's ID and the API key ID from the request path.
2. Deletes the specified API key from the database using the `delete_user_api_keys_query` function.
3. Returns a 204 No Content response on success.
