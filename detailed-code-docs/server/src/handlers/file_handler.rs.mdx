---
title: "file_handler.rs"
---

## High-level description
This code defines handlers for file-related operations in a document management system. It includes functions for uploading files, retrieving files, getting files associated with a dataset, and deleting files.

## Table of contents
- `validate_file_name`
- `UploadFileReqPayload`
- `UploadFileResult`
- `upload_file_handler`
- `get_file_handler`
- `DatasetFileQuery`
- `FileData`
- `get_dataset_files_handler`
- `delete_file_handler`
- `GetImageResponse`
- `get_signed_url`

## References
- `AdminOnly` and `LoggedUser` from `super::auth_handler`
- Several models from `crate::data::models`
- `verify_member` from `crate::middleware::auth_middleware`
- `delete_file_query`, `get_aws_bucket`, `get_dataset_file_query`, and `get_file_query` from `crate::operators::file_operator`
- `get_file_size_sum_org` from `crate::operators::organization_operator`

## Symbols

### `validate_file_name`
#### Description
This function validates a file name by checking if it contains ".." and returning an error if it does. Otherwise, it returns the last part of the file name after splitting by "/".

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| s | String | The file name to validate |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;String, actix_web::Error&gt; |  | The validated file name or an error |

#### Internal Logic
1. Splits the file name by "/" and takes the last part.
2. Checks if the last part contains "..".
3. If it does, returns a BadRequest error.
4. Otherwise, returns the last part of the file name.

### `UploadFileReqPayload`
#### Description
This struct defines the payload for the upload file request. It includes the base64 encoded file, file name, optional tags, description, link, timestamp, metadata, and flags for creating chunks and rebalancing chunks.

#### Inputs
N/A - This is a data structure, not a function.

#### Outputs
N/A - This is a data structure, not a function.

### `UploadFileResult`
#### Description
This struct defines the result of the upload file request. It includes the metadata of the uploaded file.

#### Inputs
N/A - This is a data structure, not a function.

#### Outputs
N/A - This is a data structure, not a function.

### `upload_file_handler`
#### Description
This function handles the upload file request. It decodes the base64 encoded file, uploads it to S3, and sends a message to the file worker queue to process the file.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Json&lt;UploadFileReqPayload&gt; | The payload of the upload file request |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| user | AdminOnly | The authenticated user |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | The dataset, organization, plan, and subscription information |
| redis_pool | web::Data&lt;RedisPool&gt; | The Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HttpResponse, actix_web::Error&gt; |  | An HTTP response indicating success or failure |

#### Internal Logic
1. Checks if the user has reached the file size limit for their organization.
2. Decodes the base64 encoded file.
3. Uploads the file to S3.
4. Creates a FileWorkerMessage and sends it to the file worker queue.
5. Returns an HTTP response with the file metadata.

### `get_file_handler`
#### Description
This function handles the get file request. It retrieves the file from the database and returns a signed S3 URL for downloading the file.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| file_id | web::Path&lt;uuid::Uuid&gt; | The ID of the file to retrieve |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| _user | LoggedUser | The authenticated user |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | The dataset, organization, plan, and subscription information |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HttpResponse, actix_web::Error&gt; |  | An HTTP response containing the signed S3 URL |

#### Internal Logic
1. Retrieves the file from the database using the file ID and dataset ID.
2. Generates a signed S3 URL for the file.
3. Returns an HTTP response with the signed S3 URL.

### `DatasetFileQuery`
#### Description
This struct defines the query parameters for the get dataset files request. It includes the dataset ID and the page number.

#### Inputs
N/A - This is a data structure, not a function.

#### Outputs
N/A - This is a data structure, not a function.

### `FileData`
#### Description
This struct defines the response data for the get dataset files request. It includes a list of files and group IDs, and the total number of pages.

#### Inputs
N/A - This is a data structure, not a function.

#### Outputs
N/A - This is a data structure, not a function.

### `get_dataset_files_handler`
#### Description
This function handles the get dataset files request. It retrieves the files associated with a given dataset and returns them in a paginated format.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Path&lt;DatasetFileQuery&gt; | The query parameters for the request |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | The dataset, organization, plan, and subscription information |
| required_user | LoggedUser | The authenticated user |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HttpResponse, actix_web::Error&gt; |  | An HTTP response containing the paginated list of files |

#### Internal Logic
1. Verifies that the dataset ID in the request matches the dataset ID in the header.
2. Verifies that the user is a member of the organization that owns the dataset.
3. Retrieves the files associated with the dataset and the specified page number.
4. Returns an HTTP response with the list of files and the total number of pages.

### `delete_file_handler`
#### Description
This function handles the delete file request. It deletes the file from S3 and the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| file_id | web::Path&lt;uuid::Uuid&gt; | The ID of the file to delete |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| _user | AdminOnly | The authenticated user |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | The dataset, organization, plan, and subscription information |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HttpResponse, actix_web::Error&gt; |  | An HTTP response indicating success or failure |

#### Internal Logic
1. Retrieves the dataset configuration.
2. Deletes the file from the database and S3.
3. Returns an HTTP response indicating success.

### `GetImageResponse`
#### Description
This struct defines the response data for the get signed URL request. It includes the signed URL for the image.

#### Inputs
N/A - This is a data structure, not a function.

#### Outputs
N/A - This is a data structure, not a function.

### `get_signed_url`
#### Description
This function handles the get signed URL request. It generates a signed URL for an image stored in S3.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| file_name | web::Path&lt;String&gt; | The name of the image file |
| _user | LoggedUser | The authenticated user |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | The dataset, organization, plan, and subscription information |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HttpResponse, ServiceError&gt; |  | An HTTP response containing the signed URL |

#### Internal Logic
1. Retrieves the S3 bucket.
2. Determines the S3 path based on the UNLIMITED environment variable.
3. Generates a signed URL for the image.
4. Returns an HTTP response with the signed URL.
