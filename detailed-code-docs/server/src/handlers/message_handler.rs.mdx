---
title: "message_handler.rs"
---

## High-level description
This code defines handlers for managing messages in a chat-based system, including creating, retrieving, editing, and regenerating messages. It also includes functionality for generating suggested queries based on a given query and dataset.

## Table of contents
- `check_completion_param_validity` function
- `CreateMessageReqPayload` struct
- `create_message` function
- `get_all_topic_messages` function
- `RegenerateMessageReqPayload` struct
- `EditMessageReqPayload` struct
- `edit_message` function
- `regenerate_message_patch` function
- `regenerate_message` function
- `SuggestedQueriesReqPayload` struct
- `SuggestedQueriesResponse` struct
- `get_suggested_queries` function

## References
- `models` module for data models like `Message`, `Dataset`, `DatasetConfiguration`
- `auth_handler` module for authentication checks like `AdminOnly`, `LoggedUser`
- `chunk_handler` module for chunk-related functionality like `ChunkFilter`, `ParsedQuery`, `SearchChunksReqPayload`
- `clickhouse_operator` module for ClickHouse event queue (`EventQueue`)
- `message_operator` module for message-related database operations
- `organization_operator` module for organization-related database operations
- `parse_operator` module for text parsing utilities
- `search_operator` module for search-related functionality

## Dependencies
- `actix_web` for web framework
- `openai_dive` for OpenAI API interaction
- `serde` for serialization and deserialization
- `simple_server_timing_header` for server timing metrics
- `utoipa` for API documentation
- `simsearch` for similarity search
- `itertools` for iterator utilities

## Symbols

### `check_completion_param_validity`
#### Description
This function checks the validity of LLM options provided in a request, ensuring that parameters like temperature, frequency penalty, presence penalty, and stop tokens fall within acceptable ranges.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| llm_options | `Option&lt;LLMOptions&gt;` | LLM options to validate |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | `Result&lt;(), ServiceError&gt;` | Ok if valid, ServiceError if invalid |

#### Internal Logic
- Checks if `llm_options` is Some.
- If so, validates each parameter:
    - `temperature`: Must be between 0.0 and 2.0.
    - `frequency_penalty`: Must be between -2.0 and 2.0.
    - `presence_penalty`: Must be between -2.0 and 2.0.
    - `stop_tokens`: Must have a length less than or equal to 4.

### `CreateMessageReqPayload`
#### Description
This struct defines the payload for a request to create a new message in a chat topic.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| new_message_content | `String` | The content of the user message |
| topic_id | `uuid::Uuid` | The ID of the topic to attach the message to |
| highlight_options | `Option&lt;HighlightOptions&gt;` | Options for highlighting chunks in the response |
| search_type | `Option&lt;SearchMethod&gt;` | The type of search to perform (semantic, fulltext, hybrid) |
| concat_user_messages_query | `Option&lt;bool&gt;` | Whether to concatenate all user messages for the search query |
| search_query | `Option&lt;String&gt;` | The search query to use |
| page_size | `Option&lt;u64&gt;` | The number of chunks to fetch during RAG |
| filters | `Option&lt;ChunkFilter&gt;` | Filters to apply to the chunk search |
| score_threshold | `Option&lt;f32&gt;` | Minimum score threshold for chunks |
| llm_options | `Option&lt;LLMOptions&gt;` | LLM options to use for the completion |

### `create_message`
#### Description
This function handles requests to create a new message in a chat topic. It performs authentication checks, retrieves previous messages, generates an assistant response using the LLM, and streams the response back to the client.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;CreateMessageReqPayload&gt;` | The request payload |
| user | `AdminOnly` | Authenticated user with admin or owner role |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information |
| event_queue | `web::Data&lt;EventQueue&gt;` | ClickHouse event queue |
| pool | `web::Data&lt;Pool&gt;` | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response |

#### Internal Logic
- Checks if the organization has exceeded its message limit.
- Creates a new `Message` object from the request payload.
- Retrieves previous messages from the topic.
- Removes chunk citations from previous assistant messages.
- Creates a new message in the database, including the assistant response generated by the LLM.
- Streams the response back to the client using `stream_response`.

### `get_all_topic_messages`
#### Description
This function retrieves all messages for a given topic, including chunk citations for RAG topics.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | `LoggedUser` | Authenticated user |
| messages_topic_id | `web::Path&lt;uuid::Uuid&gt;` | The ID of the topic |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information |
| pool | `web::Data&lt;Pool&gt;` | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response containing the messages |

#### Internal Logic
- Retrieves messages from the database using `get_messages_for_topic_query`.
- Returns the messages as a JSON response.

### `RegenerateMessageReqPayload`
#### Description
This struct defines the payload for a request to regenerate the last assistant message in a chat topic.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| topic_id | `uuid::Uuid` | The ID of the topic |
| highlight_options | `Option&lt;HighlightOptions&gt;` | Options for highlighting chunks in the response |
| search_type | `Option&lt;SearchMethod&gt;` | The type of search to perform (semantic, fulltext, hybrid) |
| concat_user_messages_query | `Option&lt;bool&gt;` | Whether to concatenate all user messages for the search query |
| search_query | `Option&lt;String&gt;` | The search query to use |
| page_size | `Option&lt;u64&gt;` | The number of chunks to fetch during RAG |
| filters | `Option&lt;ChunkFilter&gt;` | Filters to apply to the chunk search |
| score_threshold | `Option&lt;f32&gt;` | Minimum score threshold for chunks |
| llm_options | `Option&lt;LLMOptions&gt;` | LLM options to use for the completion |

### `EditMessageReqPayload`
#### Description
This struct defines the payload for a request to edit a message in a chat topic and regenerate the subsequent assistant response.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| topic_id | `uuid::Uuid` | The ID of the topic |
| message_sort_order | `i32` | The sort order of the message to edit |
| new_message_content | `String` | The new content of the message |
| highlight_options | `Option&lt;HighlightOptions&gt;` | Options for highlighting chunks in the response |
| search_type | `Option&lt;SearchMethod&gt;` | The type of search to perform (semantic, fulltext, hybrid) |
| concat_user_messages_query | `Option&lt;bool&gt;` | Whether to concatenate all user messages for the search query |
| search_query | `Option&lt;String&gt;` | The search query to use |
| page_size | `Option&lt;u64&gt;` | The number of chunks to fetch during RAG |
| filters | `Option&lt;ChunkFilter&gt;` | Filters to apply to the chunk search |
| score_threshold | `Option&lt;f32&gt;` | Minimum score threshold for chunks |
| llm_options | `Option&lt;LLMOptions&gt;` | LLM options to use for the completion |

### `edit_message`
#### Description
This function handles requests to edit a message in a chat topic and regenerate the subsequent assistant response. It performs authentication checks, deletes the old message, and creates a new message with the edited content and a new assistant response.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;EditMessageReqPayload&gt;` | The request payload |
| user | `AdminOnly` | Authenticated user with admin or owner role |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information |
| pool | `web::Data&lt;Pool&gt;` | Database connection pool |
| event_queue | `web::Data&lt;EventQueue&gt;` | ClickHouse event queue |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response |

#### Internal Logic
- Retrieves the ID of the message to edit.
- Deletes the old message from the database.
- Creates a new message with the edited content and a new assistant response using `create_message`.

### `regenerate_message_patch`
#### Description
This function handles requests to regenerate the last assistant message in a chat topic. It performs authentication checks, retrieves previous messages, deletes the last assistant message, and generates a new assistant response.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;RegenerateMessageReqPayload&gt;` | The request payload |
| user | `AdminOnly` | Authenticated user with admin or owner role |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information |
| pool | `web::Data&lt;Pool&gt;` | Database connection pool |
| event_queue | `web::Data&lt;EventQueue&gt;` | ClickHouse event queue |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response |

#### Internal Logic
- Retrieves previous messages from the topic.
- Checks if there are enough messages to regenerate.
- If there are only two messages (system and user), directly calls `stream_response` to generate the first assistant response.
- Otherwise, removes chunk citations from previous assistant messages, finds the last assistant message, deletes it, and calls `stream_response` to generate a new response.

### `regenerate_message`
#### Description
This function is deprecated and identical to `regenerate_message_patch`.

### `SuggestedQueriesReqPayload`
#### Description
This struct defines the payload for a request to generate suggested queries based on a given query.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| query | `String` | The query to base the suggested queries on |

### `SuggestedQueriesResponse`
#### Description
This struct defines the response for a request to generate suggested queries.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| queries | `Vec&lt;String&gt;` | A list of suggested queries |

### `get_suggested_queries`
#### Description
This function generates suggested queries based on a given query and dataset using RAG. It performs a hybrid search for chunks related to the query, uses the context of the chunks to generate suggested queries using the LLM, and returns the queries as a JSON response.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | `web::Json&lt;SuggestedQueriesReqPayload&gt;` | The request payload |
| dataset_org_plan_sub | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information |
| pool | `web::Data&lt;Pool&gt;` | Database connection pool |
| _required_user | `LoggedUser` | Authenticated user |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | `Result&lt;HttpResponse, ServiceError&gt;` | HTTP response containing the suggested queries |

#### Internal Logic
- Performs a hybrid search for chunks related to the query using `search_hybrid_chunks`.
- Extracts the content of the chunks and uses it as context for the LLM.
- Generates suggested queries using the LLM.
- Uses a similarity search engine to rank the suggested queries based on their relevance to the dataset.
- Returns the top 3 suggested queries as a JSON response.

## Side Effects
- `create_message`, `edit_message`, `regenerate_message_patch`, and `regenerate_message` modify the database by creating, deleting, or updating messages.
- `create_message`, `edit