---
title: "reindex-worker.rs"
---

## High-level description
The code defines a worker process that listens for messages on a Redis queue named "collection_migration". These messages contain instructions for migrating points from one Qdrant collection to another, potentially applying transformations to the points during the migration.

## Table of contents
- Main function (`main`)
- BM25 migration function (`migrate_bm25`)

## References
- `MigratePointMessage` struct from `server/src/data/models.rs`

## Symbols
### `main`
#### Description
This function sets up the worker process, connects to Redis, listens for messages, and processes them.

#### Inputs
None

#### Outputs
- `Result&lt;(), ServiceError&gt;`: Indicates success or failure of the worker process.

#### Internal Logic
1. **Initialization:**
    - Loads environment variables from a `.env` file.
    - Sets up tracing for logging.
    - Connects to a Redis server using the provided URL.
2. **Message Loop:**
    - Enters an infinite loop to continuously listen for messages.
    - Uses the `brpop` command to block and wait for messages on the "collection_migration" queue.
    - If a message is received:
        - Deserializes the message into a `MigratePointMessage` struct.
        - Retrieves the points from the source Qdrant collection.
        - Calls the appropriate migration function based on the `mode` field of the message.
        - Logs the result of the migration.
        - If the migration fails, pushes the message to a "dead_letters" queue.
    - If no message is received, logs a "wait" message and continues the loop.
    - Handles Redis connection errors with exponential backoff.

### `migrate_bm25`
#### Description
This function migrates points from one Qdrant collection to another, applying BM25 embedding transformation to the points.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `qdrant_client` | `Qdrant` | A Qdrant client instance. |
| `points` | `Vec&lt;RetrievedPoint&gt;` | A vector of points retrieved from the source collection. |
| `to_collection` | `String` | The name of the destination collection. |
| `average_len` | `f32` | The average length of documents in the collection for BM25 calculation. |
| `b` | `f32` | The BM25 b parameter. |
| `k` | `f32` | The BM25 k parameter. |

#### Outputs
- `Result&lt;(), ServiceError&gt;`: Indicates success or failure of the migration.

#### Internal Logic
1. **BM25 Embedding Calculation:**
    - Iterates through the retrieved points.
    - Extracts the "content" field from each point's payload.
    - Calculates BM25 embeddings for the content using the provided parameters.
2. **Point Transformation:**
    - Creates new `qdrant::PointStruct` instances for each point.
    - Copies the ID and payload from the original point.
    - Adds a new "bm25_vectors" vector to the point's vectors, containing the calculated BM25 embedding.
3. **Point Insertion:**
    - Uses the `upsert_points` method of the Qdrant client to insert the transformed points into the destination collection.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `itertools` | Used for iterating and collecting data. |
| `qdrant_client` | Used for interacting with the Qdrant vector database. |
| `tracing_subscriber` | Used for logging and tracing. |
| `bb8_redis` | Used for managing a pool of Redis connections. |
| `trieve_server` | Contains internal modules for data models, error handling, environment variable retrieval, and operators for interacting with BM25 and Qdrant. |
| `serde_json` | Used for serializing and deserializing JSON data. |

## Error Handling
The code handles Redis connection errors with exponential backoff. If a migration function fails, the message is pushed to a "dead_letters" queue for later inspection.

## Logging
The code uses the `tracing` crate for logging and tracing. The log level is set to INFO.

## Future Improvements
- The code currently only supports BM25 migration. Other migration modes could be added in the future.
- The error handling could be improved by providing more specific error messages and handling different error types differently.
- The code could be made more robust by handling potential panics within the migration functions.
