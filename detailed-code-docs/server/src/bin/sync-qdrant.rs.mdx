---
title: "sync-qdrant.rs"
---

## High-level description
The code in `sync-qdrant.rs` is a command-line utility that synchronizes data between a PostgreSQL database and a Qdrant vector database. It identifies and removes points from Qdrant that are not present in the PostgreSQL database, ensuring consistency between the two data sources.

## Table of contents
- Initialization and setup
- Collection iteration
- Point synchronization
- Deletion of out-of-sync points

## References
- `get_qdrant_collections`: Retrieves a list of Qdrant collections.
- `scroll_qdrant_collection_ids`: Fetches point IDs from a Qdrant collection in batches.
- `get_pg_point_ids_from_qdrant_point_ids`: Retrieves corresponding PostgreSQL point IDs for given Qdrant point IDs.
- `delete_points_from_qdrant`: Deletes points from a Qdrant collection.

## Symbols
### `main`
#### Description
This function is the entry point of the synchronization utility. It establishes connections to the PostgreSQL and Qdrant databases, iterates through Qdrant collections, and synchronizes points between the two databases.

#### Inputs
None

#### Outputs
- `Result&lt;(), ServiceError&gt;`: Indicates success or failure of the synchronization process.

#### Internal Logic
1. **Initialization:**
    - Loads environment variables from a `.env` file.
    - Retrieves the PostgreSQL database URL from the environment.
    - Creates a connection pool for PostgreSQL using `diesel_async`.
    - Retrieves a list of Qdrant collections.
2. **Collection Iteration:**
    - Iterates through each Qdrant collection.
    - Initializes an offset for scrolling through the collection.
3. **Point Synchronization:**
    - Fetches a batch of Qdrant point IDs using `scroll_qdrant_collection_ids`.
    - Retrieves corresponding PostgreSQL point IDs for the fetched Qdrant point IDs.
    - Identifies Qdrant points that are not present in the PostgreSQL database.
    - Extracts the datasets associated with the out-of-sync points.
4. **Deletion of Out-of-Sync Points:**
    - If out-of-sync points are found, prints their count and associated datasets.
    - Deletes the out-of-sync points from the Qdrant collection using `delete_points_from_qdrant`.
    - Updates the offset for the next batch of points.
5. **Completion:**
    - Returns `Ok(())` upon successful synchronization.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `diesel_async` | Asynchronous connection pool for PostgreSQL |
| `trieve_server` | Custom library containing database interaction and Qdrant operations |
| `uuid` | UUID generation and manipulation |
| `dotenvy` | Environment variable loading |
| `tokio` | Asynchronous runtime |
| `actix_web` | Web framework used for creating the connection pool |

## Error Handling
The `main` function returns a `Result&lt;(), ServiceError&gt;`, indicating success or failure of the synchronization process. Errors encountered during database interactions or Qdrant operations are propagated as `ServiceError`.

## Logging
The code uses `println!` statements to print information about the synchronization process, including the collection being processed and the number of out-of-sync points.
