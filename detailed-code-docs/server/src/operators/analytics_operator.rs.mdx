---
title: "analytics_operator.rs"
---

## High-level description
This code defines functions for querying and manipulating data related to search, RAG, recommendation, and cluster analytics in a system that uses ClickHouse for data storage. It includes functions for retrieving metrics, queries, usage graphs, and CTR data, as well as for rating queries and sending CTR data.

## Table of contents
- `get_clusters_query`
- `get_queries_for_cluster_query`
- `get_search_query`
- `get_search_metrics_query`
- `get_head_queries_query`
- `get_low_confidence_queries_query`
- `get_no_result_queries_query`
- `get_all_queries_query`
- `get_query_counts_query`
- `get_search_usage_graph_query`
- `get_latency_graph_query`
- `get_rag_queries_query`
- `get_rag_usage_query`
- `get_rag_usage_graph_query`
- `get_low_confidence_recommendations_query`
- `get_recommendation_queries_query`
- `send_ctr_data_query`
- `get_search_ctr_metrics_query`
- `get_searches_with_clicks_query`
- `get_searches_without_clicks_query`
- `get_recommendation_ctr_metrics_query`
- `get_recommendations_with_clicks_query`
- `get_recommendations_without_clicks_query`
- `set_query_rating_query`

## References
- `crate::data::models`: This module defines the data models used for representing various entities like search queries, RAG queries, recommendations, clusters, and analytics filters.
- `crate::errors::ServiceError`: This module defines the custom error type used for handling errors in the application.
- `super::chunk_operator::get_metadata_from_tracking_id_query`: This function is used to retrieve chunk metadata based on a tracking ID.

## Symbols

### `get_clusters_query`
#### Description
Retrieves the top 10 search clusters for a given dataset, optionally filtered by a `ClusterAnalyticsFilter`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filters | Option&lt;ClusterAnalyticsFilter&gt; | Optional filter for the clusters. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SearchClusterResponse, ServiceError&gt; |  | A `SearchClusterResponse` containing the clusters, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select cluster topics based on the dataset ID and optional filters.
2. Executes the query and fetches all results as `ClusterTopicsClickhouse` structs.
3. Converts the `ClusterTopicsClickhouse` structs into `SearchClusterTopics` structs.
4. Returns a `SearchClusterResponse` containing the clusters.

### `get_queries_for_cluster_query`
#### Description
Retrieves the search queries associated with a specific cluster, paginated by 15 queries per page.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| cluster_id | uuid::Uuid | The ID of the cluster. |
| page | Option&lt;u32&gt; | The page number for pagination. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SearchQueryResponse, ServiceError&gt; |  | A `SearchQueryResponse` containing the queries, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select distinct search queries based on the cluster ID and dataset ID.
2. Executes the query and fetches all results as `SearchQueryEventClickhouse` structs.
3. Converts the `SearchQueryEventClickhouse` structs into `SearchQueryEvent` structs.
4. Returns a `SearchQueryResponse` containing the queries.

### `get_search_query`
#### Description
Retrieves a specific search query by its ID and dataset ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| search_id | uuid::Uuid | The ID of the search query. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SearchQueryEvent, ServiceError&gt; |  | The `SearchQueryEvent` representing the query, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select a search query based on its ID and dataset ID.
2. Executes the query and fetches the result as a `SearchQueryEventClickhouse` struct.
3. Converts the `SearchQueryEventClickhouse` struct into a `SearchQueryEvent` struct.
4. Returns the `SearchQueryEvent`.

### `get_search_metrics_query`
#### Description
Retrieves search metrics for a given dataset, optionally filtered by a `SearchAnalyticsFilter`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search metrics. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;DatasetAnalytics, ServiceError&gt; |  | A `DatasetAnalytics` struct containing the metrics, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to calculate search metrics based on the dataset ID and optional filters.
2. Executes the query and fetches the result as a `DatasetAnalytics` struct.
3. Returns the `DatasetAnalytics` struct.

### `get_head_queries_query`
#### Description
Retrieves the top 10 most frequent search queries for a given dataset, optionally filtered by a `SearchAnalyticsFilter` and paginated by 10 queries per page.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search queries. |
| page | Option&lt;u32&gt; | The page number for pagination. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HeadQueryResponse, ServiceError&gt; |  | A `HeadQueryResponse` containing the queries, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select the top 10 most frequent search queries based on the dataset ID, optional filters, and pagination.
2. Executes the query and fetches all results as `HeadQueries` structs.
3. Returns a `HeadQueryResponse` containing the queries.

### `get_low_confidence_queries_query`
#### Description
Retrieves search queries with low confidence scores (below a given threshold) for a given dataset, optionally filtered by a `SearchAnalyticsFilter`, paginated by 10 queries per page.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search queries. |
| threshold | Option&lt;f32&gt; | The threshold for low confidence scores. |
| page | Option&lt;u32&gt; | The page number for pagination. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SearchQueryResponse, ServiceError&gt; |  | A `SearchQueryResponse` containing the queries, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select search queries with low confidence scores based on the dataset ID, optional filters, threshold, and pagination.
2. Executes the query and fetches all results as `SearchQueryEventClickhouse` structs.
3. Converts the `SearchQueryEventClickhouse` structs into `SearchQueryEvent` structs.
4. Returns a `SearchQueryResponse` containing the queries.

### `get_no_result_queries_query`
#### Description
Retrieves search queries that returned no results for a given dataset, optionally filtered by a `SearchAnalyticsFilter`, paginated by 10 queries per page.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search queries. |
| page | Option&lt;u32&gt; | The page number for pagination. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SearchQueryResponse, ServiceError&gt; |  | A `SearchQueryResponse` containing the queries, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select search queries with no results based on the dataset ID, optional filters, and pagination.
2. Executes the query and fetches all results as `SearchQueryEventClickhouse` structs.
3. Converts the `SearchQueryEventClickhouse` structs into `SearchQueryEvent` structs.
4. Returns a `SearchQueryResponse` containing the queries.

### `get_all_queries_query`
#### Description
Retrieves all search queries for a given dataset, optionally filtered by a `SearchAnalyticsFilter`, sorted by a given field and order, and paginated by 10 queries per page.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search queries. |
| sort_by | Option&lt;SearchSortBy&gt; | The field to sort the queries by. |
| sort_order | Option&lt;SortOrder&gt; | The order to sort the queries in. |
| page | Option&lt;u32&gt; | The page number for pagination. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SearchQueryResponse, ServiceError&gt; |  | A `SearchQueryResponse` containing the queries, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to select all search queries based on the dataset ID, optional filters, sorting, and pagination.
2. Executes the query and fetches all results as `SearchQueryEventClickhouse` structs.
3. Converts the `SearchQueryEventClickhouse` structs into `SearchQueryEvent` structs.
4. Returns a `SearchQueryResponse` containing the queries.

### `get_query_counts_query`
#### Description
Retrieves the counts of search queries grouped by search type and search method for a given dataset, optionally filtered by a `SearchAnalyticsFilter`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search queries. |
| clickhouse_client | &clickhouse::Client | A reference to the ClickHouse client. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;QueryCountResponse, ServiceError&gt; |  | A `QueryCountResponse` containing the counts, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. Constructs a ClickHouse query string to count search queries grouped by search type and search method based on the dataset ID and optional filters.
2. Executes the query and fetches all results as `SearchTypeCount` structs.
3. Returns a `QueryCountResponse` containing the counts.

### `get_search_usage_graph_query`
#### Description
Retrieves data points for a search usage graph, showing the number of search requests over time for a given dataset, optionally filtered by a `SearchAnalyticsFilter` and with a specified granularity.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset. |
| filter | Option&lt;SearchAnalyticsFilter&gt; | Optional filter for the search queries. |
| granularity | Option&lt;Granularity&gt; | The granularity of the