---
title: "stripe_operator.rs"
---

## High-level description
This code defines a module `stripe_operator` that contains functions for interacting with the Stripe API and the database to manage subscriptions, plans, and invoices. It includes functions for creating, retrieving, updating, and deleting subscriptions and plans, as well as creating and retrieving invoices.

## Table of contents
- `get_stripe_client`
- `create_stripe_subscription_query`
- `create_stripe_plan_query`
- `get_plan_by_id_query`
- `get_all_plans_query`
- `create_stripe_payment_link`
- `get_subscription_by_id_query`
- `delete_subscription_by_id_query`
- `get_option_subscription_by_organization_id_query`
- `set_stripe_subscription_current_period_end`
- `cancel_stripe_subscription`
- `update_stripe_subscription_plan_query`
- `update_stripe_subscription`
- `create_invoice_query`
- `invoice_exists_query`
- `get_invoices_for_org_query`
- `create_stripe_setup_checkout_session`
- `set_subscription_payment_method`

## References
This module references the following data structures:
- `Pool`: A database connection pool.
- `StripeInvoice`: A struct representing a Stripe invoice.
- `StripePlan`: A struct representing a Stripe plan.
- `StripeSubscription`: A struct representing a Stripe subscription.

## Symbols

### `get_stripe_client`
#### Description
This function retrieves the Stripe API client using the `STRIPE_SECRET` environment variable.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| client | `stripe::Client` | The Stripe API client. |

#### Internal Logic
- Retrieves the `STRIPE_SECRET` environment variable.
- Creates a new Stripe client using the secret key.

### `create_stripe_subscription_query`
#### Description
This function creates a new Stripe subscription in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stripe_id | `String` | The Stripe ID of the subscription. |
| plan_id | `uuid::Uuid` | The ID of the Stripe plan. |
| organization_id | `uuid::Uuid` | The ID of the organization. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Creates a new `StripeSubscription` instance from the provided details.
- Inserts the subscription into the `stripe_subscriptions` table.

### `create_stripe_plan_query`
#### Description
This function creates a new Stripe plan in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stripe_id | `String` | The Stripe ID of the plan. |
| amount | `i64` | The amount of the plan in cents. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;StripePlan, ServiceError&gt;` | A result containing the created `StripePlan` or an error. |

#### Internal Logic
- Creates a new `StripePlan` instance from the provided details.
- Inserts the plan into the `stripe_plans` table.
- Returns the created `StripePlan`.

### `get_plan_by_id_query`
#### Description
This function retrieves a Stripe plan from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| plan_id | `uuid::Uuid` | The ID of the Stripe plan. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;StripePlan, ServiceError&gt;` | A result containing the retrieved `StripePlan` or an error. |

#### Internal Logic
- Queries the `stripe_plans` table for the plan with the given ID.
- Returns the retrieved `StripePlan`.

### `get_all_plans_query`
#### Description
This function retrieves all Stripe plans from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;StripePlan&gt;, ServiceError&gt;` | A result containing a vector of `StripePlan`s or an error. |

#### Internal Logic
- Queries the `stripe_plans` table for all plans.
- Returns the retrieved plans.

### `create_stripe_payment_link`
#### Description
This function creates a Stripe payment link for a given plan and organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| plan | `StripePlan` | The Stripe plan. |
| organization_id | `uuid::Uuid` | The ID of the organization. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;String, ServiceError&gt;` | A result containing the payment link URL or an error. |

#### Internal Logic
- Retrieves the `STRIPE_SECRET` and `ADMIN_DASHBOARD_URL` environment variables.
- Constructs a payment link creation request to the Stripe API.
- Sends the request and parses the response.
- Extracts the payment link URL from the response.

### `get_subscription_by_id_query`
#### Description
This function retrieves a Stripe subscription from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_id | `uuid::Uuid` | The ID of the Stripe subscription. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;StripeSubscription, ServiceError&gt;` | A result containing the retrieved `StripeSubscription` or an error. |

#### Internal Logic
- Queries the `stripe_subscriptions` table for the subscription with the given ID.
- Returns the retrieved `StripeSubscription`.

### `delete_subscription_by_id_query`
#### Description
This function deletes a Stripe subscription from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_id | `uuid::Uuid` | The ID of the Stripe subscription. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Deletes the subscription from the `stripe_subscriptions` table.

### `get_option_subscription_by_organization_id_query`
#### Description
This function retrieves an optional Stripe subscription from the database by its organization ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | `uuid::Uuid` | The ID of the organization. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Option&lt;StripeSubscription&gt;, ServiceError&gt;` | A result containing an optional `StripeSubscription` or an error. |

#### Internal Logic
- Queries the `stripe_subscriptions` table for subscriptions associated with the given organization ID.
- Returns the first subscription found, or `None` if no subscriptions are found.

### `set_stripe_subscription_current_period_end`
#### Description
This function updates the `current_period_end` field of a Stripe subscription in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stripe_subscription_id | `String` | The Stripe ID of the subscription. |
| current_period_end | `chrono::NaiveDateTime` | The new current period end date. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Updates the `current_period_end` field of the subscription in the `stripe_subscriptions` table.

### `cancel_stripe_subscription`
#### Description
This function cancels a Stripe subscription using the Stripe API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_stripe_id | `String` | The Stripe ID of the subscription. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Retrieves the Stripe API client.
- Parses the subscription ID.
- Cancels the subscription using the Stripe API.

### `update_stripe_subscription_plan_query`
#### Description
This function updates the plan ID of a Stripe subscription in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_id | `uuid::Uuid` | The ID of the Stripe subscription. |
| plan_id | `uuid::Uuid` | The ID of the new Stripe plan. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Updates the `plan_id` field of the subscription in the `stripe_subscriptions` table.

### `update_stripe_subscription`
#### Description
This function updates a Stripe subscription's plan using the Stripe API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_stripe_id | `String` | The Stripe ID of the subscription. |
| plan_stripe_id | `String` | The Stripe ID of the new plan. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Retrieves the Stripe API client.
- Parses the subscription ID.
- Lists the subscription items.
- Deletes the existing subscription items.
- Creates a new subscription item with the new plan ID.
- Updates the subscription with the new items.

### `create_invoice_query`
#### Description
This function creates a new Stripe invoice in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | `uuid::Uuid` | The ID of the organization. |
| invoice_id | `stripe::InvoiceId` | The Stripe ID of the invoice. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;(), ServiceError&gt;` | A result indicating success or failure. |

#### Internal Logic
- Retrieves the Stripe API client.
- Retrieves the invoice details from Stripe.
- Checks if the invoice already exists in the database.
- Creates a new `StripeInvoice` instance from the retrieved details.
- Inserts the invoice into the `stripe_invoices` table.

### `invoice_exists_query`
#### Description
This function checks if a Stripe invoice exists in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice_id | `String` | The Stripe ID of the invoice. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;bool, ServiceError&gt;` | A result indicating whether the invoice exists or an error. |

#### Internal Logic
- Queries the `stripe_invoices` table for the invoice with the given ID.
- Returns `true` if the invoice exists, `false` otherwise.

### `get_invoices_for_org_query`
#### Description
This function retrieves all Stripe invoices for a given organization from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | `uuid::Uuid` | The ID of the organization. |
| pool | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;StripeInvoice&gt;, ServiceError&gt;` | A result containing a vector of `StripeInvoice`s or an error. |

#### Internal Logic
- Queries the `stripe_invoices` table for invoices associated with the given organization ID.
-