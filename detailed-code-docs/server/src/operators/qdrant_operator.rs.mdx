---
title: "qdrant_operator.rs"
---

## High-level description
The `qdrant_operator.rs` file defines functions for interacting with a Qdrant vector database. These functions include creating and managing collections, upserting and updating points, performing searches and recommendations, and managing bookmarks.

## Table of contents
- `get_qdrant_connection`
- `get_qdrant_collection_from_dataset_config`
- `create_new_qdrant_collection_query`
- `bulk_upsert_qdrant_points_query`
- `create_new_qdrant_point_query`
- `update_qdrant_point_query`
- `add_bookmark_to_qdrant_query`
- `remove_bookmark_from_qdrant_query`
- `search_over_groups_query`
- `search_qdrant_query`
- `recommend_qdrant_query`
- `recommend_qdrant_groups_query`
- `point_ids_exists_in_qdrant`
- `get_collection_name_from_config`
- `delete_points_from_qdrant`
- `get_qdrant_collections`
- `scroll_qdrant_collection_ids`
- `count_qdrant_query`
- `update_group_tag_sets_in_qdrant_query`
- `scroll_dataset_points`

## References
- `get_groups_from_group_ids_query` (from `group_operator.rs`)
- `assemble_qdrant_filter` (from `search_operator.rs`)

## Symbols

### `get_qdrant_connection`
#### Description
Establishes a connection to a Qdrant database using the provided URL and API key.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| qdrant_url | Option&lt;&str&gt; | The URL of the Qdrant database. |
| qdrant_api_key | Option&lt;&str&gt; | The API key for the Qdrant database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Qdrant, ServiceError&gt; |  | A `Result` containing either a `Qdrant` client on success or a `ServiceError` on failure. |

#### Internal Logic
- Retrieves the Qdrant URL and API key from environment variables if not provided.
- Builds a `Qdrant` client using the provided URL and API key.
- Sets a timeout of 60 seconds for the connection.
- Returns a `Result` indicating success or failure.

### `get_qdrant_collection_from_dataset_config`
#### Description
Generates the name of a Qdrant collection based on the provided dataset configuration.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_config | &DatasetConfiguration | The configuration of the dataset. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| String |  | The name of the Qdrant collection. |

#### Internal Logic
- Constructs the collection name based on the embedding size and distance metric specified in the dataset configuration.

### `create_new_qdrant_collection_query`
#### Description
Creates a new Qdrant collection and indexes.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| qdrant_url | Option&lt;&str&gt; | The URL of the Qdrant database. |
| qdrant_api_key | Option&lt;&str&gt; | The API key for the Qdrant database. |
| quantize | bool | Whether to quantize the vectors. |
| recreate_indexes | bool | Whether to recreate existing indexes. |
| replication_factor | u32 | The replication factor for the collection. |
| accepted_vectors | Vec&lt;u64&gt; | A vector of accepted vector sizes. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | A `Result` indicating success or failure. |

#### Internal Logic
- Establishes a connection to the Qdrant database.
- Iterates through accepted vector sizes and distance metrics to create collections for each combination.
- Checks if the collection already exists.
- If the collection doesn't exist, creates it with specified vector configurations, sparse vector configurations, and HNSW configuration.
- Optionally recreates indexes for specific fields.
- Creates field indexes for various fields like "link", "tag_set", "dataset_id", etc.

### `bulk_upsert_qdrant_points_query`
#### Description
Upserts a batch of points into a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| points | Vec&lt;PointStruct&gt; | A vector of `PointStruct` representing the points to upsert. |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | A `Result` indicating success or failure. |

#### Internal Logic
- Retrieves the Qdrant collection name from the dataset configuration.
- Establishes a connection to the Qdrant database.
- Upserts the points into the specified collection using the `UpsertPointsBuilder`.
- Handles errors during upsertion.

### `create_new_qdrant_point_query`
#### Description
Creates a new point in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_id | uuid::Uuid | The ID of the point. |
| embedding_vector | Vec&lt;f32&gt; | The embedding vector for the point. |
| chunk_metadata | ChunkMetadata | The metadata associated with the chunk. |
| splade_vector | Vec&lt;(u32, f32)&gt; | The sparse vector for the point. |
| group_ids | Option&lt;Vec&lt;uuid::Uuid&gt;&gt; | The IDs of the groups the chunk belongs to. |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |
| pool | web::Data&lt;Pool&gt; | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | A `Result` indicating success or failure. |

#### Internal Logic
- Retrieves group tags from the database based on group IDs.
- Creates a `QdrantPayload` from the chunk metadata and group IDs.
- Determines the vector name based on the embedding vector size.
- Constructs a vector payload with both dense and sparse vectors.
- Creates a `PointStruct` with the point ID, vector payload, and Qdrant payload.
- Establishes a connection to the Qdrant database.
- Upserts the point into the specified collection.
- Handles errors during upsertion.

### `update_qdrant_point_query`
#### Description
Updates an existing point in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| metadata | ChunkMetadata | The updated metadata for the chunk. |
| updated_vector | Option&lt;Vec&lt;f32&gt;&gt; | The updated embedding vector (optional). |
| group_ids | Option&lt;Vec&lt;uuid::Uuid&gt;&gt; | The updated group IDs (optional). |
| dataset_id | uuid::Uuid | The ID of the dataset. |
| splade_vector | Vec&lt;(u32, f32)&gt; | The updated sparse vector. |
| bm25_vector | Option&lt;Vec&lt;(u32, f32)&gt;&gt; | The updated BM25 vector (optional). |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |
| web_pool | web::Data&lt;Pool&gt; | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), actix_web::Error&gt; |  | A `Result` indicating success or failure. |

#### Internal Logic
- Retrieves the Qdrant point ID from the chunk metadata.
- Retrieves the current point from Qdrant.
- Constructs a new `QdrantPayload` with updated metadata and group IDs.
- If an updated vector is provided, upserts the point with the new vector and payload.
- If no updated vector is provided, overwrites the existing payload with the new `QdrantPayload`.
- Handles errors during upsertion or payload overwrite.

### `add_bookmark_to_qdrant_query`
#### Description
Adds a bookmark to a point in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_id | uuid::Uuid | The ID of the point to bookmark. |
| group_id | uuid::Uuid | The ID of the group to add the bookmark to. |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | A `Result` indicating success or failure. |

#### Internal Logic
- Retrieves the current point from Qdrant.
- Extracts the existing group IDs from the point's payload.
- Appends the new group ID to the list of group IDs.
- Creates a new `QdrantPayload` with the updated group IDs.
- Overwrites the existing payload with the new `QdrantPayload`.
- Handles errors during payload overwrite.

### `remove_bookmark_from_qdrant_query`
#### Description
Removes a bookmark from a point in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_id | uuid::Uuid | The ID of the point to remove the bookmark from. |
| group_id | uuid::Uuid | The ID of the group to remove the bookmark from. |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | A `Result` indicating success or failure. |

#### Internal Logic
- Retrieves the current point from Qdrant.
- Extracts the existing group IDs from the point's payload.
- Removes the specified group ID from the list of group IDs.
- Creates a new `QdrantPayload` with the updated group IDs.
- Overwrites the existing payload with the new `QdrantPayload`.
- Handles errors during payload overwrite.

### `search_over_groups_query`
#### Description
Performs a search over groups in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| page | u64 | The page number of results to retrieve. |
| filter | Filter | A Qdrant filter to apply to the search. |
| limit | u64 | The maximum number of results to retrieve per page. |
| score_threshold | Option&lt;f32&gt; | The minimum score threshold for results. |
| group_size | u32 | The desired size of each group. |
| vector | VectorType | The type of vector to use for the search. |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |
| get_total_pages | bool | Whether to retrieve the total number of pages. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(Vec&lt;GroupSearchResults&gt;, u64), ServiceError&gt; |  | A `Result` containing a tuple of group search results and the total count, or a `ServiceError` on failure. |

#### Internal Logic
- Retrieves the Qdrant collection name from the dataset configuration.
- Establishes a connection to the Qdrant database.
- Constructs a `SearchPointGroups` request based on the provided parameters.
- Executes the search request and retrieves the results.
- Processes the results, extracting group IDs and hits.
- Optionally retrieves the total count of results.
- Returns the group search results and total count.

### `search_qdrant_query`
#### Description
Performs a search in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| page | u64 | The page number of results to retrieve. |
| queries | Vec&lt;QdrantSearchQuery&gt; | A vector of search queries. |
| dataset_config | DatasetConfiguration | The configuration of the dataset. |
| get_total_pages | bool | Whether to retrieve the total number of pages. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(Vec&lt;SearchResult&gt;, u64, Vec&lt;usize&gt;), ServiceError&gt; |  | A `Result` containing a tuple of search results, the total count, and batch lengths, or a `ServiceError` on failure. |

#### Internal Logic
- Retrieves the Qdrant collection name from the dataset configuration.
- Establishes a connection to the Qdrant database.
- Constructs a `QueryBatchPoints` request based on the provided queries.
- Executes the search request and retrieves the results.