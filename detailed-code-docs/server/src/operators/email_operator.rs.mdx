---
title: "email_operator.rs"
---

## High-level description
The `email_operator.rs` file provides functionality for sending emails using the `lettre` crate. It defines functions to retrieve SMTP credentials from environment variables and send HTML emails via an SMTP relay.

## Table of contents
- `get_smtp_creds` function
- `send_email` function

## References
- `get_env` macro (from `crate`)

## Symbols

### `get_smtp_creds`
#### Description
Retrieves SMTP username and password from environment variables and returns them as `lettre::transport::smtp::authentication::Credentials`.

#### Inputs
None

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| (unnamed) | `Credentials` | SMTP credentials containing username and password |

#### Internal Logic
1. Reads `SMTP_USERNAME` and `SMTP_PASSWORD` from environment variables using the `get_env` macro.
2. Constructs and returns a `Credentials` object using the retrieved username and password.

### `send_email`
#### Description
Sends an HTML email using the provided email body, recipient address, and SMTP configuration from environment variables.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `html_email_body` | `String` | HTML content of the email body |
| `to_address` | `String` | Email address of the recipient |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| (unnamed) | `Result&lt;(), ServiceError&gt;` | Returns `Ok(())` on successful email sending, otherwise returns a `ServiceError::BadRequest` |

#### Internal Logic
1. Reads `SMTP_RELAY` and `SMTP_EMAIL_ADDRESS` from environment variables using the `get_env` macro.
2. Retrieves SMTP credentials using the `get_smtp_creds` function.
3. Creates an `SmtpTransport` instance with the SMTP relay address and credentials.
4. Constructs an email message using `lettre::Message` with the sender, recipient, subject, content type, and body.
5. Attempts to send the email using the configured `SmtpTransport`.
6. Logs an error message and returns a `ServiceError::BadRequest` if sending fails.
7. Returns `Ok(())` if sending is successful.

## Side Effects
- Sends an email via the configured SMTP relay.
- Logs an error message if email sending fails.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `lettre` | Used for constructing and sending emails |

## Configuration
- `SMTP_RELAY`: SMTP relay server address.
- `SMTP_USERNAME`: SMTP username for authentication.
- `SMTP_PASSWORD`: SMTP password for authentication.
- `SMTP_EMAIL_ADDRESS`: Email address to be used as the sender.

## Error Handling
- Returns a `ServiceError::BadRequest` if email sending fails or if there are errors reading environment variables or parsing email addresses.
- Logs an error message if email sending fails.

## Logging
- Logs an error message with details if email sending fails.
