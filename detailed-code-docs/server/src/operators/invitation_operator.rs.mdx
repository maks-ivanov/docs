---
title: "invitation_operator.rs"
---

## High-level description
This code defines functions for managing invitations in the Trieve application. It includes functions for creating, retrieving, deleting, and marking invitations as used. It also handles sending invitation emails to new and existing users.

## Table of contents
- `create_invitation_query`
- `get_invitation_by_id_query`
- `send_invitation`
- `send_invitation_for_existing_user`
- `set_invitation_used`
- `check_inv_valid`
- `get_invitations_for_organization_query`
- `delete_invitation_by_id_query`

## References
- `crate::data::models::Invitation`: Represents an invitation in the database.
- `crate::errors::ServiceError`: Custom error type for the application.
- `crate::operators::email_operator::send_email`: Function to send emails.

## Symbols

### `create_invitation_query`
#### Description
Creates a new invitation in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| email | String | The email address of the invitee. |
| organization_id | uuid::Uuid | The ID of the organization the invitee is being invited to. |
| user_role | i32 | The role the invitee will have in the organization. |
| pool | web::Data&lt;Pool&gt; | A connection pool to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Invitation, ServiceError&gt; |  | The newly created invitation or an error if the creation failed. |

#### Internal Logic
- Creates a new `Invitation` instance from the provided details.
- Inserts the new invitation into the `invitations` table using Diesel.
- Returns the inserted invitation if successful, otherwise returns a `ServiceError::BadRequest`.

### `get_invitation_by_id_query`
#### Description
Retrieves an invitation from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | uuid::Uuid | The ID of the invitation to retrieve. |
| pool | web::Data&lt;Pool&gt; | A connection pool to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Invitation, ServiceError&gt; |  | The retrieved invitation or an error if it was not found. |

#### Internal Logic
- Queries the `invitations` table for an invitation with the given ID using Diesel.
- Returns the invitation if found, otherwise returns a `ServiceError::BadRequest`.

### `send_invitation`
#### Description
Sends an invitation email to the invitee.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| inv_url | String | The registration URL for the invitee. |
| invitation | Invitation | The invitation object containing the invitee's email address. |
| org_name | String | The name of the organization the invitee is being invited to. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | Returns `Ok(())` if the email was sent successfully, otherwise returns a `ServiceError`. |

#### Internal Logic
- Formats the email content using the provided information.
- Calls the `send_email` function to send the email.

### `send_invitation_for_existing_user`
#### Description
Sends an email notification to an existing user who has been added to an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| email | String | The email address of the user. |
| org_name | String | The name of the organization the user has been added to. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | Returns `Ok(())` if the email was sent successfully, otherwise returns a `ServiceError`. |

#### Internal Logic
- Formats the email content using the provided information.
- Calls the `send_email` function to send the email.

### `set_invitation_used`
#### Description
Marks an invitation as used in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | uuid::Uuid | The ID of the invitation to mark as used. |
| pool | web::Data&lt;Pool&gt; | A connection pool to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | Returns `Ok(())` if the invitation was successfully marked as used, otherwise returns a `ServiceError::BadRequest`. |

#### Internal Logic
- Updates the `invitations` table, setting the `used` field to `true` for the invitation with the given ID using Diesel.

### `check_inv_valid`
#### Description
Checks if an invitation is valid and marks it as used if it is.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| inv_code | uuid::Uuid | The ID of the invitation. |
| email | String | The email address of the user attempting to use the invitation. |
| organization_id | Option&lt;uuid::Uuid&gt; | The ID of the organization the invitation is for. |
| pool | web::Data&lt;Pool&gt; | A connection pool to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Invitation, ServiceError&gt; |  | Returns the invitation if it is valid and has been marked as used, otherwise returns a `ServiceError`. |

#### Internal Logic
- Retrieves the invitation from the database using `get_invitation_by_id_query`.
- Checks if the provided email address matches the invitation's email address.
- Checks if the provided organization ID matches the invitation's organization ID.
- Checks if the invitation has already been used.
- If all checks pass, marks the invitation as used using `set_invitation_used` and returns the invitation.
- If any check fails, returns a `ServiceError::BadRequest` with an appropriate error message.

### `get_invitations_for_organization_query`
#### Description
Retrieves all invitations for a given organization from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization to retrieve invitations for. |
| pool | web::Data&lt;Pool&gt; | A connection pool to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Vec&lt;Invitation&gt;, ServiceError&gt; |  | A vector of invitations for the organization or an error if the retrieval failed. |

#### Internal Logic
- Queries the `invitations` table for all invitations with the given organization ID using Diesel.
- Returns the invitations if successful, otherwise returns a `ServiceError::BadRequest`.

### `delete_invitation_by_id_query`
#### Description
Deletes an invitation from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | uuid::Uuid | The ID of the invitation to delete. |
| pool | web::Data&lt;Pool&gt; | A connection pool to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | Returns `Ok(())` if the invitation was successfully deleted, otherwise returns a `ServiceError::BadRequest`. |

#### Internal Logic
- Deletes the invitation with the given ID from the `invitations` table using Diesel.

## Dependencies
- `diesel`: An ORM and query builder for Rust.
- `diesel_async`: Asynchronous support for Diesel.
- `actix-web`: A web framework for Rust.
- `lettre`: An email library for Rust.
- `regex`: A regular expression library for Rust.
- `uuid`: A library for generating and parsing UUIDs.

## Error Handling
The functions in this module return `Result&lt;T, ServiceError&gt;` where `T` is the expected return type and `ServiceError` is a custom error type. This allows for centralized error handling and consistent error responses.

## Logging
The functions in this module use the `tracing` crate for logging. This allows for structured logging and easy integration with logging systems like Jaeger and Zipkin.
