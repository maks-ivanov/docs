---
title: "dataset_operator.rs"
---

## High-level description
This code defines functions for interacting with the `datasets` table in the database. It includes functions for creating, retrieving, updating, and deleting datasets. It also includes functions for managing dataset usage counts and retrieving datasets associated with an organization.

## Table of contents
- `create_dataset_query`
- `get_dataset_by_id_query`
- `get_deleted_dataset_by_unifiedid_query`
- `get_dataset_and_organization_from_dataset_id_query`
- `soft_delete_dataset_by_id_query`
- `clear_dataset_by_dataset_id_query`
- `clear_dataset_query`
- `delete_dataset_by_id_query`
- `update_dataset_query`
- `get_datasets_by_organization_id`
- `get_dataset_usage_query`

## References
- `crate::data::models::{Dataset, DatasetConfiguration, UnifiedId, Pool, RedisPool}`
- `crate::operators::clickhouse_operator::ClickHouseEvent`
- `crate::operators::clickhouse_operator::EventQueue`
- `crate::operators::qdrant_operator::{delete_points_from_qdrant, get_qdrant_collection_from_dataset_config}`

## Symbols

### `create_dataset_query`
#### Description
Creates a new dataset in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `new_dataset` | `Dataset` | The dataset to create. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;Dataset, ServiceError&gt;` |  | The created dataset or an error if the creation failed. |

#### Internal Logic
- Inserts the new dataset into the `datasets` table.
- Returns a `BadRequest` error if a dataset with the same `tracking_id` already exists in the organization.

### `get_dataset_by_id_query`
#### Description
Retrieves a dataset from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `UnifiedId` | The ID of the dataset to retrieve. Can be either a `TrieveUuid` or a `TrackingId`. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;Dataset, ServiceError&gt;` |  | The retrieved dataset or an error if the retrieval failed. |

#### Internal Logic
- Queries the `datasets` table for a dataset with the given ID and `deleted` flag set to 0.
- Returns a `NotFound` error if no dataset is found.

### `get_deleted_dataset_by_unifiedid_query`
#### Description
Retrieves a deleted dataset from the database by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `UnifiedId` | The ID of the dataset to retrieve. Can be either a `TrieveUuid` or a `TrackingId`. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;Dataset, ServiceError&gt;` |  | The retrieved dataset or an error if the retrieval failed. |

#### Internal Logic
- Queries the `datasets` table for a dataset with the given ID, regardless of the `deleted` flag.
- Returns a `NotFound` error if no dataset is found.

### `get_dataset_and_organization_from_dataset_id_query`
#### Description
Retrieves a dataset and its associated organization from the database by the dataset's ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `UnifiedId` | The ID of the dataset to retrieve. Can be either a `TrieveUuid` or a `TrackingId`. |
| `org_id` | `Option&lt;uuid::Uuid&gt;` | The ID of the organization to which the dataset belongs. Required if `id` is a `TrackingId`. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;DatasetAndOrgWithSubAndPlan, ServiceError&gt;` |  | The retrieved dataset and organization or an error if the retrieval failed. |

#### Internal Logic
- Queries the `datasets` table, joining with the `organizations`, `stripe_subscriptions`, and `stripe_plans` tables to retrieve the dataset, organization, stripe plan, and stripe subscription.
- Filters the query based on the given dataset ID and organization ID (if provided).
- Returns a `NotFound` error if no dataset is found.

### `soft_delete_dataset_by_id_query`
#### Description
Soft deletes a dataset by setting its `deleted` flag to 1 and clearing its `tracking_id`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `uuid::Uuid` | The ID of the dataset to delete. |
| `dataset_config` | `DatasetConfiguration` | The configuration of the dataset. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |
| `redis_pool` | `web::Data&lt;RedisPool&gt;` | The Redis connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;(), ServiceError&gt;` |  | An error if the deletion failed. |

#### Internal Logic
- Checks if the dataset is locked. If it is, returns a `BadRequest` error.
- Updates the `datasets` table, setting the `deleted` flag to 1 and clearing the `tracking_id` for the given dataset ID.
- Pushes a `DeleteMessage` to the `delete_dataset_queue` in Redis.

### `clear_dataset_by_dataset_id_query`
#### Description
Clears a dataset by pushing a `DeleteMessage` with the `empty_dataset` flag set to true to the `delete_dataset_queue` in Redis.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `uuid::Uuid` | The ID of the dataset to clear. |
| `dataset_config` | `DatasetConfiguration` | The configuration of the dataset. |
| `redis_pool` | `web::Data&lt;RedisPool&gt;` | The Redis connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;(), ServiceError&gt;` |  | An error if the clearing failed. |

#### Internal Logic
- Checks if the dataset is locked. If it is, returns a `BadRequest` error.
- Pushes a `DeleteMessage` to the `delete_dataset_queue` in Redis.

### `clear_dataset_query`
#### Description
Clears a dataset by deleting all its associated data from the database and Qdrant.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `uuid::Uuid` | The ID of the dataset to clear. |
| `deleted_at` | `chrono::NaiveDateTime` | The timestamp at which the dataset was deleted. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |
| `event_queue` | `web::Data&lt;EventQueue&gt;` | The event queue for sending events to ClickHouse. |
| `dataset_config` | `DatasetConfiguration` | The configuration of the dataset. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;(), ServiceError&gt;` |  | An error if the clearing failed. |

#### Internal Logic
- Fetches all chunk groups associated with the dataset.
- Deletes all chunk group bookmarks associated with the fetched chunk groups.
- Deletes all fetched chunk groups.
- Deletes all files associated with the dataset.
- Iterates over chunks associated with the dataset in batches, deleting them from the database and Qdrant.
- Sends a `BulkChunksDeleted` event to the event queue for each batch of deleted chunks.

### `delete_dataset_by_id_query`
#### Description
Deletes a dataset from the database and ClickHouse.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `uuid::Uuid` | The ID of the dataset to delete. |
| `deleted_at` | `chrono::NaiveDateTime` | The timestamp at which the dataset was deleted. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |
| `clickhouse_client` | `actix_web::web::Data&lt;clickhouse::Client&gt;` | The ClickHouse client. |
| `event_queue` | `web::Data&lt;EventQueue&gt;` | The event queue for sending events to ClickHouse. |
| `dataset_config` | `DatasetConfiguration` | The configuration of the dataset. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;Dataset, ServiceError&gt;` |  | The deleted dataset or an error if the deletion failed. |

#### Internal Logic
- Calls `clear_dataset_query` to clear the dataset's data.
- Deletes the dataset from the `datasets` table.
- If analytics are enabled, deletes the dataset's events from ClickHouse.

### `update_dataset_query`
#### Description
Updates a dataset in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `id` | `uuid::Uuid` | The ID of the dataset to update. |
| `name` | `String` | The new name of the dataset. |
| `server_configuration` | `DatasetConfiguration` | The new configuration of the dataset. |
| `new_tracking_id` | `Option&lt;String&gt;` | The new tracking ID of the dataset. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;Dataset, ServiceError&gt;` |  | The updated dataset or an error if the update failed. |

#### Internal Logic
- Updates the `datasets` table, setting the new name, configuration, and tracking ID for the given dataset ID.
- Returns a `BadRequest` error if a dataset with the same `tracking_id` already exists in the organization.

### `get_datasets_by_organization_id`
#### Description
Retrieves all datasets associated with an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `org_id` | `web::Path&lt;uuid::Uuid&gt;` | The ID of the organization. |
| `pagination` | `GetDatasetsPagination` | Pagination parameters. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;Vec&lt;DatasetAndUsage&gt;, ServiceError&gt;` |  | A vector of datasets and their usage counts or an error if the retrieval failed. |

#### Internal Logic
- Queries the `datasets` table, joining with the `dataset_usage_counts` table to retrieve the datasets and their usage counts.
- Filters the query based on the given organization ID.
- Applies pagination parameters if provided.
- Returns a `NotFound` error if no datasets are found.

### `get_dataset_usage_query`
#### Description
Retrieves the usage count for a dataset.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `dataset_id` | `uuid::Uuid` | The ID of the dataset. |
| `pool` | `web::Data&lt;Pool&gt;` | The database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;DatasetUsageCount, ServiceError&gt;` |  | The usage count for the dataset or an error if the retrieval failed. |

#### Internal Logic
- Queries the `dataset_usage_counts` table for the usage count of the given dataset ID.
- Returns a `NotFound` error if no usage count is found.

## Dependencies
- `diesel`
- `diesel_async`
- `actix_web`
- `serde`
- `uuid`
- `tracing`
- `redis`

## Error Handling
- Returns `ServiceError::BadRequest` for invalid input or database errors.
- Returns `ServiceError::NotFound` if a dataset or usage count is not found.
- Returns `ServiceError::Forbidden` if the user does not have permission to perform the operation.

## Logging
- Logs errors using the `log` crate.

## Future Improvements
- Implement a mechanism for hard deleting datasets.
- Add support for filtering datasets by name or other criteria.
- Improve error handling by providing more specific error types.
- Add more comprehensive logging to track dataset operations.
- Implement caching to improve performance of dataset