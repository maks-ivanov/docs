---
title: "message_operator.rs"
---

## High-level description
This code defines functions for managing messages within a chat topic, including creating, retrieving, deleting, and regenerating messages. It also handles the integration with OpenAI's chat completion API for generating assistant responses and incorporates RAG (Retrieval-Augmented Generation) functionality for retrieving relevant chunks from a dataset.

## Table of contents
- `get_topic_messages`
- `create_message_query`
- `create_generic_system_message`
- `create_topic_message_query`
- `get_message_by_sort_for_topic_query`
- `get_messages_for_topic_query`
- `delete_message_query`
- `stream_response`
- `get_topic_string`

## References
- `crate::operators::topic_operator::get_topic_query`
- `crate::operators::clickhouse_operator::get_latency_from_header`
- `crate::operators::search_operator::search_hybrid_chunks`
- `crate::operators::clickhouse_operator::EventQueue`
- `crate::operators::clickhouse_operator::ClickHouseEvent`

## Symbols

### `get_topic_messages`
#### Description
Retrieves all messages associated with a specific topic ID and dataset ID from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| messages_topic_id | uuid::Uuid | The ID of the topic. |
| given_dataset_id | uuid::Uuid | The ID of the dataset. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Vec&lt;Message&gt;, ServiceError&gt; |  | A vector of messages associated with the topic, or a ServiceError if an error occurs. |

#### Internal Logic
- Establishes a database connection from the pool.
- Queries the `messages` table, filtering by `topic_id`, `dataset_id`, and `deleted` flag.
- Orders the results by `sort_order` in ascending order.
- Returns the retrieved messages or a `ServiceError::BadRequest` if the query fails.

### `create_message_query`
#### Description
Inserts a new message into the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| new_message | Message | The message object to be inserted. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | Returns Ok(()) if the insertion is successful, or a ServiceError if an error occurs. |

#### Internal Logic
- Establishes a database connection from the pool.
- Inserts the new message into the `messages` table.
- Returns a `ServiceError::BadRequest` if the insertion fails.

### `create_generic_system_message`
#### Description
Creates a generic system message for a given topic.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| system_prompt | String | The system prompt to be used for the message. |
| messages_topic_id | uuid::Uuid | The ID of the topic. |
| dataset_id | uuid::Uuid | The ID of the dataset. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Message, ServiceError&gt; |  | The created system message, or a ServiceError if an error occurs. |

#### Internal Logic
- Retrieves the topic using `crate::operators::topic_operator::get_topic_query`.
- Constructs a `Message` object with the system prompt, topic ID, and other details.

### `create_topic_message_query`
#### Description
Creates a new message within a topic, handling the creation of a system message if it's the first message in the topic.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| config | &DatasetConfiguration | The dataset configuration. |
| previous_messages | Vec&lt;Message&gt; | Existing messages in the topic. |
| new_message | Message | The new message to be created. |
| dataset_id | uuid::Uuid | The ID of the dataset. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Vec&lt;Message&gt;, ServiceError&gt; |  | A vector of messages including the new message and potentially a system message, or a ServiceError if an error occurs. |

#### Internal Logic
- If there are no previous messages, creates a generic system message using `create_generic_system_message` and inserts it into the database.
- Sets the `sort_order` of the new message based on the number of existing messages.
- Inserts the new message into the database using `create_message_query`.
- Returns a vector of messages including the new message and any created system message.

### `get_message_by_sort_for_topic_query`
#### Description
Retrieves a message from the database based on its topic ID, dataset ID, and sort order.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| message_topic_id | uuid::Uuid | The ID of the topic. |
| given_dataset_id | uuid::Uuid | The ID of the dataset. |
| message_sort_order | i32 | The sort order of the message. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Message, ServiceError&gt; |  | The retrieved message, or a ServiceError if an error occurs. |

#### Internal Logic
- Establishes a database connection from the pool.
- Queries the `messages` table, filtering by `topic_id`, `dataset_id`, `sort_order`, and `deleted` flag.
- Returns the first matching message or a `ServiceError::BadRequest` if the message is not found.

### `get_messages_for_topic_query`
#### Description
Retrieves all messages associated with a specific topic ID and dataset ID from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| message_topic_id | uuid::Uuid | The ID of the topic. |
| given_dataset_id | uuid::Uuid | The ID of the dataset. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Vec&lt;Message&gt;, ServiceError&gt; |  | A vector of messages associated with the topic, or a ServiceError if an error occurs. |

#### Internal Logic
- Establishes a database connection from the pool.
- Queries the `messages` table, filtering by `topic_id`, `dataset_id`, and `deleted` flag.
- Orders the results by `sort_order` in ascending order.
- Returns the retrieved messages or a `ServiceError::BadRequest` if the query fails.

### `delete_message_query`
#### Description
Deletes a message from the database by marking it as deleted.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| given_message_id | uuid::Uuid | The ID of the message to be deleted. |
| given_topic_id | uuid::Uuid | The ID of the topic. |
| given_dataset_id | uuid::Uuid | The ID of the dataset. |
| pool | &web::Data&lt;Pool&gt; | A reference to the database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; |  | Returns Ok(()) if the deletion is successful, or a ServiceError if an error occurs. |

#### Internal Logic
- Establishes a database connection from the pool.
- Retrieves the target message from the `messages` table.
- Updates the `deleted` flag to true for all messages in the topic with a `sort_order` greater than or equal to the target message's `sort_order`.
- Returns a `ServiceError::BadRequest` if any of the database operations fail.

### `stream_response`
#### Description
Streams the response from the OpenAI chat completion API, incorporating retrieved chunks from the dataset if RAG is enabled.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| messages | Vec&lt;models::Message&gt; | A vector of messages representing the chat history. |
| topic_id | uuid::Uuid | The ID of the topic. |
| dataset | Dataset | The dataset object. |
| pool | web::Data&lt;Pool&gt; | A reference to the database connection pool. |
| event_queue | web::Data&lt;EventQueue&gt; | A reference to the event queue for sending analytics events. |
| dataset_config | DatasetConfiguration | The dataset configuration. |
| create_message_req_payload | CreateMessageReqPayload | The payload of the create message request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;HttpResponse, actix_web::Error&gt; |  | A streaming HTTP response containing the chat completion, or an actix_web::Error if an error occurs. |

#### Internal Logic
- Extracts the user message query from the chat history.
- Converts the messages to OpenAI's `ChatMessage` format.
- Initializes an OpenAI API client based on the dataset configuration.
- Determines the next message order in the chat history.
- If a search query is provided or the dataset configuration enables HyDE, performs a hybrid chunk search using `crate::operators::search_operator::search_hybrid_chunks`.
- Sends a `SearchQueryEventClickhouse` event to the event queue.
- Extracts chunk metadata and IDs from the search results.
- Constructs the RAG content by concatenating the retrieved chunks.
- Creates a new `ChatMessage` with the RAG content and the user's prompt.
- Updates the last message in the OpenAI messages with the RAG content.
- Constructs `ChatCompletionParameters` for the OpenAI API request, incorporating user-provided LLM options.
- If `stream_response` is false, performs a non-streaming chat completion request and returns the response.
- If `stream_response` is true, performs a streaming chat completion request:
    - Creates an unbounded channel for sending chunks of the response.
    - Spawns an Actix arbiter to handle the completion of the stream:
        - Collects all chunks from the channel.
        - Creates a new `Message` object with the completion content.
        - Sends a `RagQueryEventClickhouse` event to the event queue.
        - Inserts the new message into the database.
    - Creates a stream of chunks from the retrieved chunk metadata.
    - Creates a stream of the completion response from the OpenAI API.
    - Chains the chunk stream and completion stream together, optionally reversing the order based on `completion_first` option.
    - Returns a streaming HTTP response with the chained stream.

### `get_topic_string`
#### Description
Generates a topic name from a given message using OpenAI's chat completion API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| model | String | The OpenAI model to use for generating the topic name. |
| first_message | String | The message to be used as input for generating the topic name. |
| dataset | &Dataset | The dataset object. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;String, ServiceError&gt; |  | The generated topic name, or a ServiceError if an error occurs. |

#### Internal Logic
- Constructs a prompt message for the OpenAI API, asking to generate a topic name from the given message.
- Creates `ChatCompletionParameters` for the OpenAI API request.
- Initializes an OpenAI API client based on the dataset configuration.
- Performs a chat completion request and extracts the generated topic name from the response.
- Returns the generated topic name or a `ServiceError::BadRequest` if the request fails.

## Side Effects
- `create_message_query`, `create_generic_system_message`, `create_topic_message_query`, and `delete_message_query` modify the database state by inserting or updating messages.
- `stream_response` sends analytics events to the event queue and modifies the database state by inserting a new message.

## Error Handling
- Most functions return a `Result` type, indicating potential errors using the `ServiceError` enum.
- Specific error messages are provided in case of database query failures or issues with the OpenAI API.

## Logging
- Uses the `tracing` crate for logging, with log messages at the INFO level.

## Future Improvements
- The code could benefit from more comprehensive error handling, potentially including specific error types for different failure scenarios.
- The `stream_response` function is quite complex and could be refactored into smaller, more manageable functions.
- The use of environment variables for configuration could be replaced with a more