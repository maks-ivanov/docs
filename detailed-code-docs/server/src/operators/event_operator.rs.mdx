---
title: "event_operator.rs"
---

## High-level description
The code defines a function `get_events_query` that retrieves worker events from a Clickhouse database based on provided parameters. It constructs and executes a query to fetch events for a specific dataset, paginates the results, and calculates the total page count.

## Table of contents
- `EventReturn` struct
- `get_events_query` function

## References
- `WorkerEvent` struct from `crate::data::models`
- `WorkerEventClickhouse` struct from `crate::data::models`
- `EventTypeRequest` enum from `crate::data::models`
- `ServiceError` enum from `crate::errors`

## Symbols

### `EventReturn`
#### Description
A struct representing the return value of the `get_events_query` function. It contains a vector of `WorkerEvent` objects and the total page count.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| events | `Vec&lt;WorkerEvent&gt;` | A vector of worker events. |
| page_count | `i32` | The total number of pages of events. |

### `get_events_query`
#### Description
This function retrieves worker events from a Clickhouse database based on the provided parameters. It constructs and executes a query to fetch events for a specific dataset, paginates the results, and calculates the total page count.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | `uuid::Uuid` | The ID of the dataset to retrieve events for. |
| page | `i64` | The page number to retrieve. |
| page_size | `i64` | The number of events per page. |
| event_types | `Vec&lt;EventTypeRequest&gt;` | A vector of event types to filter by. |
| clickhouse_client | `web::Data&lt;clickhouse::Client&gt;` | A Clickhouse client instance. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;EventReturn, ServiceError&gt;` |  | A `Result` containing either an `EventReturn` object with the retrieved events and page count, or a `ServiceError` if an error occurred. |

#### Internal Logic
1. **Construct the query:** The function builds a Clickhouse query string based on the provided parameters. The query selects the `id`, `dataset_id`, `event_type`, `event_data`, and `created_at` columns from the `default.dataset_events` table. It filters the results by `dataset_id` and `event_type`, orders them by `created_at` in descending order, and applies pagination using `LIMIT` and `OFFSET`.
2. **Execute the query:** The function executes the query using the provided Clickhouse client and fetches all results into a vector of `WorkerEventClickhouse` objects.
3. **Map results to `WorkerEvent`:** The function iterates over the retrieved `WorkerEventClickhouse` objects and maps them to `WorkerEvent` objects using the `into()` method.
4. **Calculate the total page count:** The function constructs and executes another Clickhouse query to count the total number of events matching the filter criteria. It divides the count by the `page_size` and rounds up the result to get the total page count.
5. **Return the results:** The function returns an `EventReturn` object containing the retrieved events and the calculated page count.

## Error Handling
The function handles potential errors during query execution by logging the error and returning a `ServiceError::BadRequest` with an appropriate error message.

## Dependencies
- `clickhouse` crate for Clickhouse database interaction.
- `serde` crate for serialization and deserialization.
- `utoipa` crate for generating API documentation.
- `tracing` crate for instrumenting the function for logging and tracing.
- `uuid` crate for generating and parsing UUIDs.
- `actix-web` crate for web framework integration.
- `log` crate for logging.

```
use crate::{
    data::models::{EventTypeRequest, WorkerEvent, WorkerEventClickhouse},
    errors::ServiceError,
};
use actix_web::web;
use serde::{Deserialize, Serialize};
use utoipa::ToSchema;
```