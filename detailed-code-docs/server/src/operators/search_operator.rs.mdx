---
title: "search_operator.rs"
---

Here's a comprehensive explanation of the `search_operator.rs` file:

## High-level description
This file contains the core functionality for performing various types of searches (semantic, full-text, hybrid) over chunks and groups of chunks in a dataset. It implements complex search algorithms, including filtering, sorting, and reranking of search results.

## Table of contents
- Imports and type definitions
- Helper functions for search operations
- Main search functions for chunks and groups
- Recommendation functions for chunks and groups
- Utility functions for parsing queries and handling filters

## Code Structure
The file is organized around several key functions that handle different aspects of the search process. These functions often call each other and share common utility functions for tasks like parsing queries, applying filters, and reranking results.

## Symbols

### assemble_qdrant_filter
#### Description
Constructs a Qdrant filter based on the provided filters, quote words, negated words, and dataset ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| filters | Option&lt;ChunkFilter&gt; | Optional filters to apply to the search |
| quote_words | Option&lt;Vec&lt;String&gt;&gt; | Words that must be present in the results |
| negated_words | Option&lt;Vec&lt;String&gt;&gt; | Words that must not be present in the results |
| dataset_id | uuid::Uuid | The ID of the dataset being searched |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| filter | Result&lt;Filter, ServiceError&gt; | The constructed Qdrant filter |

#### Internal Logic
1. Creates a base filter with the dataset_id condition
2. Processes and adds conditions from the provided filters
3. Adds conditions for quote_words and negated_words
4. Handles special cases like group_tracking_ids and metadata filters

### search_chunks_query
#### Description
Performs a search query on chunks based on the provided parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | SearchChunksReqPayload | The search request payload |
| parsed_query | ParsedQueryTypes | The parsed query |
| pool | web::Data&lt;Pool&gt; | Database connection pool |
| dataset | Dataset | The dataset being searched |
| config | &DatasetConfiguration | Dataset configuration |
| timer | &mut Timer | Timer for performance tracking |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result&lt;SearchChunkQueryResponseBody, actix_web::Error&gt; | The search results |

#### Internal Logic
1. Determines the search type (semantic, full-text, or hybrid)
2. Calls the appropriate search function based on the search type
3. Applies reranking if specified
4. Logs the search event to ClickHouse
5. Formats and returns the results

### search_hybrid_chunks
#### Description
Performs a hybrid search combining semantic and full-text search methods.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | SearchChunksReqPayload | The search request payload |
| parsed_query | ParsedQuery | The parsed query |
| pool | web::Data&lt;Pool&gt; | Database connection pool |
| dataset | Dataset | The dataset being searched |
| config | &DatasetConfiguration | Dataset configuration |
| timer | &mut Timer | Timer for performance tracking |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result&lt;SearchChunkQueryResponseBody, actix_web::Error&gt; | The search results |

#### Internal Logic
1. Performs both semantic and full-text searches
2. Combines and reranks the results
3. Applies cross-encoder reranking if specified
4. Formats and returns the results

### get_recommended_chunks
#### Description
Generates recommendations for chunks based on positive and negative examples.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | web::Json&lt;RecommendChunksRequest&gt; | The recommendation request |
| pool | web::Data&lt;Pool&gt; | Database connection pool |
| event_queue | web::Data&lt;EventQueue&gt; | Event queue for logging |
| api_version | APIVersion | API version for response formatting |
| dataset_org_plan_sub | DatasetAndOrgWithSubAndPlan | Dataset and organization information |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result&lt;HttpResponse, actix_web::Error&gt; | The recommended chunks |

#### Internal Logic
1. Processes positive and negative chunk IDs or tracking IDs
2. Calls the Qdrant recommendation function
3. Retrieves metadata for recommended chunks
4. Logs the recommendation event
5. Formats and returns the results based on API version

## Side Effects
- Logs search and recommendation events to ClickHouse
- Modifies the search results based on reranking and filtering

## Dependencies
- Qdrant for vector search
- ClickHouse for event logging
- OpenAI or custom embedding servers for generating embeddings

## Error Handling
The code uses a custom `ServiceError` type for error handling, which is propagated through the `Result` type. Common error cases include:
- Invalid input parameters
- Database query errors
- External service (Qdrant, embedding servers) communication errors

## Logging
The code uses the `tracing` crate for instrumentation and logging. Key operations and errors are logged for debugging and monitoring purposes.

## Future Improvements
- Optimize the hybrid search algorithm for better performance
- Implement caching for frequently used embeddings or search results
- Enhance the recommendation algorithm with more advanced techniques
- Improve error handling and provide more detailed error messages

The `search_operator.rs` file is a critical component of the search functionality, implementing complex algorithms for semantic, full-text, and hybrid searches. It integrates with various external services and handles a wide range of search scenarios, making it a central piece of the application's search capabilities.