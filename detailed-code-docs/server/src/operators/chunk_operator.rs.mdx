---
title: "chunk_operator.rs"
---

## High-level description
This file contains functions for interacting with the `chunk_metadata` table in the database, including inserting, updating, deleting, and retrieving chunk metadata. It also includes functions for interacting with the Qdrant vector database, such as creating new points, updating points, and searching for points.

## Table of contents
- `get_chunk_metadatas_from_point_ids`
- `get_point_ids_from_unified_chunk_ids`
- `get_chunk_metadatas_and_collided_chunks_from_point_ids_query`
- `get_slim_chunks_from_point_ids_query`
- `get_content_chunk_from_point_ids_query`
- `get_metadata_from_id_query`
- `get_metadata_from_tracking_id_query`
- `get_metadata_from_ids_query`
- `get_metadata_from_tracking_ids_query`
- `bulk_insert_chunk_metadata_query`
- `get_optional_metadata_from_tracking_id_query`
- `insert_chunk_metadata_query`
- `get_dataset_tags_id_from_names`
- `bulk_revert_insert_chunk_metadata_query`
- `update_chunk_metadata_query`
- `delete_chunk_metadata_query`
- `get_qdrant_id_from_chunk_id_query`
- `get_qdrant_ids_from_chunk_ids_query`
- `get_slice_from_vec_string`
- `get_stop_words`
- `get_highlights_with_exact_match`
- `get_highlights`
- `apply_highlights_to_html`
- `get_row_count_for_organization_id_query`
- `create_chunk_metadata`
- `get_pg_point_ids_from_qdrant_point_ids`

## References
- `crate::data::models::{ChunkData, ChunkGroupBookmark, ChunkMetadataTable, ChunkMetadataTags, ChunkMetadataTypes, ContentChunkMetadata, Dataset, DatasetConfiguration, DatasetTags, IngestSpecificChunkMetadata, SlimChunkMetadata, SlimChunkMetadataTable, UnifiedId}`
- `crate::handlers::chunk_handler::UploadIngestionMessage`
- `crate::handlers::chunk_handler::{BulkUploadIngestionMessage, ChunkReqPayload}`
- `crate::operators::group_operator::{check_group_ids_exist_query, get_group_ids_from_tracking_ids_query}`
- `crate::operators::parse_operator::convert_html_to_text`
- `crate::operators::qdrant_operator::{delete_points_from_qdrant, get_qdrant_collection_from_dataset_config}`
- `crate::data::schema::chunk_metadata::dsl`
- `crate::data::schema::chunk_metadata_tags::dsl`
- `crate::data::schema::dataset_tags::dsl`
- `crate::data::schema::chunk_group_bookmarks::dsl`
- `crate::data::schema::organization_usage_counts::dsl`

## Symbols

### `get_chunk_metadatas_from_point_ids`
#### Description
This function retrieves chunk metadata from the database based on a list of Qdrant point IDs. It joins the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables to retrieve the tag set for each chunk.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_ids | `Vec&lt;uuid::Uuid&gt;` | A list of Qdrant point IDs. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;ChunkMetadataTypes&gt;, ServiceError&gt;` | A list of chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Join the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables.
3. Filter the results by the provided Qdrant point IDs.
4. Group the results by chunk ID.
5. Load the results into a vector of `(ChunkMetadataTable, Option&lt;Vec&lt;String&gt;&gt;)` tuples.
6. Convert the tuples into a vector of `ChunkMetadataTypes`.

### `get_point_ids_from_unified_chunk_ids`
#### Description
This function retrieves Qdrant point IDs from the database based on a list of unified chunk IDs. A unified chunk ID can be either a Trieve UUID or a tracking ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk_ids | `Vec&lt;UnifiedId&gt;` | A list of unified chunk IDs. |
| dataset_id | `uuid::Uuid` | The ID of the dataset. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;uuid::Uuid&gt;, ServiceError&gt;` | A list of Qdrant point IDs, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Filter the `chunk_metadata` table by the provided chunk IDs and dataset ID.
3. Select the `qdrant_point_id` column.
4. Load the results into a vector of `uuid::Uuid`.

### `get_chunk_metadatas_and_collided_chunks_from_point_ids_query`
#### Description
This function retrieves chunk metadata and collided chunks from the database based on a list of Qdrant point IDs. It joins the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables to retrieve the tag set for each chunk.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_ids | `Vec&lt;uuid::Uuid&gt;` | A list of Qdrant point IDs. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;ChunkMetadataTypes&gt;, ServiceError&gt;` | A list of chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Join the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables.
3. Filter the results by the provided Qdrant point IDs.
4. Group the results by chunk ID.
5. Load the results into a vector of `(ChunkMetadataTable, Option&lt;Vec&lt;String&gt;&gt;)` tuples.
6. Convert the tuples into a vector of `ChunkMetadataTypes`.

### `get_slim_chunks_from_point_ids_query`
#### Description
This function retrieves slim chunk metadata from the database based on a list of Qdrant point IDs. It joins the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables to retrieve the tag set for each chunk.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_ids | `Vec&lt;uuid::Uuid&gt;` | A list of Qdrant point IDs. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;ChunkMetadataTypes&gt;, ServiceError&gt;` | A list of slim chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Join the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables.
3. Filter the results by the provided Qdrant point IDs.
4. Group the results by chunk ID.
5. Load the results into a vector of `(SlimChunkMetadataTable, Option&lt;Vec&lt;String&gt;&gt;)` tuples.
6. Convert the tuples into a vector of `ChunkMetadataTypes`.

### `get_content_chunk_from_point_ids_query`
#### Description
This function retrieves content chunk metadata from the database based on a list of Qdrant point IDs.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| point_ids | `Vec&lt;uuid::Uuid&gt;` | A list of Qdrant point IDs. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;ChunkMetadataTypes&gt;, ServiceError&gt;` | A list of content chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Filter the `chunk_metadata` table by the provided Qdrant point IDs.
3. Select the relevant columns for content chunk metadata.
4. Load the results into a vector of `ContentChunkMetadata`.
5. Convert the vector into a vector of `ChunkMetadataTypes`.

### `get_metadata_from_id_query`
#### Description
This function retrieves chunk metadata from the database based on a chunk ID and dataset ID. It joins the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables to retrieve the tag set for the chunk.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk_id | `uuid::Uuid` | The ID of the chunk. |
| dataset_id | `uuid::Uuid` | The ID of the dataset. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;ChunkMetadata, ServiceError&gt;` | The chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Join the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables.
3. Filter the results by the provided chunk ID and dataset ID.
4. Group the results by chunk ID.
5. Load the first result into a `(ChunkMetadataTable, Option&lt;Vec&lt;String&gt;&gt;)` tuple.
6. Convert the tuple into a `ChunkMetadata`.

### `get_metadata_from_tracking_id_query`
#### Description
This function retrieves chunk metadata from the database based on a tracking ID and dataset UUID. It joins the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables to retrieve the tag set for the chunk.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tracking_id | `String` | The tracking ID of the chunk. |
| dataset_uuid | `uuid::Uuid` | The UUID of the dataset. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;ChunkMetadata, ServiceError&gt;` | The chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Join the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables.
3. Filter the results by the provided tracking ID and dataset UUID.
4. Group the results by chunk ID.
5. Load the first result into a `(ChunkMetadataTable, Option&lt;Vec&lt;String&gt;&gt;)` tuple.
6. Convert the tuple into a `ChunkMetadata`.

### `get_metadata_from_ids_query`
#### Description
This function retrieves chunk metadata from the database based on a list of chunk IDs and a dataset UUID. It joins the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables to retrieve the tag set for each chunk.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk_ids | `Vec&lt;uuid::Uuid&gt;` | A list of chunk IDs. |
| dataset_uuid | `uuid::Uuid` | The UUID of the dataset. |
| pool | `web::Data&lt;Pool&gt;` | A database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | `Result&lt;Vec&lt;ChunkMetadata&gt;, ServiceError&gt;` | A list of chunk metadata, or a `ServiceError` if the operation fails. |

#### Internal Logic
1. Get a database connection from the pool.
2. Join the `chunk_metadata` table with the `chunk_metadata_tags` and `dataset_tags` tables.
3. Filter the results by the provided chunk IDs and dataset UUID.
4. Group the results by chunk ID.
5. Load the results into a vector of `(ChunkMetadataTable, Option&lt;Vec&lt;String&gt;&gt;)` tuples