---
title: "model_operator.rs"
---

## High-level description
The `model_operator.rs` file contains functions for generating dense and sparse vector embeddings for text data using external embedding services. It also includes a function for cross-encoding chunks using a reranker service.

## Table of contents
- `get_dense_vector`
- `get_sparse_vector`
- `get_dense_vectors`
- `get_sparse_vectors`
- `cross_encoder`
- `get_bm25_embeddings`
- `tokenize`
- `tokenize_batch`
- `term_frequency`

## References
- `DatasetConfiguration` from `crate::data::models`
- `SemanticBoost` and `FullTextBoost` from `crate::handlers::chunk_handler`
- `convert_html_to_text` from `super::parse_operator`

## Symbols

### `get_dense_vector`
#### Description
This function generates a dense vector embedding for a given text message using an external embedding service (OpenAI or Trieve Embedding API). It supports applying a semantic boost to the embedding based on a distance phrase.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| message | String | The text message to embed. |
| distance_phrase | Option&lt;SemanticBoost&gt; | An optional semantic boost to apply to the embedding. |
| embed_type | &str | The type of embedding to generate ("doc" or "query"). |
| dataset_config | DatasetConfiguration | The dataset configuration containing embedding service details. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| embedding_vector | Result&lt;Vec&lt;f32&gt;, ServiceError&gt; | The generated dense vector embedding or an error. |

#### Internal Logic
1. Retrieves the embedding API key and base URL from environment variables or dataset configuration.
2. Clips the message to a maximum length of 20000 characters.
3. Constructs the embedding input based on the `embed_type` and `distance_phrase`.
4. Sends a request to the embedding service with the input and model parameters.
5. Parses the response and extracts the embedding vector.
6. If a `distance_phrase` is provided, applies the semantic boost to the embedding vector.

### `get_sparse_vector`
#### Description
This function generates a sparse vector embedding for a given text message using an external embedding service (Splade).

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| message | String | The text message to embed. |
| embed_type | &str | The type of embedding to generate ("doc" or "query"). |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sparse_vector | Result&lt;Vec&lt;(u32, f32)&gt;, ServiceError&gt; | The generated sparse vector embedding or an error. |

#### Internal Logic
1. Retrieves the embedding server origin from environment variables based on the `embed_type`.
2. Clips the message to a maximum length of 128000 characters.
3. Sends a request to the embedding service with the message and `embed_type`.
4. Parses the response and extracts the sparse vector embedding.

### `get_dense_vectors`
#### Description
This function generates dense vector embeddings for a batch of text messages using an external embedding service (OpenAI or Trieve Embedding API). It supports applying semantic boosts to the embeddings based on distance phrases.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| content_and_distances | Vec&lt;(String, Option&lt;SemanticBoost&gt;)&gt; | A vector of tuples containing the text messages and optional semantic boosts. |
| embed_type | &str | The type of embedding to generate ("doc" or "query"). |
| dataset_config | DatasetConfiguration | The dataset configuration containing embedding service details. |
| reqwest_client | reqwest::Client | A reqwest client for making HTTP requests. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| embedding_vectors | Result&lt;Vec&lt;Vec&lt;f32&gt;&gt;, ServiceError&gt; | A vector of generated dense vector embeddings or an error. |

#### Internal Logic
1. Retrieves the embedding API key and base URL from environment variables or dataset configuration.
2. Splits the input messages into groups of 30.
3. Creates a future for each group to generate embeddings concurrently.
4. Collects the results of the futures and flattens them into a single vector.
5. If semantic boosts are provided, applies them to the corresponding embedding vectors.

### `get_sparse_vectors`
#### Description
This function generates sparse vector embeddings for a batch of text messages using an external embedding service (Splade). It supports applying full-text boosts to the embeddings.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| content_and_boosts | Vec&lt;(String, Option&lt;FullTextBoost&gt;)&gt; | A vector of tuples containing the text messages and optional full-text boosts. |
| embed_type | &str | The type of embedding to generate ("doc" or "query"). |
| reqwest_client | reqwest::Client | A reqwest client for making HTTP requests. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sparse_vectors | Result&lt;Vec&lt;Vec&lt;(u32, f32)&gt;&gt;, ServiceError&gt; | A vector of generated sparse vector embeddings or an error. |

#### Internal Logic
1. Retrieves the embedding server origin from environment variables based on the `embed_type`.
2. Splits the input messages into groups of 30.
3. Creates a future for each group to generate embeddings concurrently.
4. Collects the results of the futures and sorts them by their original index.
5. If full-text boosts are provided, applies them to the corresponding embedding vectors.

### `cross_encoder`
#### Description
This function re-ranks a list of chunks based on their relevance to a given query using a cross-encoder service.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| query | String | The search query. |
| page_size | u64 | The desired number of results. |
| results | Vec&lt;ScoreChunkDTO&gt; | A vector of chunks with scores. |
| dataset_config | &DatasetConfiguration | The dataset configuration containing the reranker service details. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| reranked_chunks | Result&lt;Vec&lt;ScoreChunkDTO&gt;, actix_web::Error&gt; | The re-ranked chunks or an error. |

#### Internal Logic
1. Retrieves the reranker server origin from the dataset configuration.
2. If the number of results is less than or equal to 20, sends a single request to the reranker service.
3. If the number of results is greater than 20, splits the chunks into groups of 20 and sends multiple requests concurrently.
4. Parses the responses and updates the scores of the chunks.
5. Sorts the chunks by their new scores and truncates the list to the desired page size.

### `get_bm25_embeddings`
#### Description
This function generates BM25 embeddings for a batch of text messages.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunks_and_boost | Vec&lt;(String, Option&lt;FullTextBoost&gt;)&gt; | A vector of tuples containing the text messages and optional full-text boosts. |
| avg_len | f32 | The average length of the chunks in the index. |
| b | f32 | The BM25 b parameter. |
| k | f32 | The BM25 k parameter. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| bm25_embeddings | Vec&lt;Vec&lt;(u32, f32)&gt;&gt; | A vector of generated BM25 embeddings. |

#### Internal Logic
1. Tokenizes the input messages using the `tokenize_batch` function.
2. Calculates the term frequencies for each token using the `term_frequency` function.

### `tokenize`
#### Description
This function tokenizes a given text string using a Tantivy text analyzer.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| text | String | The text string to tokenize. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tokens | Vec&lt;String&gt; | A vector of tokens. |

#### Internal Logic
1. Creates a Tantivy text analyzer with a simple tokenizer, filters for removing long tokens and lowercasing, and a stemmer for English.
2. Tokenizes the input text using the analyzer.
3. Collects the tokens into a vector.

### `tokenize_batch`
#### Description
This function tokenizes a batch of text messages using the `tokenize` function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunks | Vec&lt;(String, Option&lt;FullTextBoost&gt;)&gt; | A vector of tuples containing the text messages and optional full-text boosts. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tokenized_chunks | Vec&lt;(Vec&lt;String&gt;, Option&lt;FullTextBoost&gt;)&gt; | A vector of tuples containing the tokenized messages and optional full-text boosts. |

#### Internal Logic
1. Maps over the input chunks and tokenizes each message using the `tokenize` function.

### `term_frequency`
#### Description
This function calculates the term frequencies for a batch of tokenized messages.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| batched_tokens | Vec&lt;(Vec&lt;String&gt;, Option&lt;FullTextBoost&gt;)&gt; | A vector of tuples containing the tokenized messages and optional full-text boosts. |
| avg_len | f32 | The average length of the chunks in the index. |
| b | f32 | The BM25 b parameter. |
| k | f32 | The BM25 k parameter. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| term_frequencies | Vec&lt;Vec&lt;(u32, f32)&gt;&gt; | A vector of term frequencies for each message. |

#### Internal Logic
1. Calculates the raw term frequencies for each token in each message.
2. Calculates the BM25 term frequency for each token using the provided parameters.
3. If a full-text boost is provided, applies it to the term frequencies of the corresponding tokens.

## Side Effects
- `get_dense_vector`, `get_sparse_vector`, `get_dense_vectors`, `get_sparse_vectors`, and `cross_encoder` make HTTP requests to external services.

## Dependencies
- `ureq` for making HTTP requests.
- `openai_dive` for interacting with the OpenAI API.
- `murmur3` for hashing.
- `serde` for serialization and deserialization.
- `tantivy` for text analysis.
- `reqwest` for making HTTP requests.

## Error Handling
The functions return `ServiceError` in case of errors during embedding generation or communication with external services.

## Logging
The functions use `log` for logging errors and debugging information.

## Future Improvements
- Support for additional embedding services and models.
- More robust error handling and logging.
- Optimization of batch embedding generation.
- Implement support for Base64 encoded embeddings.
