---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for updating the database to use built-in `updated_at` functionality. The migration involves two main files: an "up" script to apply the changes and a "down" script to revert them. These scripts modify the timestamp management system for various tables in the database.

## What does it do?
The migration accomplishes the following:

1. In the "up" script:
   - Removes custom triggers and functions previously used for updating timestamps.
   - Introduces new Diesel functions for managing timestamps.
   - Applies these new triggers to specific tables in the database.

2. In the "down" script:
   - Reverts the changes made by the "up" script.
   - Removes the Diesel-managed triggers and functions.
   - Recreates the original custom triggers and functions for managing `updated_at` columns.

This migration essentially transitions the database from a custom timestamp management system to one that utilizes Diesel's built-in functionality, with the ability to roll back if needed.

## Key Files

1. `up.sql`:
   - Drops existing triggers and functions related to timestamp management.
   - Creates new Diesel functions (`diesel_manage_updated_at` and `diesel_set_updated_at`) for managing timestamps.
   - Applies these new functions to specific tables using `SELECT diesel_manage_updated_at` statements.

2. `down.sql`:
   - Drops triggers created by the Diesel functions.
   - Removes Diesel functions introduced in the "up" migration.
   - Recreates custom functions (`update_updated_at` and `update_main_table_updated_at`) for timestamp management.
   - Creates new triggers for various tables using these custom functions.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| PostgreSQL | The database system for which these SQL scripts are written |
| Diesel     | ORM and query builder for Rust, used here for managing database migrations and timestamps |

## Configuration
These migration scripts don't directly use configuration files or environment variables. However, they assume a specific database structure and table names. The affected tables include:

- main_table
- collection_items
- collection_item_versions
- collection_item_version_files
- collection_item_version_file_variants
- collection_item_version_file_variant_data

Ensure that these tables exist in the database before applying the migration.

Code snippets:

1. Creating the Diesel timestamp management function (from `up.sql`):

```sql
CREATE OR REPLACE FUNCTION diesel_manage_updated_at(_tbl regclass) RETURNS VOID AS $$
BEGIN
    EXECUTE format('CREATE TRIGGER set_updated_at BEFORE UPDATE ON %s
                    FOR EACH ROW EXECUTE PROCEDURE diesel_set_updated_at()', _tbl);
END;
$$ LANGUAGE plpgsql;
```

2. Custom function for updating timestamps (from `down.sql`):

```sql
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

These migration scripts provide a robust way to transition between custom and built-in timestamp management systems, ensuring data integrity and consistency across the database.