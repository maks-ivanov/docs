---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for updating the file size tracking mechanism in a database. The scripts are part of a database migration system, likely used to manage changes in the database structure over time. The main focus is on creating and removing a trigger and function that automatically update file storage counts for organizations when files are inserted, updated, or deleted.

## What does it do?
These migration scripts modify the database to implement an automatic file storage tracking system. When a file is added, modified, or deleted in the `files` table, the system automatically updates the total file storage count for the corresponding organization in the `organization_usage_counts` table. This ensures that the organization's file storage usage is always up-to-date without requiring manual calculations or separate update processes.

The "up" migration adds this functionality by creating a new function and trigger, while the "down" migration removes these elements, reverting the database to its previous state.

## Key Files

1. `up.sql`:
   - Creates a function `update_files_storage_counts_with_update()` that calculates and updates file storage counts.
   - Drops any existing trigger and function related to file storage updates.
   - Creates a new trigger `update_files_storage_with_update_trigger` on the `files` table.

2. `down.sql`:
   - Drops the trigger `update_files_storage_with_update_trigger` from the `files` table.
   - Drops the function `update_files_storage_counts_with_update()`.

## Dependencies
The scripts are designed for PostgreSQL and rely on its specific syntax and features, such as:
- Trigger functionality
- PL/pgSQL language for writing functions
- COALESCE function for handling NULL values

## Configuration
These migration scripts don't require explicit configuration. However, they assume the existence of certain tables and structures in the database:

1. `files` table: Contains information about individual files, including their size.
2. `datasets` table: Links files to organizations.
3. `organization_usage_counts` table: Stores aggregated usage data for organizations, including file storage counts.

The scripts use these tables to maintain accurate file storage counts for each organization.

Here's a more detailed explanation of the `update_files_storage_counts_with_update()` function created in the `up.sql` file:

```sql
CREATE OR REPLACE FUNCTION update_files_storage_counts_with_update()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO organization_usage_counts (organization_id, file_storage)
        VALUES (
            (SELECT organization_id FROM datasets WHERE id = NEW.dataset_id),
            NEW.size
        )
        ON CONFLICT (organization_id) DO UPDATE
        SET file_storage = organization_usage_counts.file_storage + NEW.size;
    ELSIF (TG_OP = 'UPDATE') THEN
        UPDATE organization_usage_counts
        SET file_storage = file_storage - OLD.size + NEW.size
        WHERE organization_id = (SELECT organization_id FROM datasets WHERE id = NEW.dataset_id);
    ELSIF (TG_OP = 'DELETE') THEN
        UPDATE organization_usage_counts
        SET file_storage = GREATEST(0, file_storage - OLD.size)
        WHERE organization_id = (SELECT organization_id FROM datasets WHERE id = OLD.dataset_id);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

This function handles three scenarios:

1. When a new file is inserted, it adds the file size to the organization's total file storage.
2. When a file is updated, it adjusts the total by subtracting the old size and adding the new size.
3. When a file is deleted, it subtracts the file size from the total, ensuring the count never goes below zero.

The trigger created in `up.sql` applies this function to the `files` table:

```sql
CREATE TRIGGER update_files_storage_with_update_trigger
AFTER INSERT OR UPDATE OR DELETE ON files
FOR EACH ROW EXECUTE FUNCTION update_files_storage_counts_with_update();
```

This setup ensures that file storage counts are always accurate and up-to-date, providing a reliable way to track organization resource usage without manual intervention.