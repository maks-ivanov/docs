---
title: "up.sql"
---

## High-level description
This SQL script creates a PostgreSQL function and trigger to automatically update the `organization_usage_counts` table whenever files are inserted, updated, or deleted in the `files` table. It ensures that the `file_storage` count for each organization is accurately maintained.

## Table of contents
- Function `update_files_storage_counts_with_update()`
- Dropping old trigger and function
- Creating new trigger `update_files_storage_with_update_trigger`

## Code Structure
The script defines a function `update_files_storage_counts_with_update()` which is then used in a trigger on the `files` table. The function handles INSERT, UPDATE, and DELETE operations, updating the `organization_usage_counts` table accordingly.

## Symbols

### `update_files_storage_counts_with_update()`
#### Description
This function is a trigger function that updates the `file_storage` count in the `organization_usage_counts` table whenever a file is inserted, updated, or deleted in the `files` table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | record | The new row for INSERT/UPDATE operations |
| OLD | record | The old row for UPDATE/DELETE operations |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| TRIGGER | trigger | Returns NEW to allow the operation to proceed |

#### Internal Logic
1. For INSERT operations:
   - Inserts a new row into `organization_usage_counts` with the file size, or updates the existing row if the organization already exists.
2. For UPDATE operations:
   - Updates the `file_storage` count by subtracting the old file size and adding the new file size.
3. For DELETE operations:
   - Decrements the `file_storage` count by the size of the deleted file, ensuring it never goes below zero.

#### Side Effects
- Modifies the `organization_usage_counts` table.
- Reads from the `datasets` table to get the `organization_id`.

### Trigger: `update_files_storage_with_update_trigger`
#### Description
This trigger applies the `update_files_storage_counts_with_update()` function after INSERT, UPDATE, or DELETE operations on the `files` table.

#### Inputs
N/A (Automatically receives row data from the `files` table)

#### Outputs
N/A (Executes the trigger function)

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| PostgreSQL | The database system where this SQL will be executed |

## Future Improvements
1. Consider adding error handling within the function to manage potential issues, such as when the related dataset or organization cannot be found.
2. Optimize the performance by potentially caching the organization_id to reduce the number of subqueries.
3. Add logging or auditing capabilities to track significant changes in file storage usage.
4. Implement a batch update mechanism for scenarios where multiple files are inserted or deleted simultaneously to reduce the number of individual updates to the `organization_usage_counts` table.