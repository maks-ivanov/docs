---
title: "down.sql"
---

## High-level description
This SQL script is designed to undo the changes made in the corresponding `up.sql` file. It recreates the `card_metadata_count` table, initializes it with the current count of rows in the `card_metadata` table, and sets up a trigger to automatically update this count when rows are inserted or deleted from `card_metadata`.

## Table of contents
- Create `card_metadata_count` table
- Insert initial count
- Create trigger function `update_card_metadata_count()`
- Create trigger `card_metadata_count_trigger`

## Code Structure
The script is structured in four main parts, each building on the previous:
1. Table creation
2. Initial data insertion
3. Trigger function definition
4. Trigger creation

## Symbols

### CREATE TABLE card_metadata_count
#### Description
Creates a new table named `card_metadata_count` to store the total number of rows in the `card_metadata` table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Primary key, auto-generated using `gen_random_uuid()` |
| total_rows | BIGINT | Stores the count of rows in `card_metadata` |

### INSERT INTO card_metadata_count
#### Description
Inserts the initial count of rows from the `card_metadata` table into the newly created `card_metadata_count` table.

#### Internal Logic
Uses a subquery to count the rows in `card_metadata` and inserts this value into `card_metadata_count`.

### CREATE OR REPLACE FUNCTION update_card_metadata_count()
#### Description
Defines a trigger function that updates the `total_rows` in `card_metadata_count` when rows are inserted or deleted from `card_metadata`.

#### Internal Logic
- For INSERT operations: Increments `total_rows` by 1
- For DELETE operations: Decrements `total_rows` by 1

### CREATE TRIGGER card_metadata_count_trigger
#### Description
Creates a trigger that automatically calls the `update_card_metadata_count()` function after INSERT or DELETE operations on the `card_metadata` table.

## Side Effects
- Creates a new table in the database
- Adds a new trigger to the `card_metadata` table
- Modifies the `card_metadata_count` table on each INSERT or DELETE operation on `card_metadata`

## Performance Considerations
The trigger on `card_metadata` will slightly impact the performance of INSERT and DELETE operations on this table, as it performs an additional UPDATE operation for each row affected.

## Future Improvements
- Consider adding error handling in the trigger function
- Implement a mechanism to periodically verify and correct the count if it becomes out of sync
- Evaluate if the performance impact of the trigger is acceptable for the application's needs