---
title: "up.sql"
---

## High-level description
This SQL script modifies the existing triggers and functions related to updating chunk metadata counts in a database. It addresses potential null values in the dataset_id and improves the handling of chunk count updates for datasets.

## Table of contents
- Drop existing triggers and function
- Create new `update_chunk_metadata_counts` function
- Create new `increase_chunk_metadata_counts_trigger`
- Create new `delete_chunk_metadata_counts_trigger`

## Code Structure
The script first drops existing triggers and function, then creates a new function `update_chunk_metadata_counts`, and finally creates two new triggers that use this function.

## Symbols

### `update_chunk_metadata_counts()`
#### Description
This function updates the chunk count for a dataset when chunk metadata is inserted or deleted. It handles potential null values in the dataset_id and uses a more robust method to count and update chunk metadata.

#### Inputs
This function doesn't take explicit inputs but uses the `TG_OP` (trigger operation) system variable.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| RETURN | TRIGGER | Always returns NULL |

#### Internal Logic
1. Retrieve the first non-null dataset_id from the `modified` table.
2. If no valid dataset_id is found, return NULL.
3. Count the number of rows in the `modified` table.
4. If the operation is INSERT:
   - Insert or update the chunk count in `dataset_usage_counts`.
5. If the operation is DELETE:
   - Decrease the chunk count in `dataset_usage_counts`.

### `increase_chunk_metadata_counts_trigger`
#### Description
This trigger is executed after an INSERT operation on the `chunk_metadata` table. It calls the `update_chunk_metadata_counts` function to increase the chunk count for the affected dataset.

### `delete_chunk_metadata_counts_trigger`
#### Description
This trigger is executed after a DELETE operation on the `chunk_metadata` table. It calls the `update_chunk_metadata_counts` function to decrease the chunk count for the affected dataset.

## Side Effects
- Modifies the `dataset_usage_counts` table by updating chunk counts.
- Affects the behavior of INSERT and DELETE operations on the `chunk_metadata` table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| chunk_metadata | Table on which triggers are defined |
| dataset_usage_counts | Table where chunk counts are stored |

## Error Handling
The function includes basic error handling by checking for null dataset_id and returning NULL in such cases, preventing further execution.

## Future Improvements
- Consider adding error logging for cases where dataset_id is NULL.
- Implement a mechanism to handle potential race conditions in high-concurrency scenarios.
- Add a check to ensure the chunk count never goes below zero in the DELETE case.