---
title: "Overview"
---

## High-level description
This directory contains database migration scripts related to handling potential null values in the `dataset_id` column when updating chunk metadata counts. The scripts modify triggers and functions responsible for maintaining accurate chunk counts in the `dataset_usage_counts` table.

## What does it do?
The scripts in this directory manage database schema changes related to how chunk counts are updated for datasets. When new chunk metadata is added or removed, these scripts ensure that the corresponding dataset's chunk count is accurately reflected in the `dataset_usage_counts` table. The key improvement introduced is the handling of potential null values in the `dataset_id` column, preventing errors and ensuring data integrity.

The `up.sql` script is designed to be run when applying the migration, while the `down.sql` script reverts the changes, essentially rolling back the migration.

Here's a breakdown of the workflow:

1. **`up.sql` (Migration Application):**
   - Drops existing triggers (`increase_chunk_metadata_counts_trigger`, `delete_chunk_metadata_counts_trigger`) and the associated function (`update_chunk_metadata_counts`).
   - Creates a new `update_chunk_metadata_counts` function that includes logic to handle potential null `dataset_id` values.
   - Creates new triggers (`increase_chunk_metadata_counts_trigger`, `delete_chunk_metadata_counts_trigger`) that utilize the updated function.

2. **`down.sql` (Migration Rollback):**
   - Drops the triggers and function created by the `up.sql` script.
   - Recreates the triggers and function using the previous implementation, which did not include handling for potential null `dataset_id` values.

These scripts ensure that the database schema remains consistent and that chunk counts are accurately maintained even when `dataset_id` values might be null.
