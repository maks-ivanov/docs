---
title: "down.sql"
---

## High-level description
This SQL script is designed to revert changes made in a corresponding `up.sql` file. It removes triggers and functions related to updating chunk metadata counts, and then recreates them with a previous implementation that doesn't handle potential null values in the `dataset_id` column.

## Table of contents
- Drop existing triggers and function
- Create new `update_chunk_metadata_counts` function
- Create `increase_chunk_metadata_counts_trigger`
- Create `delete_chunk_metadata_counts_trigger`

## Code Structure
The script first drops the existing triggers and function, then recreates the function and triggers with a different implementation.

## Symbols

### `update_chunk_metadata_counts()`
#### Description
This function is a trigger function that updates the `chunk_count` in the `dataset_usage_counts` table when chunk metadata is inserted or deleted.

#### Inputs
This function doesn't take explicit inputs but uses the `TG_OP` (trigger operation) system variable.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NULL | NULL | The function always returns NULL |

#### Internal Logic
1. Retrieves the `dataset_id` from the `modified` table.
2. Counts the number of rows in the `modified` table.
3. If the operation is INSERT:
   - Inserts or updates the `chunk_count` in `dataset_usage_counts`.
4. If the operation is DELETE:
   - Decreases the `chunk_count` in `dataset_usage_counts`.

### `increase_chunk_metadata_counts_trigger`
#### Description
This trigger is executed after an INSERT operation on the `chunk_metadata` table.

#### Internal Logic
Calls the `update_chunk_metadata_counts()` function for each statement.

### `delete_chunk_metadata_counts_trigger`
#### Description
This trigger is executed after a DELETE operation on the `chunk_metadata` table.

#### Internal Logic
Calls the `update_chunk_metadata_counts()` function for each statement.

## Side Effects
- Modifies the `dataset_usage_counts` table by updating the `chunk_count` column.
- Affects the behavior of INSERT and DELETE operations on the `chunk_metadata` table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| PostgreSQL | The SQL dialect used is specific to PostgreSQL |

## Error Handling
The script does not implement explicit error handling. It relies on PostgreSQL's default error handling mechanisms.

## Future Improvements
1. Consider adding error handling for cases where `dataset_id` might be NULL.
2. Optimize the function to handle batch operations more efficiently.
3. Add comments to explain the purpose of each trigger and the overall logic of the function.
4. Consider using a more robust method for retrieving the `dataset_id`, as the current method assumes there's always at least one row in the `modified` table.