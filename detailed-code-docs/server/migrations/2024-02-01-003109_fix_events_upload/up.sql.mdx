---
title: "up.sql"
---

## High-level description
This SQL migration script renames a table and updates a function to manage event counts for datasets. It modifies the database structure and behavior related to dataset notifications and event tracking.

## Table of contents
- Table renaming
- Function replacement

## Symbols

### Table Renaming
#### Description
Renames the `dataset_notification_counts` table to `dataset_event_counts`.

#### Internal Logic
Uses the `ALTER TABLE` command to change the table name.

### `update_notification_count()` Function
#### Description
A PostgreSQL trigger function that updates the event count for a dataset when notifications are inserted or deleted.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | record | The new row for INSERT operations |
| OLD | record | The old row for DELETE operations |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | record | The new row (returned unchanged) |

#### Internal Logic
1. For INSERT operations:
   - Inserts a new record into `dataset_event_counts` with the dataset UUID and a count of 1
   - If a record already exists, increments the `notification_count` by 1
2. For DELETE operations:
   - Decrements the `notification_count` by 1 for the corresponding dataset UUID

## Side Effects
- Modifies the database schema by renaming a table
- Alters the behavior of notification counting for datasets

## Performance Considerations
The function uses an upsert operation (`INSERT ... ON CONFLICT ... DO UPDATE`) for efficient handling of both new and existing records.

## Future Improvements
- Consider adding error handling for cases where the `notification_count` might become negative
- Evaluate if additional operations (e.g., UPDATE) need to be handled in the trigger function
- Consider adding logging or auditing capabilities to track changes in notification counts