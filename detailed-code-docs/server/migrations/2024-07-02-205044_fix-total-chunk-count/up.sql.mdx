---
title: "up.sql"
---

## High-level description
This SQL migration script updates the `organization_usage_counts` table to ensure accurate and consistent chunk count data. It also implements a trigger mechanism to automatically update the organization's chunk count when changes occur in the `dataset_usage_counts` table.

## Table of contents
- Update `chunk_count` column in `organization_usage_counts`
- Alter `chunk_count` column to set NOT NULL constraint
- Update `chunk_count` based on related `dataset_usage_counts`
- Create function `update_organization_chunk_count()`
- Create trigger `update_organization_chunk_count_trigger`

## Code Structure
The script performs several operations on the `organization_usage_counts` table and creates a function and trigger to maintain data consistency. The main components are interconnected, with the trigger calling the function to update the `organization_usage_counts` table whenever changes occur in the `dataset_usage_counts` table.

## Symbols

### Update `chunk_count` column
#### Description
This operation sets the `chunk_count` to 0 for any NULL values in the `organization_usage_counts` table.

#### Internal Logic
```sql
UPDATE organization_usage_counts
SET chunk_count = 0
WHERE chunk_count IS NULL;
```

### Alter `chunk_count` column
#### Description
This operation modifies the `chunk_count` column in the `organization_usage_counts` table to enforce a NOT NULL constraint.

#### Internal Logic
```sql
ALTER TABLE organization_usage_counts
ALTER COLUMN chunk_count SET NOT NULL;
```

### Update `chunk_count` based on related `dataset_usage_counts`
#### Description
This operation updates the `chunk_count` in the `organization_usage_counts` table by summing the `chunk_count` values from related `dataset_usage_counts`.

#### Internal Logic
```sql
UPDATE organization_usage_counts o
SET chunk_count = (
    SELECT COALESCE(SUM(duc.chunk_count), 0)
    FROM dataset_usage_counts duc
    JOIN datasets d ON d.id = duc.dataset_id
    WHERE d.organization_id = o.org_id
);
```

### Function: `update_organization_chunk_count()`
#### Description
This function updates the `chunk_count` in the `organization_usage_counts` table based on the sum of `chunk_count` values from related `dataset_usage_counts`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | trigger | The new row in `dataset_usage_counts` that triggered the function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | trigger | The same NEW row, returned as required by trigger functions |

#### Internal Logic
1. Update the `chunk_count` in `organization_usage_counts` for the affected organization.
2. Calculate the sum of `chunk_count` from `dataset_usage_counts` for datasets belonging to the organization.
3. Use a subquery to determine the organization ID based on the dataset ID in the NEW row.

```sql
CREATE OR REPLACE FUNCTION update_organization_chunk_count() RETURNS TRIGGER AS $$
BEGIN
    UPDATE organization_usage_counts o
    SET chunk_count = (
        SELECT COALESCE(SUM(duc.chunk_count), 0)
        FROM dataset_usage_counts duc
        JOIN datasets d ON d.id = duc.dataset_id
        WHERE d.organization_id = o.org_id
    )
    WHERE o.org_id = (
        SELECT d.organization_id
        FROM datasets d
        WHERE d.id = NEW.dataset_id
    );
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### Trigger: `update_organization_chunk_count_trigger`
#### Description
This trigger calls the `update_organization_chunk_count()` function after INSERT, UPDATE, or DELETE operations on the `dataset_usage_counts` table.

#### Internal Logic
```sql
CREATE TRIGGER update_organization_chunk_count_trigger
AFTER INSERT OR UPDATE OR DELETE ON dataset_usage_counts
FOR EACH ROW
EXECUTE FUNCTION update_organization_chunk_count();
```

## Side Effects
- Modifies data in the `organization_usage_counts` table.
- Creates a new function and trigger in the database.

## Performance Considerations
- The trigger may impact performance on high-frequency updates to the `dataset_usage_counts` table.
- The function performs a sum operation across potentially large datasets, which could be slow for organizations with many datasets.

## Future Improvements
- Consider adding indexes on `organization_id` in the `datasets` table and `org_id` in the `organization_usage_counts` table to improve query performance.
- Implement error handling in the `update_organization_chunk_count()` function to manage potential exceptions.
- Consider batching updates or using materialized views for very large datasets to improve performance.