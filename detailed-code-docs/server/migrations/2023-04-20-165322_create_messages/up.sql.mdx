---
title: "up.sql"
---

## High-level description
This SQL script creates a `messages` table in a database, designed to store conversation messages with associated metadata such as topic, role, and token counts. It's part of a database migration, likely for a chatbot or conversational AI application.

## Table of contents
- Table creation
- Column definitions
- Constraints and references

## Code Structure
The code consists of a single SQL statement that creates the `messages` table with various columns and constraints.

## Symbols

### `messages` table
#### Description
The `messages` table is designed to store individual messages in a conversation system. It includes fields for message content, metadata, and relationships to other entities (like topics).

#### Columns
| Name | Type | Constraints | Description |
|:-----|:-----|:------------|:------------|
| id | UUID | NOT NULL, UNIQUE, PRIMARY KEY | Unique identifier for each message |
| topic_id | UUID | NOT NULL, REFERENCES topics(id) | Foreign key linking to the associated topic |
| sort_order | INT | NOT NULL | Determines the order of messages within a topic |
| content | TEXT | NOT NULL | The actual content of the message |
| role | VARCHAR(10) | NOT NULL, DEFAULT 'assistant', CHECK | The role of the message sender (system, user, or assistant) |
| deleted | BOOLEAN | NOT NULL, DEFAULT FALSE | Flag to mark messages as deleted |
| prompt_tokens | INT | DEFAULT 0 | Number of tokens in the prompt (likely for AI models) |
| completion_tokens | INT | DEFAULT 0 | Number of tokens in the completion (likely for AI models) |
| created_at | TIMESTAMP | NOT NULL | Timestamp of message creation |
| updated_at | TIMESTAMP | NOT NULL | Timestamp of last message update |

#### Constraints
- The `id` column is set as the primary key and must be unique.
- The `topic_id` column references the `id` column in the `topics` table, establishing a foreign key relationship.
- The `role` column is restricted to values 'system', 'user', or 'assistant' using a CHECK constraint.

## Dependencies
This migration script depends on the existence of a `topics` table, as it references it in the `topic_id` foreign key.

## Future Improvements
- Consider adding an index on `topic_id` for faster querying of messages by topic.
- If message searching is a frequent operation, consider adding a full-text search index on the `content` column.
- Depending on the application's needs, you might want to add a `parent_id` column to represent threaded conversations.