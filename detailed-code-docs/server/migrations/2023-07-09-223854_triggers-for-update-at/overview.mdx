---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for managing database schema changes related to automatic timestamp updates. The scripts introduce and revert changes to tables, functions, and triggers responsible for maintaining `created_at` and `updated_at` timestamps.

## What does it do?
The `up.sql` script modifies the database schema to automatically track when records are created and modified. It adds timestamp columns to the `card_verification` table and creates database functions and triggers to automatically populate these timestamps. The `down.sql` script reverses these changes, removing the added columns, functions, and triggers.

## Key Files
### 2023-07-09-223854_triggers-for-update-at/up.sql
This script performs the following actions:

1. **Adds timestamp columns to `card_verification` table:**
   ```sql
   ALTER TABLE card_verification
   ADD COLUMN created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
   ADD COLUMN updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW();
   ```
2. **Creates the `update_updated_at()` function:**
   This function updates the `updated_at` column of a row to the current timestamp whenever that row is modified.
   ```sql
   CREATE FUNCTION update_updated_at()
   RETURNS TRIGGER AS $$
   BEGIN
     NEW.updated_at = current_timestamp;
     RETURN NEW;
   END;
   $$ language 'plpgsql';
   ```
3. **Creates the `update_main_table_updated_at()` function:**
   This function updates the `updated_at` column of a "main" table whenever a related record in another table is modified. This ensures that the timestamp in the main table reflects the most recent change, even if it occurs in a related table.
   ```sql
   -- Example usage, assuming 'main_table' and 'collection_id' are defined elsewhere
   UPDATE main_table SET updated_at = current_timestamp WHERE id = NEW.collection_id;
   ```
4. **Creates triggers for multiple tables:**
   These triggers automatically execute the `update_updated_at()` or `update_main_table_updated_at()` functions before an update operation on the specified tables.

### 2023-07-09-223854_triggers-for-update-at/down.sql
This script undoes the changes made by `up.sql`:

1. **Removes the `created_at` and `updated_at` columns from the `card_verification` table.**
2. **Drops the `update_updated_at()` and `update_main_table_updated_at()` functions.**
3. **Drops the triggers created by `up.sql` from all affected tables.**
