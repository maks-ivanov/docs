---
title: "up.sql"
---

## High-level description
This SQL migration script adds timestamp columns and creates triggers to automatically update the `updated_at` column for various tables in a database. It also includes a special trigger for updating the `updated_at` column in a main table when related records are modified.

## Table of contents
- Add timestamp columns to `card_verification` table
- Create `update_updated_at` function
- Create `update_main_table_updated_at` function
- Create triggers for multiple tables

## Code Structure
The script defines two functions: `update_updated_at` and `update_main_table_updated_at`. These functions are then used in triggers applied to various tables in the database.

## Symbols

### ALTER TABLE card_verification
#### Description
Adds `created_at` and `updated_at` timestamp columns to the `card_verification` table.

#### Internal Logic
- Adds `created_at` column with `NOT NULL` constraint and default value of `NOW()`
- Adds `updated_at` column with `NOT NULL` constraint and default value of `NOW()`

### update_updated_at()
#### Description
A PostgreSQL function that updates the `updated_at` column of a row to the current timestamp.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | trigger | The new row data in the trigger |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | trigger | The modified row data with updated timestamp |

#### Internal Logic
Sets the `updated_at` column of the NEW row to the current timestamp using `current_timestamp`.

### update_main_table_updated_at()
#### Description
A PostgreSQL function that updates the `updated_at` column of the `main_table` based on changes in a related table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | trigger | The new row data in the trigger |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NEW | trigger | The unmodified row data |

#### Internal Logic
Updates the `updated_at` column of the `main_table` where the `id` matches the `collection_id` of the triggering row.

### CREATE TRIGGER statements
#### Description
Creates triggers for various tables to automatically update the `updated_at` column when a row is modified.

#### Internal Logic
- Creates a `BEFORE UPDATE` trigger for each specified table
- Executes the `update_updated_at()` function for most tables
- Executes the `update_main_table_updated_at()` function for the `card_collection_bookmarks` table

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| PostgreSQL | The database system for which this SQL script is written |

## Future Improvements
- Consider adding index on `updated_at` columns for tables where frequent querying by this field is expected
- Evaluate the performance impact of the `update_main_table_updated_at` trigger, especially if the `main_table` is large or frequently updated
- Consider adding similar `created_at` and `updated_at` columns to other tables that don't have them yet, for consistency across the database schema