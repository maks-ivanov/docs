---
title: "down.sql"
---

## High-level description
This SQL script is designed to revert the changes made in the corresponding `up.sql` migration. It removes newly created tables, triggers, and functions related to dataset and organization usage counts, and recreates the original `chunk_metadata_counts` table along with its associated function.

## Table of contents
- Drop triggers
- Drop functions
- Drop new tables
- Recreate chunk_metadata_counts table
- Create update_chunk_metadata_count function

## Code Structure
The script is structured to systematically remove new elements and then recreate the original table and function. It uses SQL commands to drop triggers, functions, and tables, and then uses CREATE statements to rebuild the original structure.

## Symbols

### DROP TRIGGER Statements
#### Description
These statements remove triggers that were likely created in the `up.sql` migration.

#### Internal Logic
- Removes the `update_dataset_counts_trigger` from the `dataset_usage_counts` table
- Removes the `update_organization_counts_trigger` from the `organization_usage_counts` table

### DROP FUNCTION Statements
#### Description
These statements remove functions that were likely created in the `up.sql` migration.

#### Internal Logic
- Removes the `update_dataset_counts()` function
- Removes the `update_organization_counts()` function

### DROP TABLE Statements
#### Description
These statements remove tables that were likely created in the `up.sql` migration.

#### Internal Logic
- Removes the `dataset_usage_counts` table
- Removes the `organization_usage_counts` table

### CREATE TABLE Statement
#### Description
This statement recreates the `chunk_metadata_counts` table, which was likely dropped or modified in the `up.sql` migration.

#### Internal Logic
- Creates a table named `chunk_metadata_counts` with columns:
  - `id`: UUID, primary key with default value generated by `gen_random_uuid()`
  - `dataset_id`: UUID, not null, foreign key referencing `datasets(id)`
  - `total_rows`: BIGINT, not null

### CREATE OR REPLACE FUNCTION Statement
#### Description
This statement recreates the `update_chunk_metadata_count()` function, which was likely dropped or modified in the `up.sql` migration.

#### Inputs
The function is a trigger function and doesn't take explicit inputs. It operates on the `NEW` and `OLD` pseudo-records provided by the trigger context.

#### Outputs
The function returns a trigger (implicitly, by returning NULL).

#### Internal Logic
- For INSERT operations:
  - Inserts a new record into `card_metadata_counts` with the new dataset_id and a count of 1
  - If a record already exists for the dataset_id, it updates the count by adding 1
- For DELETE operations:
  - Updates the `card_metadata_counts` table, decrementing the count by 1 for the corresponding dataset_id

## Side Effects
- Removes triggers, functions, and tables related to dataset and organization usage counts
- Recreates the `chunk_metadata_counts` table and its associated function, potentially overwriting any existing data or structure

## Future Improvements
- Consider adding error handling or checks to ensure the operations are performed only if the objects exist
- The function name `update_chunk_metadata_count()` doesn't match the table name `card_metadata_counts`. This inconsistency should be resolved
- The INSERT operation in the function uses `card_metadata_count` in the UPDATE clause, which doesn't match the column name `total_rows`. This should be corrected
- The function could be optimized to handle both INSERT and UPDATE operations in a single upsert statement