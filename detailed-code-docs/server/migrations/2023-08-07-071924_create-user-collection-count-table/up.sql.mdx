---
title: "up.sql"
---

## High-level description
This SQL script creates a new table to track user collection counts and implements a trigger to automatically update these counts when collections are added or removed. It also initializes the table with existing data.

## Table of contents
- Create `user_collection_counts` table
- Define `update_collection_counts()` function
- Create `update_collection_counts_trigger`
- Initialize `user_collection_counts` with existing data

## Code Structure
The script creates a table, defines a function, creates a trigger, and performs an initial data population. The trigger uses the function to maintain the collection counts.

## Symbols

### `user_collection_counts` table
#### Description
This table stores the count of collections for each user.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Primary key, auto-generated |
| user_id | UUID | Foreign key referencing users table |
| collection_count | INTEGER | Number of collections for the user |

### `update_collection_counts()` function
#### Description
This function updates the `user_collection_counts` table when collections are added or deleted.

#### Internal Logic
1. For INSERT operations:
   - Insert a new record or increment the count if the user already exists
2. For DELETE operations:
   - Decrement the count for the user

### `update_collection_counts_trigger` trigger
#### Description
This trigger executes the `update_collection_counts()` function after INSERT, UPDATE, or DELETE operations on the `card_collection` table.

## Side Effects
- Automatically maintains the collection count for each user in the `user_collection_counts` table.
- Affects the `card_collection` table indirectly through the trigger.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| users table | Referenced by `user_id` in `user_collection_counts` |
| card_collection table | Source of data for collection counts |

## Future Improvements
1. Consider adding error handling in the `update_collection_counts()` function to manage edge cases.
2. Optimize the initial data population query for large datasets.
3. Add a check to prevent negative collection counts in case of data inconsistencies.