---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for adding scope limits to API keys in a database. The migration introduces two new columns, `dataset_ids` and `organization_ids`, to the `user_api_key` table, allowing for more granular control over API key access to specific datasets and organizations.

## What does it do?
These migration scripts modify the database structure to enhance API key functionality. They add the ability to associate specific datasets and organizations with each API key, thereby limiting the scope of what each key can access. This is useful for implementing more fine-grained access control in the application.

The "up" migration adds two new columns to the `user_api_key` table:
1. `dataset_ids`: An array of text values representing dataset identifiers that the API key can access.
2. `organization_ids`: An array of text values representing organization identifiers that the API key can access.

The "down" migration provides the ability to revert these changes by removing these columns if they exist.

## Key Files
1. `up.sql`: This file contains the SQL commands to add the new columns to the `user_api_key` table.
2. `down.sql`: This file contains the SQL commands to remove the newly added columns, effectively reverting the changes made by the up migration.

## Configuration
The migration uses SQL commands and doesn't require additional configuration. However, it's important to note that:

- Both new columns (`dataset_ids` and `organization_ids`) are defined as `TEXT[]` arrays with a default value of `NULL`.
- The `down.sql` script uses `IF EXISTS` clauses to prevent errors if the columns don't exist when trying to drop them.

Here's a breakdown of the new columns:

| Column Name | Data Type | Default Value | Description |
|-------------|-----------|---------------|-------------|
| dataset_ids | TEXT[] | NULL | Array of dataset identifiers the API key can access |
| organization_ids | TEXT[] | NULL | Array of organization identifiers the API key can access |

## Future Improvements
Several potential improvements could be considered for future iterations:

1. Add check constraints to ensure the values in `dataset_ids` and `organization_ids` are valid and exist in their respective tables.
2. Implement indexes on these new columns if they will be frequently used in queries, to improve performance.
3. If a large number of datasets or organizations per API key is expected, consider creating separate junction tables instead of using arrays to normalize the data structure.
4. Implement a backup mechanism before dropping columns in the down migration to prevent unintended data loss.
5. If these columns are part of any indexes or constraints, ensure those are handled appropriately in both up and down migrations.

By implementing these scope limits, the application gains more control over API key access, enhancing security and allowing for more precise permission management at the dataset and organization level.