---
title: "up.sql"
---

## High-level description
This SQL migration script modifies the `user_api_key` table by adding a new column for BLAKE3 hashing and making the existing API key hash column nullable. This change is likely aimed at improving the performance of API key operations.

## Table of contents
- Add `blake3_hash` column to `user_api_key` table
- Modify `api_key_hash` column to allow NULL values

## Symbols

### ALTER TABLE user_api_key ADD COLUMN blake3_hash TEXT;
#### Description
This SQL statement adds a new column named `blake3_hash` of type TEXT to the `user_api_key` table.

#### Internal Logic
- The `ALTER TABLE` command is used to modify the existing `user_api_key` table.
- `ADD COLUMN` specifies that a new column is being added.
- `blake3_hash` is the name of the new column.
- `TEXT` is the data type of the new column, allowing for storage of variable-length character strings.

### ALTER TABLE user_api_key ALTER COLUMN api_key_hash DROP NOT NULL;
#### Description
This SQL statement modifies the `api_key_hash` column in the `user_api_key` table to allow NULL values.

#### Internal Logic
- The `ALTER TABLE` command is used to modify the existing `user_api_key` table.
- `ALTER COLUMN` specifies that an existing column is being modified.
- `api_key_hash` is the name of the column being altered.
- `DROP NOT NULL` removes the NOT NULL constraint, allowing the column to contain NULL values.

## Future Improvements
1. Consider adding an index on the `blake3_hash` column if it will be frequently used in queries, to improve lookup performance.
2. Implement a data migration script to populate the `blake3_hash` column with values based on existing data, if necessary.
3. Update application code to use the new `blake3_hash` column for API key verification instead of the `api_key_hash` column.
4. After confirming that the `blake3_hash` column is fully operational and all necessary data has been migrated, consider removing the `api_key_hash` column in a future migration to clean up the database schema.