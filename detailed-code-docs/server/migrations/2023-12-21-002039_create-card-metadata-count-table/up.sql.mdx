---
title: "up.sql"
---

## High-level description
This SQL script creates a table to store card metadata counts for datasets and implements a trigger function to automatically update these counts when card metadata is inserted or deleted.

## Table of contents
- Creation of `card_metadata_counts` table
- Definition of `update_card_metadata_count()` function
- Creation of `card_metadata_count_trigger`

## Code Structure
The script defines a table, a function, and a trigger that work together to maintain an up-to-date count of card metadata for each dataset.

## Symbols

### `card_metadata_counts` table
#### Description
This table stores the total count of card metadata rows for each dataset.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Primary key, auto-generated |
| dataset_id | UUID | Foreign key referencing datasets table |
| total_rows | BIGINT | Total number of card metadata rows for the dataset |

### `update_card_metadata_count()` function
#### Description
This function is a trigger function that updates the `card_metadata_counts` table when card metadata is inserted or deleted.

#### Internal Logic
1. For INSERT operations:
   - Inserts a new row into `card_metadata_counts` or updates the existing row, incrementing the `total_rows` count.
2. For DELETE operations:
   - Updates the `card_metadata_counts` table, decrementing the `total_rows` count.

### `card_metadata_count_trigger`
#### Description
This trigger executes the `update_card_metadata_count()` function after INSERT or DELETE operations on the `card_metadata` table.

## Side Effects
- Automatically updates the `card_metadata_counts` table when card metadata is inserted or deleted.
- Maintains an up-to-date count of card metadata for each dataset.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| datasets table | Referenced by `card_metadata_counts` table |
| card_metadata table | Trigger is applied to this table |

## Error Handling
The script does not implement explicit error handling. It relies on PostgreSQL's built-in error handling mechanisms.

## Future Improvements
- Consider adding error handling or logging within the trigger function.
- Implement a mechanism to handle potential race conditions in high-concurrency scenarios.
- Add an UPDATE trigger to handle cases where the `dataset_id` of a card metadata entry might change.