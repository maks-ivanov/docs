---
title: "up.sql"
---

## High-level description
This SQL migration script modifies the `card_metadata` table by adding a `private` column, making the `qdrant_point_id` column nullable, and introducing a constraint to ensure data integrity based on the privacy status of a card.

## Table of contents
- Add `private` column to `card_metadata`
- Make `qdrant_point_id` nullable
- Add CHECK constraint

## Symbols

### ALTER TABLE card_metadata ADD COLUMN private BOOLEAN NOT NULL DEFAULT false;
#### Description
This statement adds a new column named `private` to the `card_metadata` table. The column is of type BOOLEAN, cannot be null, and has a default value of false.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| card_metadata | table | The existing table to be altered |

#### Outputs
The `card_metadata` table is modified with a new `private` column.

### ALTER TABLE card_metadata ALTER COLUMN qdrant_point_id DROP NOT NULL;
#### Description
This statement modifies the `qdrant_point_id` column in the `card_metadata` table, removing the NOT NULL constraint and making it nullable.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| card_metadata | table | The existing table to be altered |

#### Outputs
The `qdrant_point_id` column in the `card_metadata` table becomes nullable.

### ALTER TABLE card_metadata ADD CONSTRAINT qdrant_point_nullable_constraint CHECK (private = true OR qdrant_point_id IS NOT NULL);
#### Description
This statement adds a CHECK constraint named `qdrant_point_nullable_constraint` to the `card_metadata` table. The constraint ensures that either the `private` column is true or the `qdrant_point_id` is not null.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| card_metadata | table | The existing table to be altered |

#### Outputs
A new CHECK constraint is added to the `card_metadata` table.

## Side Effects
1. Existing rows in the `card_metadata` table will have their `private` column set to false (the default value).
2. The `qdrant_point_id` column becomes nullable, potentially allowing NULL values where it previously did not.
3. The new constraint may cause INSERT or UPDATE operations to fail if they violate the condition (i.e., trying to set a non-private card with a NULL `qdrant_point_id`).

## Future Improvements
1. Consider adding an index on the `private` column if it will be frequently used in queries.
2. If many cards are expected to be private, consider changing the default value of the `private` column to true.
3. Depending on the application's needs, consider adding a migration script to update existing data to comply with the new constraint.