---
title: "up.sql"
---

## High-level description
This SQL migration script modifies the structure of notification-related tables, moving from a user-centric to a dataset-centric approach. It alters existing tables, renames a table, and updates a trigger function to reflect these changes.

## Table of contents
- Alter `file_upload_completed_notifications` table
- Rename `user_notification_counts` table
- Modify `dataset_notification_counts` table
- Update `update_notification_count()` function

## Code Structure
The script consists of a series of SQL statements that modify database tables and a function. The statements are executed sequentially to transform the database schema.

## Symbols

### ALTER TABLE file_upload_completed_notifications
#### Description
Removes the `user_uuid` column from the `file_upload_completed_notifications` table.

#### Internal Logic
```sql
ALTER TABLE file_upload_completed_notifications DROP COLUMN user_uuid;
```

### ALTER TABLE user_notification_counts RENAME TO dataset_notification_counts
#### Description
Renames the `user_notification_counts` table to `dataset_notification_counts`.

#### Internal Logic
```sql
ALTER TABLE user_notification_counts RENAME TO dataset_notification_counts;
```

### ALTER TABLE dataset_notification_counts
#### Description
Modifies the `dataset_notification_counts` table by adding a `dataset_uuid` column and removing the `user_uuid` column.

#### Internal Logic
```sql
ALTER TABLE dataset_notification_counts ADD COLUMN dataset_uuid uuid;
ALTER TABLE dataset_notification_counts DROP COLUMN user_uuid;
```

### CREATE OR REPLACE FUNCTION update_notification_count()
#### Description
Updates the `update_notification_count()` function to work with the new dataset-centric approach.

#### Inputs
The function is a trigger function, so it implicitly works with the `NEW` and `OLD` pseudo-records representing the rows being inserted or deleted.

#### Outputs
The function returns a trigger.

#### Internal Logic
1. For INSERT operations:
   - Inserts a new record into `dataset_notification_counts` with the dataset_uuid and a count of 1
   - If a record already exists, it increments the notification_count
2. For DELETE operations:
   - Decrements the notification_count for the corresponding dataset_uuid

```sql
CREATE OR REPLACE FUNCTION update_notification_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO dataset_notification_counts (id, dataset_uuid, notification_count)
        VALUES (NEW.id, NEW.dataset_uuid, 1)
        ON CONFLICT (dataset_uuid) DO UPDATE
        SET notification_count = dataset_notification_counts.notification_count + 1;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE dataset_notification_counts
        SET notification_count = notification_count - 1
        WHERE user_uuid = OLD.dataset_uuid;
    END IF;
    RETURN NEW;
END;
$function$
;
```

## Side Effects
- The `file_upload_completed_notifications` table loses its `user_uuid` column.
- The `user_notification_counts` table is renamed and its structure is changed.
- The `update_notification_count()` function is modified to work with datasets instead of users.

## Future Improvements
1. The DELETE operation in the `update_notification_count()` function uses `user_uuid` instead of `dataset_uuid`. This should be corrected to:
   ```sql
   WHERE dataset_uuid = OLD.dataset_uuid;
   ```
2. Consider adding appropriate indexes on the `dataset_uuid` column in the `dataset_notification_counts` table to improve query performance.
3. Implement a data migration strategy to populate the new `dataset_uuid` column with appropriate values from existing data, if necessary.
4. Review and update any application code or other database objects (views, functions, etc.) that may be affected by these schema changes.
5. Consider adding constraints (e.g., NOT NULL) to the `dataset_uuid` column if it's meant to be a required field.