---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for managing a database schema related to card datasets. The scripts are designed to create and remove a 'datasets' table, as well as add and remove 'dataset_id' columns from several existing tables related to card metadata, collections, and bookmarks.

## What does it do?
These migration scripts modify the database structure to introduce a new concept of 'datasets' into the existing card-based system. The 'up' migration creates a new table to store dataset information and adds references to this table in other related tables. The 'down' migration reverses these changes, removing the dataset table and its references from the system.

Here's a breakdown of the workflow:

1. The 'up' migration:
   - Creates a new 'datasets' table with columns for id, name, creation time, and update time.
   - (Implied) Adds 'dataset_id' columns to 'card_metadata', 'card_collection', and 'card_collection_bookmarks' tables.

2. The 'down' migration:
   - Removes the 'datasets' table.
   - Removes 'dataset_id' columns from 'card_metadata', 'card_collection', and 'card_collection_bookmarks' tables.

These changes allow the system to associate cards, collections, and bookmarks with specific datasets, enabling better organization and categorization of data within the application.

## Key Files

1. `up.sql`:
   - Creates the 'datasets' table with UUID primary key, name, and timestamp columns.
   - Uses PostgreSQL functions like `gen_random_uuid()` and `NOW()` for automatic value generation.

2. `down.sql`:
   - Drops the 'datasets' table.
   - Removes 'dataset_id' columns from 'card_metadata', 'card_collection', and 'card_collection_bookmarks' tables.
   - Uses 'IF EXISTS' clauses for idempotent execution.

## Dependencies
The migration scripts rely on PostgreSQL-specific functions:
- `gen_random_uuid()`: Used to generate unique identifiers for datasets.
- `NOW()`: Used to set default timestamps for creation and update times.

## Configuration
The migration scripts don't require explicit configuration. However, they assume the existence of certain tables ('card_metadata', 'card_collection', 'card_collection_bookmarks') in the database schema. The database connection details should be configured in the application's database configuration file.

Here's an example of the 'datasets' table structure created by the 'up' migration:

```sql
CREATE TABLE datasets (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

This table structure allows for efficient storage and retrieval of dataset information, with automatic generation of unique identifiers and timestamps.

The 'down' migration script uses a series of SQL commands to revert the changes:

```sql
DROP TABLE IF EXISTS datasets;
ALTER TABLE card_metadata DROP COLUMN IF EXISTS dataset_id;
ALTER TABLE card_collection DROP COLUMN IF EXISTS dataset_id;
ALTER TABLE card_collection_bookmarks DROP COLUMN IF EXISTS dataset_id;
```

These commands ensure that all changes made by the 'up' migration are completely reversed, returning the database schema to its previous state.

For future improvements, consider:
1. Adding indexes to the 'datasets' table for frequently queried columns.
2. Implementing versioning for datasets if required.
3. Adding additional columns to the 'datasets' table for more detailed information.
4. Using transactions in the migration scripts to ensure atomic execution of all operations.
5. Adding comments to explain the purpose of each operation for better maintainability.

These migration scripts provide a solid foundation for integrating dataset functionality into the existing card-based system, allowing for more sophisticated data organization and management.