---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for creating and managing a `card_metadata_count` table in a database. The purpose of this table is to maintain an accurate count of rows in the `card_metadata` table. The directory includes two SQL scripts: an "up" script for creating the necessary database objects and a "down" script for rolling back these changes.

## What does it do?
The scripts in this directory set up a system to automatically track the number of rows in the `card_metadata` table. Here's how it works:

1. A new table called `card_metadata_count` is created to store the total number of rows in the `card_metadata` table.
2. An initial count is inserted into this new table based on the current number of rows in `card_metadata`.
3. A trigger function is created that updates the count in `card_metadata_count` whenever rows are inserted or deleted from `card_metadata`.
4. A trigger is set up on the `card_metadata` table to call this function after each insert or delete operation.

If these changes need to be undone, the "down" script removes all the created objects in reverse order.

## Key Files

1. `up.sql`:
   - Creates the `card_metadata_count` table with columns for `id` (UUID) and `total_rows` (BIGINT).
   - Inserts the initial count of rows from `card_metadata`.
   - Creates a trigger function `update_card_metadata_count()` to update the count.
   - Sets up a trigger `card_metadata_count_trigger` on the `card_metadata` table.

   Example of the trigger function:
   ```sql
   CREATE OR REPLACE FUNCTION update_card_metadata_count()
   RETURNS TRIGGER AS $$
   BEGIN
     IF (TG_OP = 'INSERT') THEN
       UPDATE card_metadata_count SET total_rows = total_rows + 1;
     ELSIF (TG_OP = 'DELETE') THEN
       UPDATE card_metadata_count SET total_rows = total_rows - 1;
     END IF;
     RETURN NULL;
   END;
   $$ LANGUAGE plpgsql;
   ```

2. `down.sql`:
   - Drops the `card_metadata_count_trigger` from the `card_metadata` table.
   - Drops the `update_card_metadata_count()` function.
   - Drops the `card_metadata_count` table.

## Dependencies
These scripts depend on the existence of a `card_metadata` table in the database. They use PostgreSQL-specific features such as:
- `gen_random_uuid()` function for generating UUIDs
- PL/pgSQL language for writing the trigger function

## Configuration
No specific configuration files or environment variables are used in these scripts. However, the database connection details and migration execution would typically be managed by an external tool or application.

## Future Improvements
1. Error handling: Add error handling in the trigger function to manage potential race conditions or concurrent updates.
2. Periodic verification: Implement a mechanism to periodically verify and correct the count if it becomes out of sync with the actual number of rows in `card_metadata`.
3. Support for UPDATE operations: Add support for UPDATE operations if they can affect the row count (e.g., if updates can result in row deletions).
4. Timestamp tracking: Consider adding a timestamp column to `card_metadata_count` to track when the count was last updated.
5. Data preservation: In the "down" script, consider adding a data export step before dropping the `card_metadata_count` table if there's data that needs to be preserved.

These improvements would enhance the robustness and utility of the row counting mechanism, making it more resilient to potential issues and providing additional useful information.