---
title: "push-clickhouse.yml"
---

## High-level description
This GitHub Actions workflow automates the process of building and pushing a Docker image for ClickHouse whenever changes are pushed to the `analytics/clickhouse/` directory in the `main` branch. It leverages various GitHub Actions to streamline the workflow.

## Table of contents
- Setting up the environment
- Building and pushing the image

## References
This workflow references the following resources:
- `trieve/clickhouse` Docker image (used as the base image)
- `analytics/clickhouse/Dockerfile` (used to build the ClickHouse image)
- GitHub Secrets: `DOCKER_USERNAME` and `DOCKER_PASSWORD` (used for Docker Hub authentication)

## Symbols
### `name: Create Clickhouse image`
#### Description
Defines the name of the workflow as "Create Clickhouse image".

### `concurrency`
#### Description
This section configures concurrent workflow runs. It ensures that only one workflow run is active for the same workflow and branch combination, canceling any in-progress runs.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| group | string | `${{ github.workflow }}-${{ github.head_ref }}` - combines the workflow name and branch name to create a unique concurrency group. |
| cancel-in-progress | boolean | `true` - cancels any currently running workflow within the same concurrency group. |

### `on`
#### Description
Specifies the events that trigger the workflow.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| workflow_dispatch | event | Allows the workflow to be triggered manually from the GitHub Actions tab. |
| push | event | Triggers the workflow on push events to the repository. |
| branches | string | `main` - specifies that the workflow should only be triggered on pushes to the `main` branch. |
| paths | string | `analytics/clickhouse/**` - further filters push events to only trigger when there are changes within the `analytics/clickhouse/` directory. |

### `jobs`
#### Description
Defines a job named `clickhouse_image` that runs on a `blacksmith-2vcpu-ubuntu-2204` runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| clickhouse_image | job | Represents the job to build and push the ClickHouse Docker image. |
| runs-on | string | `blacksmith-2vcpu-ubuntu-2204` - specifies the type of runner to use for this job. |

### `steps`
#### Description
A sequence of steps that are executed within the `clickhouse_image` job.

#### Internal Logic
1. **Checkout the repo:** Checks out the repository's code using the `actions/checkout@v4` action.
2. **Setup buildx:** Sets up the Docker Buildx tool using the `docker/setup-buildx-action@v3` action.
3. **Login to Docker Hub:** Logs in to Docker Hub using the provided credentials from GitHub Secrets (`DOCKER_USERNAME` and `DOCKER_PASSWORD`) using the `docker/login-action@v3` action.
4. **Docker meta:** Uses the `docker/metadata-action@v5` action to generate Docker image tags based on the `trieve/clickhouse` base image and applies the `type=raw,latest` tag. The generated tags are stored in the `steps.meta.outputs.tags` variable.
5. **Build and push Docker image:** Builds and pushes the Docker image using the `docker/build-push-action@v5` action. It uses the following settings:
    - `context`: `analytics/clickhouse/` - specifies the build context directory.
    - `file`: `./analytics/clickhouse/Dockerfile` - specifies the path to the Dockerfile.
    - `push`: `true` - enables pushing the built image to Docker Hub.
    - `tags`: `${{ steps.meta.outputs.tags }}` - uses the generated tags from the `docker/metadata-action@v5` step.
    - `labels`: `${{ steps.meta.outputs.labels }}` - applies labels from the `docker/metadata-action@v5` step to the image.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| actions/checkout@v4 | Checks out the repository's code. |
| docker/setup-buildx-action@v3 | Sets up Docker Buildx. |
| docker/login-action@v3 | Logs in to Docker Hub. |
| docker/metadata-action@v5 | Generates Docker image tags and labels. |
| docker/build-push-action@v5 | Builds and pushes the Docker image. |

## Future Improvements
- Consider adding a step to test the built Docker image before pushing it to Docker Hub.
- Explore using a dedicated build cache to speed up subsequent builds.
- Investigate using a more secure method for storing and accessing Docker Hub credentials, such as OpenID Connect (OIDC).
