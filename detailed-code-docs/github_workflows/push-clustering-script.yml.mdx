---
title: "push-clustering-script.yml"
---

## High-level description
This GitHub Actions workflow automates the process of building and pushing a Docker image for a ClickHouse clustering script whenever changes are pushed to the `docker/clustering-script/` directory in the `main` branch. The workflow leverages buildx for efficient multi-platform builds and pushes the image to Docker Hub.

## Table of contents
- **Concurrency**
- **Triggers**
- **Jobs**
  - **build_clustering_script**
    - **Checkout the repo**
    - **Setup buildx**
    - **Login to Docker Hub**
    - **Docker meta**
    - **Build and push Docker image**

## References
This workflow references the following secrets stored in the GitHub repository:
- `DOCKER_USERNAME`
- `DOCKER_PASSWORD`

## Symbols
### `name: Create Clickhouse Clustering Script`
#### Description
Defines the name of the workflow as it appears in the GitHub Actions interface.

### `concurrency`
#### Description
This section configures concurrent workflow runs. It ensures that only one workflow run is active for the same workflow and branch combination. If a new run is triggered while a previous one is still in progress, the previous run will be canceled.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| group | string | `${{ github.workflow }}-${{ github.head_ref }}` - combines the workflow name and branch name to create a unique concurrency group. |
| cancel-in-progress | boolean | `true` - indicates that any previous runs within the same concurrency group should be canceled when a new run starts. |

### `on`
#### Description
Specifies the events that trigger the workflow.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| workflow_dispatch | event | Allows the workflow to be triggered manually from the GitHub Actions interface. |
| push | event | Triggers the workflow on push events to the repository. |
| branches | string array | `['main']` - specifies that the workflow should only be triggered on pushes to the `main` branch. |
| paths | string array | `['docker/clustering-script/**']` - filters push events to only trigger the workflow when files within the `docker/clustering-script/` directory are modified. |

### `jobs`
#### Description
Defines the jobs that run within the workflow.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| build_clustering_script | job | A job that builds and pushes the Docker image for the ClickHouse clustering script. |

### `build_clustering_script`
#### Description
This job builds and pushes the Docker image for the ClickHouse clustering script.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| name | string | `Push Clustering Script` - the name of the job as displayed in the GitHub Actions interface. |
| runs-on | string | `blacksmith-2vcpu-ubuntu-2204` - specifies the type of runner to use for this job. |
| steps | array | A sequence of steps that are executed as part of the job. |

### `steps`
#### Description
A sequence of steps that are executed as part of the `build_clustering_script` job.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| name | string | The name of the step as displayed in the GitHub Actions interface. |
| uses | string | Specifies an action to be used for this step. |
| with | object | Inputs for the action being used. |

### `Checkout the repo`
#### Description
This step checks out the repository's code onto the runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| uses | string | `actions/checkout@v4` - uses the official GitHub Actions checkout action to check out the repository. |

### `Setup buildx`
#### Description
This step sets up the Docker Buildx tool, which is used for building multi-platform Docker images.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| uses | string | `docker/setup-buildx-action@v3` - uses the official Docker setup-buildx action to set up Buildx. |

### `Login to Docker Hub`
#### Description
This step logs into Docker Hub using the provided credentials.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| uses | string | `docker/login-action@v3` - uses the official Docker login action to log into Docker Hub. |
| username | string | `${{ secrets.DOCKER_USERNAME }}` - retrieves the Docker Hub username from the repository's secrets. |
| password | string | `${{ secrets.DOCKER_PASSWORD }}` - retrieves the Docker Hub password from the repository's secrets. |

### `Docker meta`
#### Description
This step generates metadata for the Docker image, including tags and labels.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | string | `meta` - assigns an ID to this step so its outputs can be referenced by other steps. |
| uses | string | `docker/metadata-action@v5` - uses the official Docker metadata action to generate image metadata. |
| images | string array | `['trieve/clickhouse-clustering']` - specifies the base name for the Docker image tag. |
| tags | string array | `['type=raw,latest', 'type=sha']` - defines the tags to be applied to the Docker image. |

### `Build and push Docker image`
#### Description
This step builds and pushes the Docker image to Docker Hub.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| uses | string | `docker/build-push-action@v5` - uses the official Docker build-push action to build and push the image. |
| context | string | `docker/clustering-script/` - specifies the build context directory. |
| file | string | `./docker/clustering-script/Dockerfile` - specifies the path to the Dockerfile. |
| push | boolean | `true` - indicates that the image should be pushed to the registry. |
| tags | string | `${{ steps.meta.outputs.tags }}` - retrieves the generated tags from the `Docker meta` step. |
| labels | string | `${{ steps.meta.outputs.labels }}` - retrieves the generated labels from the `Docker meta` step. |

## Dependencies
This workflow utilizes the following GitHub Actions:
| Dependency | Purpose |
|:-----------|:--------|
| actions/checkout@v4 | Checks out the repository's code. |
| docker/setup-buildx-action@v3 | Sets up Docker Buildx for multi-platform builds. |
| docker/login-action@v3 | Logs into Docker Hub. |
| docker/metadata-action@v5 | Generates Docker image metadata. |
| docker/build-push-action@v5 | Builds and pushes the Docker image. |

## Future Improvements
- The workflow could be enhanced to build and push images for multiple architectures by uncommenting and configuring the `platforms` input in the `Build and push Docker image` step.
- Consider adding a step to verify the integrity and functionality of the built Docker image before pushing it to Docker Hub. This could involve running tests or linting the clustering script within the container. 
