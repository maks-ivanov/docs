---
title: "push-collapse-query-script.yml"
---

## High-level description
This GitHub Actions workflow automates the building and pushing of a Docker image for a ClickHouse search query collapsing script. It triggers on pushes to the 'main' branch and specifically targets changes within the 'docker/collapse-query-script/**' path.

## Table of contents
- **Trigger**: Defines the events that initiate the workflow.
- **Jobs**: Defines a single job named `build_collapse_query_script`.
  - **Steps**: A sequence of actions performed within the job.

## References
This workflow references the following secrets:
- `DOCKER_USERNAME`: Docker Hub username.
- `DOCKER_PASSWORD`: Docker Hub password.

## Symbols
### `name: Create Clickhouse Search Query Collapsing Script`
#### Description
Defines the name of the workflow as it appears in the GitHub Actions interface.

### `concurrency`
#### Description
Configures concurrency for this workflow to prevent simultaneous runs from the same branch. It uses a combination of the workflow name and the head reference for grouping.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| group | string | `${{ github.workflow }}-${{ github.head_ref }}` - Workflow name and head reference for grouping. |
| cancel-in-progress | boolean | `true` - Cancels any in-progress workflow runs that fall within the same concurrency group. |

### `on`
#### Description
Specifies the events that trigger this workflow.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| workflow_dispatch | event | Allows manual triggering of the workflow. |
| push | event | Triggers the workflow on push events to the 'main' branch and changes within the 'docker/collapse-query-script/**' path. |

### `jobs`
#### Description
Defines a collection of jobs that run in parallel.

### `build_collapse_query_script`
#### Description
A job named `build_collapse_query_script` that handles building and pushing the Docker image.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| name | string | `Push Collapse Query Script` - The name of the job. |
| runs-on | string | `blacksmith-2vcpu-ubuntu-2204` - Specifies the runner type to use for this job. |
| steps | list | A sequence of actions performed within the job. |

### `steps`
#### Description
A list of actions performed sequentially within the `build_collapse_query_script` job.

#### Internal Logic
1. **Checkout the repo**: Checks out the repository's code using the `actions/checkout@v4` action.
2. **Setup buildx**: Sets up the Docker Buildx tool using the `docker/setup-buildx-action@v3` action.
3. **Login to Docker Hub**: Logs in to Docker Hub using provided credentials from the `DOCKER_USERNAME` and `DOCKER_PASSWORD` secrets.
4. **Docker meta**: Generates Docker image tags and labels using the `docker/metadata-action@v5` action.
5. **Build and push Docker image**: Builds and pushes the Docker image to Docker Hub using the `docker/build-push-action@v5` action. It uses the generated tags and labels from the previous step.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| actions/checkout@v4 | Checks out the repository's code. |
| docker/setup-buildx-action@v3 | Sets up Docker Buildx. |
| docker/login-action@v3 | Logs in to Docker Hub. |
| docker/metadata-action@v5 | Generates Docker image metadata. |
| docker/build-push-action@v5 | Builds and pushes Docker images. |

## Future Improvements
- The workflow currently targets a specific runner type (`blacksmith-2vcpu-ubuntu-2204`). Consider using a more generic runner label or allowing users to configure the runner type.
- The Docker image tagging strategy could be enhanced to include additional metadata, such as the Git commit SHA or build number.
- Explore options for caching dependencies or build artifacts to speed up subsequent workflow runs.
- Add error handling and notifications to provide better feedback on workflow execution.
