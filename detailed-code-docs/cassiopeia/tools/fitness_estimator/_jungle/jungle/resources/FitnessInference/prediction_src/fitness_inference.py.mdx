---
title: "fitness_inference.py"
---

## High-level description

The `fitness_inference.py` file provides a class, `fitness_inference`, which is designed to perform fitness inference on a given phylogenetic tree. This class extends the `survival_gen_func` class from the `solve_survival` module. The main functionality of this class is to propagate fitness values up and down the tree using a message-passing framework, ultimately calculating the posterior fitness distribution, mean posterior fitness, and its variance for each node in the tree.

## Code Structure

The `fitness_inference` class is the primary symbol in this file. It inherits from the `survival_gen_func` class, which is presumably defined in the `solve_survival` module. The class is responsible for setting up the tree, propagating fitness values, and calculating various fitness-related metrics for the nodes in the tree.

## References

- `survival_gen_func`: The `fitness_inference` class inherits from this class, which is imported from the `solve_survival` module. This indicates that `fitness_inference` relies on the functionality provided by `survival_gen_func`.

## Symbols

### `fitness_inference`
#### Description
The `fitness_inference` class is designed to perform fitness inference on a phylogenetic tree. It calculates the posterior fitness distribution, mean posterior fitness, and variance for each node in the tree using a message-passing framework.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| eps_branch_length | float | A small value added to each branch to avoid zero branch length exceptions. |
| D | float | Diffusion constant parameterizing how fitness changes over time. |
| fit_grid | list or None | Discrete fitness grid on which all fitness distributions are calculated. |
| samp_frac | float | Sampling fraction. |
| mem | float | Memory parameter used in calculations. |

#### Outputs
The class does not have a direct output but modifies the input tree to include fitness-related attributes.

#### Internal Logic
- **Initialization**: Sets up the fitness grid, boundary layer, and other parameters. Initializes the parent class `survival_gen_func`.
- **Tree Setup**: The `set_tree` method initializes the tree, setting up nodes with fitness-related attributes and calculating time scales.
- **Message Passing**: Methods like `calc_down_messages`, `calc_up_messages`, and `calc_marginal_probabilities` propagate fitness information through the tree.
- **Fitness Calculation**: Methods like `calc_mean_and_variance` compute the mean and variance of fitness distributions at each node.

## Side Effects
- Modifies the input tree by adding attributes related to fitness inference, such as `prob`, `down_message`, `up_message`, `mean_fitness`, and `var_fitness`.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `numpy` | Used for numerical operations, such as creating arrays and performing mathematical calculations. |
| `solve_survival` | Provides the `survival_gen_func` class, which `fitness_inference` inherits from. |

## Error Handling
The code includes basic error handling, such as checking for `NaN` values in probability distributions and printing warnings if encountered.

## Logging
The code includes some print statements for debugging purposes, particularly when encountering unexpected conditions like missing fitness shifts.

## TODOs
There are no explicit TODOs or notes left in the code.