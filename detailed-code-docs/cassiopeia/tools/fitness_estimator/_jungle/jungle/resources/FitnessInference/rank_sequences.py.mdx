---
title: "rank_sequences.py"
---

## High-level description

The `rank_sequences.py` script is designed to perform fitness inference on sequences within a multiple sequence alignment. It processes the alignment data, identifies an outgroup, and applies a prediction algorithm to rank sequences based on inferred fitness. The results, including reconstructed trees and sequence rankings, are output to a directory named with the current date and time.

## Code Structure

The script is structured to first parse command-line arguments, then read and process sequence alignment data, and finally perform fitness inference and output the results. The main components include argument parsing, file handling, sequence alignment processing, prediction algorithm execution, and result output.

## References

- `sequence_ranking`: This module is used to perform the prediction and ranking of sequences.
- `tree_utils`: This module is used for plotting the prediction tree if the plot option is enabled.

## Symbols

### `ofunc`
#### Description
A utility function to open files, choosing between gzip and regular open based on the file extension.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| fname | str | The name of the file to open. |
| mode | str | The mode in which to open the file (e.g., 'r' for read). |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| file object | file-like object | A file object opened in the specified mode. |

#### Internal Logic
- Checks if the file name ends with `.gz` to determine if it should use `gzip.open`.
- Otherwise, uses the standard `open` function.

### `alignment`
#### Description
This function (or class) is assumed to process the sequence alignment and prepare it for the prediction algorithm. It is not defined in the target file but is crucial for setting up the sequence data.

### `sequence_ranking`
#### Description
This function (or class) is responsible for performing the fitness inference and ranking the sequences. It is not defined in the target file but is central to the script's functionality.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `argparse` | For parsing command-line arguments. |
| `matplotlib` | For plotting trees if the plot option is enabled. |
| `numpy` | Likely used for numerical operations within the prediction algorithm. |
| `Bio` (from Biopython) | For handling sequence alignments and phylogenetic trees. |

## Configuration

| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| `--aln` | str | None | Name of the alignment file in fasta format. |
| `--outgroup` | str | None | Name of the outgroup sequence in the alignment file. |
| `--eps_branch` | float | 1e-5 | Minimal branch length for inference. |
| `--tau` | float | 0.0625 | Time scale for local tree length estimation. |
| `--collapse` | bool | True | Collapse internal branches with identical sequences. |
| `--plot` | bool | False | Plot trees if set. |

## Error Handling

- The script checks if the outgroup is present in the alignment file and exits with a message if it is not found.

## Logging

- The script prints a message indicating the time scale `tau` being used, which is a part of the configuration for the prediction algorithm.

## Side Effects

- The script creates a directory named with the current date and time to store output files.
- It writes several output files, including reconstructed trees and sequence rankings, to this directory.

## Performance Considerations

- The script processes potentially large sequence alignments and performs computationally intensive predictions, which may impact performance depending on the size of the input data.

## TODOs

- There are no explicit TODOs or notes left in the code.