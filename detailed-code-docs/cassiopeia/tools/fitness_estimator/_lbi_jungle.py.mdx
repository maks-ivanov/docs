---
title: "_lbi_jungle.py"
---

## High-level description

The code in the target file implements a fitness estimator called `LBIJungle`, which is a wrapper around the Jungle package for estimating the fitness of nodes in a phylogenetic tree. The `LBIJungle` class extends the `FitnessEstimator` class and uses the Local Branching Index (LBI) method to estimate fitness values for nodes in a tree, except for the root node. The code also includes a utility function `_to_newick` to convert a networkx graph representation of a tree into a Newick string format.

## Code Structure

The main components of the code are the `LBIJungle` class and the `_to_newick` function. The `LBIJungle` class is responsible for estimating fitness values using the Jungle package, while the `_to_newick` function is a utility to convert a tree from a networkx graph to a Newick string, which is a common format for representing tree structures.

## References

- `CassiopeiaTree`: A class from the `cassiopeia.data` module that represents a phylogenetic tree and provides methods for manipulating and querying the tree structure.
- `FitnessEstimator` and `FitnessEstimatorError`: Base class and error class from the `cassiopeia.tools.fitness_estimator` module, which `LBIJungle` extends and uses for error handling.

## Symbols

### `_to_newick`
#### Description
Converts a networkx directed graph (DiGraph) representing a tree into a Newick string format. The Newick format is a way of representing tree structures with nested parentheses.

#### Inputs
| Name                | Type      | Description                                                                 |
|:--------------------|:----------|:----------------------------------------------------------------------------|
| `tree`              | `nx.DiGraph` | A networkx directed graph representing the tree structure.                  |
| `record_branch_lengths` | `bool`    | Whether to include branch lengths in the Newick string representation.      |

#### Outputs
| Name         | Type   | Description                                      |
|:-------------|:-------|:-------------------------------------------------|
| `newick_str` | `str`  | A Newick string representing the tree topology.  |

#### Internal Logic
- The function identifies the root node of the tree.
- It recursively constructs the Newick string by traversing the tree from the root, appending child nodes in parentheses, and optionally including branch lengths.

### `LBIJungle`
#### Description
A class that implements the Local Branching Index (LBI) fitness estimator using the Jungle package. It estimates the fitness of nodes in a phylogenetic tree, excluding the root node.

#### Inputs
| Name         | Type          | Description                                                                 |
|:-------------|:--------------|:----------------------------------------------------------------------------|
| `random_seed`| `Optional[int]` | A random seed for reproducibility in the LBI estimation process.            |

#### Outputs
- None (The class modifies the input tree by setting fitness attributes for each node).

#### Internal Logic
- The constructor initializes the random seed if provided.
- The `estimate_fitness` method:
  - Checks for invalid leaf names (those starting with an underscore) and raises an error if found.
  - Converts the tree to a Newick string and writes it to a temporary file.
  - Uses the Jungle package to read the Newick string, annotate node features, and infer fitness values.
  - Updates the input `CassiopeiaTree` with the estimated fitness values for each node.

## Side Effects
- The `estimate_fitness` method modifies the input `CassiopeiaTree` by setting a `fitness` attribute for each node, except the root.

## Dependencies
| Dependency | Purpose                                                                 |
|:-----------|:------------------------------------------------------------------------|
| `networkx` | Used for representing and manipulating the tree structure as a graph.   |
| `numpy`    | Used for setting the random seed for reproducibility.                   |
| `jungle`   | A package used to perform the LBI fitness estimation.                   |

## Error Handling
- The `estimate_fitness` method raises a `FitnessEstimatorError` if any leaf names start with an underscore or if the tree cannot be serialized to a Newick string.

## TODOs
- None