---
title: "ClonalSpatialDataSimulator.py"
---

## High-level description

The `ClonalSpatialDataSimulator` class is a specialized simulator for generating spatial data with a clonal spatial autocorrelation constraint. It extends the `SpatialDataSimulator` class and is designed to simulate spatial coordinates for cells in a `CassiopeiaTree`, ensuring that subclones are spatially localized together. The simulator assigns spatial coordinates to cells such that subclones are more likely to be spatially autocorrelated, using techniques like Delaunay triangulation and nearest neighbors graph construction to enforce spatial constraints.

## Code Structure

The `ClonalSpatialDataSimulator` class is the main symbol in this file, inheriting from `SpatialDataSimulator`. It utilizes several static and class methods to perform its tasks, including graph construction and point sampling. The class interacts with the `CassiopeiaTree` class to overlay spatial data onto a tree structure, and it relies on external libraries like `networkx`, `numpy`, `pandas`, and `scipy` for its operations.

## References

- `CassiopeiaTree`: Used to represent the tree structure onto which spatial data is overlaid.
- `DataSimulatorError`: An exception class used for error handling within the simulator.
- `try_import`: A utility function used to conditionally import modules.

## Symbols

### `ClonalSpatialDataSimulator`
#### Description
The `ClonalSpatialDataSimulator` class simulates spatial data with a clonal spatial autocorrelation constraint. It ensures that subclones in a `CassiopeiaTree` are spatially localized together by assigning spatial coordinates to cells based on their tree structure.

#### Inputs
| Name       | Type               | Description                                                                 |
|:-----------|:-------------------|:----------------------------------------------------------------------------|
| shape      | Optional[Tuple[int, ...]] | The shape of the space to place cells on, e.g., (100, 100) for a 2D surface. |
| space      | Optional[np.ndarray] | A mask representing the space where cells may be placed.                     |
| random_seed| Optional[int]      | A seed for reproducibility.                                                  |

#### Outputs
The class does not return outputs directly but modifies the `CassiopeiaTree` by overlaying spatial data.

#### Internal Logic
- **Initialization**: Validates the presence of required modules and ensures that either `shape` or `space` is provided. Initializes the spatial mask based on the provided shape or space.
- **Graph Construction**: Uses Delaunay triangulation or nearest neighbors to construct graphs from points, ensuring spatial connectivity.
- **Point Sampling**: Samples points within the defined space using Poisson-Disc sampling to ensure approximately equally-spaced points.
- **Data Overlay**: Overlays spatial data onto a `CassiopeiaTree` by assigning sampled points to tree nodes, ensuring spatial autocorrelation of subclones.

### `__triangulation_graph`
#### Description
Computes a fully-connected Delaunay triangulation graph from a set of points.

#### Inputs
| Name   | Type         | Description          |
|:-------|:-------------|:---------------------|
| points | np.ndarray   | Points to triangulate |

#### Outputs
| Name | Type     | Description          |
|:-----|:---------|:---------------------|
| G    | nx.Graph | Networkx graph       |

#### Internal Logic
- Constructs a Delaunay triangulation using `scipy.spatial.Delaunay`.
- Adds paths to a Networkx graph and assigns edge weights based on Euclidean distances.

### `__nearest_neighbors_graph`
#### Description
Computes the nearest neighbors graph from a set of points.

#### Inputs
| Name   | Type         | Description               |
|:-------|:-------------|:--------------------------|
| points | np.ndarray   | Point coordinates         |
| k      | int          | Number of nearest neighbors |

#### Outputs
| Name | Type     | Description          |
|:-----|:---------|:---------------------|
| G    | nx.Graph | Networkx graph       |

#### Internal Logic
- Uses `sklearn.neighbors.kneighbors_graph` to compute distances and constructs a Networkx graph from the resulting sparse array.

### `__points_to_graph`
#### Description
Constructs a connected graph from a set of points, using Delaunay triangulation or nearest neighbors based on the number of points.

#### Inputs
| Name   | Type         | Description          |
|:-------|:-------------|:---------------------|
| points | np.ndarray   | Points               |

#### Outputs
| Name | Type     | Description          |
|:-----|:---------|:---------------------|
| G    | nx.Graph | Networkx graph       |

#### Internal Logic
- Chooses between Delaunay triangulation and nearest neighbors based on the number of points, favoring Delaunay for larger sets due to performance.

### `__split_graph`
#### Description
Generates a node partition of exact sizes from a graph.

#### Inputs
| Name   | Type     | Description                        |
|:-------|:---------|:-----------------------------------|
| G      | nx.Graph | Graph to partition                 |
| sizes  | Tuple[int, ...] | Tuple of integers indicating the partition sizes |

#### Outputs
| Name | Type           | Description                        |
|:-----|:---------------|:-----------------------------------|
| partitions | Tuple[List[int], ...] | Node partition as a tuple of lists of integers |

#### Internal Logic
- Randomly selects seed nodes and assigns non-seed nodes to partitions based on minimum distances, ensuring exact partition sizes.

### `sample_points`
#### Description
Samples a given number of points within the defined space using Poisson-Disc sampling.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| n    | int  | Number of points to sample |

#### Outputs
| Name   | Type       | Description                |
|:-------|:-----------|:---------------------------|
| points | np.ndarray | Sampled points within space |

#### Internal Logic
- Uses the Bridson algorithm for Poisson-Disc sampling, adjusting the radius iteratively to ensure the desired number of points are sampled.

### `overlay_data`
#### Description
Overlays spatial data onto a `CassiopeiaTree` by assigning spatial coordinates to nodes.

#### Inputs
| Name          | Type            | Description                                      |
|:--------------|:----------------|:-------------------------------------------------|
| tree          | CassiopeiaTree  | The tree to overlay spatial data onto.           |
| attribute_key | str             | The attribute name to save the coordinates as.   |

#### Internal Logic
- Samples point coordinates and assigns them to tree nodes, ensuring spatial autocorrelation of subclones by traversing the tree and splitting coordinates among child nodes.

## Dependencies

| Dependency | Purpose                                      |
|:-----------|:---------------------------------------------|
| networkx   | Used for graph construction and manipulation.|
| numpy      | Used for numerical operations and array handling.|
| pandas     | Used for handling data frames and metadata.  |
| scipy      | Used for spatial operations like Delaunay triangulation.|
| cv2        | Used for creating spatial masks (optional).  |
| poisson_disc | Used for Poisson-Disc sampling.            |
| sklearn.neighbors | Used for nearest neighbors graph construction. |

## Error Handling

- The class raises `DataSimulatorError` if required modules are not found or if both `shape` and `space` are not provided.

## TODOs
- None present in the target file.