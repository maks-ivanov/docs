---
title: "PercolationSolver.py"
---

## High-level description

The `PercolationSolver` class in the `PercolationSolver.py` file is a specialized solver for phylogenetic tree reconstruction. It implements a top-down percolation-based algorithm that recursively partitions a set of samples based on their similarity in observed mutations. The solver constructs a similarity graph, percolates it by removing edges, and clusters the resulting components to build a phylogenetic tree. This approach is an implicit version of Aho's algorithm for tree discovery.

## Code Structure

The `PercolationSolver` class extends the abstract `CassiopeiaSolver` class, inheriting its structure and implementing the `solve` method. The class uses several utility functions and classes from the `cassiopeia` package, such as `CassiopeiaTree`, `solver_utilities`, and `dissimilarity_functions`.

## Symbols

### `PercolationSolver`
#### Description
The `PercolationSolver` class is designed to solve phylogenetic tree reconstruction problems using a percolation-based approach. It partitions samples into clusters based on their mutation similarities and constructs a tree by recursively solving these partitions.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| joining_solver | CassiopeiaSolver | Solver used to cluster groups of samples when more than two groups are produced. |
| prior_transformation | str | Transformation function for priors, default is "negative_log". |
| similarity_function | Callable | Function to calculate similarity between samples, default is `hamming_similarity_without_missing`. |
| threshold | int | Minimum similarity threshold for graph edges, default is 0. |

#### Outputs
The class does not have direct outputs but modifies the `CassiopeiaTree` object by populating it with a reconstructed tree.

#### Internal Logic
- **Initialization**: Sets up the solver with a joining solver, prior transformation, similarity function, and threshold.
- **`solve` Method**: Implements the recursive partitioning and tree-building process. It uses a helper function `_solve` to handle the recursive logic.
- **`percolate` Method**: Constructs a similarity graph, removes edges to form connected components, and clusters these components to partition the samples.
- **`__add_duplicates_to_tree` Method**: Handles duplicate samples by adding them to the tree as sister nodes to their corresponding unique samples.

### `solve`
#### Description
The `solve` method is the main entry point for the percolation algorithm. It recursively partitions samples and constructs a phylogenetic tree.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cassiopeia_tree | CassiopeiaTree | Tree object storing character matrix and priors. |
| layer | str | Layer storing the character matrix for solving. |
| collapse_mutationless_edges | bool | Whether to collapse mutationless edges in the final tree. |
| logfile | str | Location to write standard output. |

#### Outputs
The method modifies the `cassiopeia_tree` by populating it with the reconstructed tree.

#### Internal Logic
- Extracts the character matrix and initializes a directed graph for the tree.
- Uses the `_solve` helper function to recursively partition samples and build the tree.
- Handles duplicate samples and optionally collapses mutationless edges.

### `percolate`
#### Description
The `percolate` method partitions a set of samples into two groups by constructing and percolating a similarity graph.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| character_matrix | pd.DataFrame | Character matrix of samples. |
| samples | List[str] | List of sample names to partition. |
| priors | Dict | Priors for character mutations. |
| weights | Dict | Weights for character-state pairs. |
| missing_state_indicator | int | Indicator for missing data. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| partition_named | Tuple[List[str], List[str]] | Two lists representing the partitioned sample groups. |

#### Internal Logic
- Constructs a similarity graph with samples as nodes and edges weighted by similarity.
- Percolates the graph by removing edges until multiple connected components are formed.
- Clusters components into two groups if more than two are formed, using the joining solver.

## References

- `CassiopeiaSolver`: The abstract base class that `PercolationSolver` extends.
- `CassiopeiaTree`: A data structure used to store the character matrix and reconstructed tree.
- `solver_utilities`: Provides utility functions like `node_name_generator` and `transform_priors`.
- `dissimilarity_functions`: Contains functions for calculating similarity scores between samples.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `networkx` | Used for graph operations and tree construction. |
| `numpy` | Used for numerical operations and array manipulations. |
| `pandas` | Used for handling character matrices as data frames. |

## TODOs

- Experiment to find the best default similarity function, as indicated by the TODO comment in the class docstring.