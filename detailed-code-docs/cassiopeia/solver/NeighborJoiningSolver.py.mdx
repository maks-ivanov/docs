---
title: "NeighborJoiningSolver.py"
---

## High-level description

The `NeighborJoiningSolver` class in the `NeighborJoiningSolver.py` file is a specialized implementation of the Neighbor-Joining algorithm, a method used in phylogenetic tree construction. This class extends the `DistanceSolver` class and is designed to iteratively join samples that minimize the Q-criterion on a dissimilarity map, ultimately constructing a phylogenetic tree. The class supports both a generic and a fast implementation of the algorithm, with options for different fast implementations.

## Code Structure

The `NeighborJoiningSolver` class is a subclass of `DistanceSolver`, which itself is a subclass of `CassiopeiaSolver`. The `NeighborJoiningSolver` class implements specific methods for finding cherries and updating the dissimilarity map, which are essential steps in the Neighbor-Joining algorithm. It also provides functionality for rooting the tree and setting up the solver with respect to the input data.

## References

- `DistanceSolver`: The base class from which `NeighborJoiningSolver` inherits. It provides the general framework for distance-based solvers.
- `CassiopeiaTree`: A data structure used to store the phylogenetic tree and associated data.
- `DistanceSolverError`: An exception class used for error handling within distance solvers.
- `dissimilarity_functions`: A module providing functions to compute dissimilarities between samples.
- `solver_utilities`: A module providing utility functions for solvers, such as generating unique node names.

## Symbols

### `NeighborJoiningSolver`
#### Description
The `NeighborJoiningSolver` class implements the Neighbor-Joining algorithm for constructing phylogenetic trees. It extends the `DistanceSolver` class and provides methods to find cherries by minimizing the Q-criterion, update the dissimilarity map, and root the tree. The class supports both a generic and a fast implementation of the algorithm.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dissimilarity_function | Callable | Function to compute the dissimilarity map. Optional if a dissimilarity map is provided. |
| add_root | bool | Whether to add an implicit root to the tree. |
| prior_transformation | str | Function to transform priors into weights. |
| fast | bool | Whether to use a fast implementation of Neighbor-Joining. |
| implementation | str | Specifies which fast implementation to use. |
| threads | int | Number of threads to use for the solver. |

#### Outputs
The class does not have a direct output but modifies the `CassiopeiaTree` object by populating it with a phylogenetic tree.

#### Internal Logic
- **Initialization**: Sets up the solver with the specified dissimilarity function, root option, prior transformation, and implementation choice.
- **Rooting**: The `root_tree` method roots the tree at a specified sample.
- **Cherry Finding**: The `find_cherry` method identifies pairs of samples to join by minimizing the Q-criterion.
- **Dissimilarity Map Update**: The `update_dissimilarity_map` method updates the dissimilarity map after joining two nodes.
- **Q-Criterion Calculation**: The `compute_q` method calculates the Q-criterion for all pairs of samples.

### `root_tree`
#### Description
Roots a tree produced by the Neighbor-Joining algorithm at a specified root sample.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tree | nx.Graph | The tree topology as a NetworkX graph. |
| root_sample | str | The sample to treat as the root. |
| remaining_samples | List[str] | The last two unjoined nodes in the tree. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| rooted_tree | nx.DiGraph | A directed graph representing the rooted tree. |

### `find_cherry`
#### Description
Finds a pair of samples to join into a cherry by minimizing the Q-criterion.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dissimilarity_matrix | np.array | A sample x sample dissimilarity matrix. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cherry | Tuple[int, int] | Indices of the samples to join in the dissimilarity matrix. |

### `compute_q`
#### Description
Computes the Q-criterion for every pair of samples, which is used to find cherries in the Neighbor-Joining algorithm.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dissimilarity_map | np.array | A sample x sample dissimilarity map. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| q_matrix | np.array | A matrix storing the Q-criterion for every pair of samples. |

### `update_dissimilarity_map`
#### Description
Updates the dissimilarity map after joining two nodes into a cherry.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dissimilarity_map | pd.DataFrame | The dissimilarity map to update. |
| cherry | Tuple[str, str] | Indices of the samples joining in the dissimilarity map. |
| new_node | str | New node name to be added to the dissimilarity map. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| updated_map | pd.DataFrame | The updated dissimilarity map. |

### `setup_root_finder`
#### Description
Defines the implicit rooting strategy for the NeighborJoiningSolver by adding an implicit root to the character matrix and recalculating the dissimilarity map.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cassiopeia_tree | CassiopeiaTree | The input tree to solve. |

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| networkx | Used for graph operations and tree manipulations. |
| numba | Provides JIT compilation for performance optimization. |
| numpy | Used for numerical operations and matrix manipulations. |
| pandas | Used for handling data frames, particularly for the dissimilarity map. |

## Error Handling

The class uses `DistanceSolverError` to handle errors related to invalid configurations or operations, such as specifying an invalid fast implementation or missing dissimilarity functions.

## Performance Considerations

The use of `numba` for JIT compilation in methods like `compute_q` and `__update_dissimilarity_map_numba` enhances performance by optimizing numerical computations, which is crucial given the potentially large size of dissimilarity matrices in phylogenetic analyses.