---
title: "map_utils.py"
---

## High-level description
The `map_utils.py` file contains a function designed to process a molecule table by mapping integer barcodes (intBCs) to their most frequent alleles for each cell barcode (cellBC). This function is part of a preprocessing pipeline and is used to filter and refine the data by selecting the most representative allele for each intBC/cellBC pair based on read and UMI counts.

## Code Structure
The main function in this file is `map_intbcs`, which is responsible for processing the molecule table. It utilizes a decorator from the `utilities` module to log its operations and employs a logger from the `cassiopeia.mixins` module to provide debug information.

## References
- `utilities.log_molecule_table`: A decorator used to log operations on the molecule table.
- `cassiopeia.mixins.logger`: A logger used for debugging purposes.

## Symbols

### `map_intbcs`
#### Description
The `map_intbcs` function processes a molecule table to assign a single allele to each intBC/cellBC pair. It selects the most frequent allele based on read count and UMI count, and filters out alignments that do not match this allele.

#### Inputs
| Name           | Type         | Description                                      |
|:---------------|:-------------|:-------------------------------------------------|
| molecule_table | `pd.DataFrame` | A DataFrame containing cellBC-UMI pairs to be filtered. |

#### Outputs
| Name         | Type         | Description                                                  |
|:-------------|:-------------|:-------------------------------------------------------------|
| mapped_table | `pd.DataFrame` | A DataFrame with one allele per cellBC-intBC pair, filtered accordingly. |

#### Internal Logic
1. **Drop NaN intBCs**: The function begins by removing any rows in the `molecule_table` where the `intBC` is NaN.
2. **Group and Aggregate**: It groups the data by `cellBC`, `intBC`, and `allele`, aggregating the `readCount` by summing and the `UMI` by counting.
3. **Sort and Select**: The grouped data is sorted by `UMI` and `readCount` in descending order to prioritize the most frequent alleles.
4. **Identify Duplicates**: A mask is created to identify duplicate `cellBC` and `intBC` pairs, ensuring only the most frequent allele is selected.
5. **Filter Table**: The original `molecule_table` is filtered to retain only the rows corresponding to the selected alleles.
6. **Logging**: The function logs the number of alleles and UMIs removed during the filtering process.

## Side Effects
- The function logs debug information about the number of alleles and UMIs removed, which can be useful for tracking the filtering process.

## Dependencies
| Dependency | Purpose                                      |
|:-----------|:---------------------------------------------|
| `pandas`   | Used for DataFrame operations and data manipulation. |
| `cassiopeia.mixins.logger` | Provides logging capabilities for debugging. |
| `cassiopeia.preprocess.utilities` | Provides a decorator for logging molecule table operations. |

## Logging
The function uses a logger from the `cassiopeia.mixins` module to log debug information about the number of alleles and UMIs removed during the filtering process. This helps in understanding the impact of the filtering on the dataset.