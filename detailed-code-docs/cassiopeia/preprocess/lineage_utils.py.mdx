---
title: "lineage_utils.py"
---

## High-level description

The `lineage_utils.py` file is part of the Cassiopeia library and contains functions for processing and assigning lineage groups to cells based on UMI (Unique Molecular Identifier) counts. The main functionality involves identifying lineage groups by clustering cells with similar intBC (integration barcode) patterns, refining these groups, and annotating cells with their respective lineage group assignments. This is crucial for reconstructing clonal populations in single-cell sequencing data.

## Code Structure

The main symbols in the code are functions that work together to process and assign lineage groups. The key functions are:

- `assign_lineage_groups`: Iteratively assigns lineage groups to cells.
- `find_top_lg`: Identifies the most frequent intBC and forms clusters.
- `filter_intbcs_lg_sets`: Filters out low-proportion intBCs from lineage groups.
- `score_lineage_kinships`: Scores the kinship of cells to lineage groups.
- `annotate_lineage_groups`: Annotates cells with lineage group assignments.
- `filter_intbcs_final_lineages`: Filters out low-proportion intBCs from final lineages.
- `filtered_lineage_group_to_allele_table`: Produces a final allele table for reconstruction.
- `plot_overlap_heatmap` and `plot_overlap_heatmap_lg`: Generate visualizations of lineage group overlaps.

## References

- The `logger` from `cassiopeia.mixins` is used for logging debug information.
- The `pipeline.py` file invokes functions from this module, particularly `call_lineage_groups`.

## Symbols

### `assign_lineage_groups`
#### Description
This function iteratively assigns lineage groups to cells by clustering them based on shared intBCs. It continues clustering until no group larger than a specified minimum size can be formed.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| pivot_in        | pd.DataFrame | Input pivot table of UMI counts for each cellBC-intBC pair.                 |
| min_clust_size  | int          | Minimum number of cells needed for a group.                                 |
| min_intbc_thresh| float        | Proportion threshold for including an intBC in the group set.               |
| kinship_thresh  | float        | Proportion of intBCs a cell needs to share with the group to be included.   |

#### Outputs
| Name          | Type         | Description                                      |
|:--------------|:-------------|:-------------------------------------------------|
| piv_assigned  | pd.DataFrame | Pivot table of cells labeled with lineage group assignments. |

#### Internal Logic
- Initializes an empty DataFrame for assigned groups.
- Iteratively calls `find_top_lg` to form groups around the most frequent intBC.
- Updates the input pivot table by removing assigned cells and continues until no large enough group can be formed.

### `find_top_lg`
#### Description
Identifies the most frequent intBC and forms a cluster of cells sharing a significant proportion of intBCs with it.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| PIVOT_in        | pd.DataFrame | Input pivot table of UMI counts for each cellBC-intBC pair.                 |
| iteration       | int          | Current iteration number for lineage group assignment.                      |
| min_intbc_prop  | float        | Proportion threshold for including an intBC in the cluster set.             |
| kinship_thresh  | float        | Proportion of intBCs a cell needs to share with the cluster to be included. |

#### Outputs
| Name          | Type                   | Description                                      |
|:--------------|:-----------------------|:-------------------------------------------------|
| PIV_LG        | pd.DataFrame           | Pivot table of cells labeled with lineage group assignments. |
| PIV_noLG      | pd.DataFrame           | Pivot table of remaining unassigned cells.       |

#### Internal Logic
- Calculates the sum of observed intBCs and identifies the most frequent one.
- Forms a subset of the pivot table with cells containing the top intBC.
- Binarizes the subset and defines a set of intBCs based on the proportion threshold.
- Filters cells based on kinship and returns updated pivot tables.

### `filter_intbcs_lg_sets`
#### Description
Filters out intBCs from lineage groups that are present in a low proportion of cells.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| PIV_assigned    | pd.DataFrame | Pivot table of cells labeled with lineage group assignments.                |
| min_intbc_thresh| float        | Minimum proportion of cells in a lineage group that must have an intBC.     |

#### Outputs
| Name          | Type                   | Description                                      |
|:--------------|:-----------------------|:-------------------------------------------------|
| master_LGs    | List[int]              | List of lineage groups.                          |
| master_intBCs | Dict[int, pd.DataFrame]| Dictionary mapping lineage group number to intBC set. |

### `score_lineage_kinships`
#### Description
Scores the kinship of each cell to lineage groups based on shared intBCs.

#### Inputs
| Name          | Type                   | Description                                      |
|:--------------|:-----------------------|:-------------------------------------------------|
| PIV           | pd.DataFrame           | Pivot table of cells labeled with lineage group assignments. |
| master_LGs    | List[int]              | List of lineage groups.                          |
| master_intBCs | Dict[int, pd.DataFrame]| Dictionary mapping lineage group number to intBC set. |

#### Outputs
| Name          | Type         | Description                                      |
|:--------------|:-------------|:-------------------------------------------------|
| max_kinship_LG| pd.DataFrame | DataFrame with the lineage group for each cell with the greatest kinship. |

### `annotate_lineage_groups`
#### Description
Annotates cells in the allele table with their assigned lineage groups.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| dfMT            | pd.DataFrame | Allele table of cellBC-UMI-allele groups.                                   |
| max_kinship_LG  | pd.DataFrame | DataFrame with the max kinship lineage group for each cell.                 |
| master_intBCs   | Dict[int, pd.DataFrame]| Dictionary mapping lineage group number to intBC set. |

#### Outputs
| Name          | Type         | Description                                      |
|:--------------|:-------------|:-------------------------------------------------|
| dfMT          | pd.DataFrame | Original allele table with annotated lineage group assignments. |

### `filter_intbcs_final_lineages`
#### Description
Filters out low-proportion intBCs from the final lineage groups.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| at              | pd.DataFrame | Allele table of cellBC-UMI-allele groups annotated with final lineage groups.|
| min_intbc_thresh| float        | Proportion threshold for filtering intBCs from each lineage group.          |

#### Outputs
| Name          | Type         | Description                                      |
|:--------------|:-------------|:-------------------------------------------------|
| lgs           | List[pd.DataFrame] | List of alignment DataFrames for each lineage group. |

### `filtered_lineage_group_to_allele_table`
#### Description
Produces the final allele table as a DataFrame for reconstruction.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| filtered_lgs    | List[pd.DataFrame] | List of alignment DataFrames annotated with lineage groups.            |

#### Outputs
| Name          | Type         | Description                                      |
|:--------------|:-------------|:-------------------------------------------------|
| final_df      | pd.DataFrame | Final processed DataFrame with indel information. |

### `plot_overlap_heatmap`
#### Description
Generates a plot showing the overlap of intBC sets, indicating clones.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| at              | pd.DataFrame | Allele table of cellBC-UMI-allele groups.                                   |
| at_pivot_I      | pd.DataFrame | Pivot table of indicators indicating which cellBCs have which UMIs.         |
| output_directory| str          | Directory to store the plot.                                                |

#### Outputs
None, plot is saved to the output directory.

### `plot_overlap_heatmap_lg`
#### Description
Generates a plot of the allele table with rows as cellBCs and columns as cutsites for each intBC.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| at              | pd.DataFrame | Allele table of cellBC-UMI-allele groups.                                   |
| at_pivot_I      | pd.DataFrame | Pivot table of indicators indicating which cellBCs have which UMIs.         |
| output_directory| str          | Directory to store the plot.                                                |

#### Outputs
None, plot is saved to the output directory.

### `add_cutsite_encoding`
#### Description
Adds encoding for the mutation type at each cutsite for each cellBC.

#### Inputs
| Name            | Type         | Description                                                                 |
|:----------------|:-------------|:----------------------------------------------------------------------------|
| lg_group        | pd.DataFrame | Pivot table representing a lineage group.                                   |

#### Outputs
| Name          | Type         | Description                                      |
|:--------------|:-------------|:-------------------------------------------------|
| lg_group      | pd.DataFrame | Pivot table with cutsite encodings.              |

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `matplotlib` | Used for plotting heatmaps and visualizations. |
| `numpy` | Used for numerical operations and calculations. |
| `pandas` | Used for data manipulation and DataFrame operations. |
| `pylab` | Used for plotting and numerical operations. |
| `re` | Used for regular expression operations. |

## Logging

The code uses a logger from `cassiopeia.mixins` to log debug information, which helps in tracking the progress and debugging the lineage group assignment process.