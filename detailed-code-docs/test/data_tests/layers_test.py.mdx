---
title: "layers_test.py"
---

## High-level description

The target file `layers_test.py` is a unit test suite designed to test the functionality of the `Layers` class within the `CassiopeiaTree` data structure. The tests focus on verifying the integrity and manipulation of character matrices, which represent different layers of mutation data for cells. The tests ensure that layers can be added, modified, and used to reconstruct phylogenetic trees accurately.

## Code Structure

The main components of the code are:

- **`find_triplet_structure` function**: A utility function to determine the relationship structure among three nodes in a tree.
- **`TestLayers` class**: A subclass of `unittest.TestCase` that contains several test methods to validate the behavior of the `Layers` class in the `CassiopeiaTree` object.

## References

- **`CassiopeiaTree`**: A class from the `cassiopeia.data` module that represents a phylogenetic tree with associated character matrices.
- **`VanillaGreedySolver`**: A solver from the `cassiopeia.solver` module used to reconstruct trees based on character matrices.

## Symbols

### `find_triplet_structure`
#### Description
Determines the common ancestor structure among three nodes in a tree, returning a string that represents the most closely related pair.

#### Inputs
| Name    | Type       | Description                        |
|:--------|:-----------|:-----------------------------------|
| triplet | tuple      | A tuple of three node identifiers. |
| T       | nx.DiGraph | A directed graph representing a tree. |

#### Outputs
| Name      | Type   | Description                                      |
|:----------|:-------|:-------------------------------------------------|
| structure | str    | A string indicating the closest pair among the nodes. |

#### Internal Logic
- Computes the ancestors for each node in the triplet.
- Determines the number of common ancestors between each pair of nodes.
- Returns a string indicating the pair with the most common ancestors.

### `TestLayers`
#### Description
A test suite for validating the functionality of the `Layers` class in the `CassiopeiaTree` object.

#### Methods

- **`setUp`**: Initializes a base character matrix and tree topology for use in tests.
- **`test_basic_character_matrix`**: Verifies that the character matrix in the tree matches the expected base matrix.
- **`test_add_layer`**: Tests adding a new layer to the tree and verifies that modifications to this layer do not affect the base character matrix.
- **`test_reconstruct_tree_with_layers`**: Tests the reconstruction of a tree using different layers and verifies the structure of the reconstructed tree.
- **`test_add_layer_with_incorrect_number_of_cells`**: Ensures that adding a layer with an incorrect number of cells raises a `ValueError`.
- **`test_add_layer_with_different_number_of_characters`**: Tests adding a layer with a different number of characters and verifies the correct setting of character states.

## Dependencies

| Dependency | Purpose                                      |
|:-----------|:---------------------------------------------|
| `unittest` | Provides the framework for writing and running tests. |
| `networkx` | Used for creating and manipulating the tree topology. |
| `pandas`   | Used for handling character matrices as DataFrames. |
| `cassiopeia` | Provides the `CassiopeiaTree` and related utilities. |

## Error Handling

- The test `test_add_layer_with_incorrect_number_of_cells` explicitly checks for a `ValueError` when attempting to add a layer with an incorrect number of cells.

## Logging

No explicit logging is implemented in the test suite. The `unittest` framework handles test results and outputs.

## TODOs

No TODOs or notes are present in the code.