---
title: "percolation_test.py"
---

## High-level description

The `percolation_test.py` file is a unit test suite for the `PercolationSolver` class in the `Cassiopeia` library. It uses the `unittest` framework to verify the functionality of the `PercolationSolver` by testing its ability to reconstruct phylogenetic trees from character matrices using different solving strategies and dissimilarity functions. The tests ensure that the solver produces expected tree topologies under various conditions, including handling missing data and using different dissimilarity metrics.

## Code Structure

The main components of the code are the test cases defined within the `PercolationSolverTest` class. Each test case sets up a character matrix, configures a solver with specific parameters, and verifies the output tree topology against an expected result. The `find_triplet_structure` function is used to compare the structure of triplets in the observed and expected trees.

## Symbols

### `find_triplet_structure`
#### Description
This function determines the structure of a triplet (a set of three nodes) in a given tree. It identifies which pair of nodes in the triplet shares the most common ancestors, indicating their closer relationship in the tree.

#### Inputs
| Name   | Type       | Description                        |
|:-------|:-----------|:-----------------------------------|
| triplet| List[str]  | A list of three node identifiers.  |
| T      | nx.DiGraph | A directed graph representing a tree.|

#### Outputs
| Name      | Type   | Description                                      |
|:----------|:-------|:-------------------------------------------------|
| structure | str    | A string indicating the closest pair in the triplet ("ab", "ac", "bc", or "-"). |

#### Internal Logic
- The function computes the set of ancestors for each node in the triplet.
- It calculates the number of common ancestors for each pair of nodes.
- It returns the pair with the most common ancestors, or "-" if no pair is significantly closer.

### `neg_hamming_similarity_without_missing`
#### Description
This function computes the negative Hamming similarity between two samples, ignoring missing data. It is used as a dissimilarity function for tree reconstruction.

#### Inputs
| Name                  | Type          | Description                                      |
|:----------------------|:--------------|:-------------------------------------------------|
| s1                    | np.array      | Character states of the first sample.            |
| s2                    | np.array      | Character states of the second sample.           |
| missing_state_indicator | int         | Indicator for missing data.                      |
| weights               | Optional[Dict[int, Dict[int, float]]] | Optional weights for character states. |

#### Outputs
| Name      | Type  | Description                                      |
|:----------|:------|:-------------------------------------------------|
| similarity| float | The negative Hamming similarity score.           |

#### Internal Logic
- The function calls a JIT-compiled version of the `hamming_similarity_without_missing` function from `dissimilarity_functions`.
- It returns the negative of the computed similarity score.

### `PercolationSolverTest`
#### Description
A test suite for the `PercolationSolver` class, containing multiple test cases to verify its functionality under different conditions.

#### Internal Logic
- Each test case initializes a character matrix and a `CassiopeiaTree`.
- It configures a solver with a specific dissimilarity function and solving strategy.
- The solver is used to reconstruct a tree, and the resulting topology is compared against an expected tree using triplet structures.

## References

- `dissimilarity_functions.hamming_similarity_without_missing`: A function from the `dissimilarity_functions` module used to compute Hamming similarity.
- `CassiopeiaTree`: A class from the `cassiopeia.data` module used to represent phylogenetic trees.
- `NeighborJoiningSolver`, `VanillaGreedySolver`, `PercolationSolver`: Solver classes from the `cassiopeia.solver` module used for tree reconstruction.

## Dependencies

| Dependency | Purpose                                      |
|:-----------|:---------------------------------------------|
| `unittest` | Provides the framework for writing and running tests. |
| `networkx` | Used for graph operations and tree representations. |
| `numba`    | JIT compilation for performance optimization. |
| `numpy`    | Numerical operations and array handling.      |
| `pandas`   | Data manipulation and character matrix creation. |
| `cassiopeia` | The main library being tested, providing tree and solver classes. |

## Error Handling

The test cases use assertions to verify the correctness of the solver's output. If the observed tree topology does not match the expected topology, an assertion error is raised, indicating a failure in the test.

## Logging

No explicit logging is implemented in this test suite. The focus is on using assertions to validate the solver's behavior.