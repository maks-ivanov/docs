---
title: "ccphylo_solver_test.py"
---

## High-level description

The `ccphylo_solver_test.py` file is a unit test suite designed to validate the functionality of different phylogenetic tree solvers, specifically those implemented in the Cassiopeia library. It tests the `NeighborJoiningSolver` and `UPGMASolver` implementations against the standard NJ (Neighbor Joining) and UPGMA (Unweighted Pair Group Method with Arithmetic Mean) methods, as well as their optimized versions using the `ccphylo` library. The tests ensure that these solvers produce consistent and expected results when constructing phylogenetic trees from character matrices.

## Code Structure

The main components of the code are the test class `TestCCPhyloSolver` and several helper functions. The test class contains multiple test methods that validate different aspects of the solvers. The helper functions, such as `find_triplet_structure` and `delta_fn`, assist in evaluating the tree structures and calculating dissimilarities, respectively.

## Symbols

### `find_triplet_structure`
#### Description
This function determines the structure of a triplet (three nodes) within a given tree topology. It identifies which pair of nodes shares the most common ancestors, indicating their closer relationship in the tree.

#### Inputs
| Name    | Type       | Description                        |
|:--------|:-----------|:-----------------------------------|
| triplet | tuple      | A triplet of nodes (a, b, c).      |
| T       | nx.DiGraph | The tree topology as a directed graph. |

#### Outputs
| Name      | Type   | Description                                      |
|:----------|:-------|:-------------------------------------------------|
| structure | str    | The structure of the triplet, either "ab", "ac", or "bc". |

#### Internal Logic
- The function calculates the ancestors for each node in the triplet.
- It then computes the number of common ancestors between each pair of nodes.
- Based on the counts, it determines which pair has the most common ancestors and returns the corresponding structure.

### `delta_fn`
#### Description
This function calculates the dissimilarity between two character vectors, which is used by the solvers to assess differences between samples.

#### Inputs
| Name          | Type          | Description                                      |
|:--------------|:--------------|:-------------------------------------------------|
| x             | np.array      | The first character vector.                      |
| y             | np.array      | The second character vector.                     |
| missing_state | int           | The state representing missing data (unused here).|
| priors        | Optional[Dict[int, Dict[int, float]]] | Priors for character states (unused here). |

#### Outputs
| Name | Type | Description                        |
|:-----|:-----|:-----------------------------------|
| d    | int  | The dissimilarity count between x and y. |

#### Internal Logic
- The function iterates over the elements of the two vectors.
- It increments the dissimilarity count `d` for each position where the elements differ.

### `TestCCPhyloSolver`
#### Description
This class contains unit tests for validating the behavior of different phylogenetic solvers in the Cassiopeia library. It checks the consistency and correctness of tree structures generated by these solvers.

#### Internal Logic
- The `setUp` method initializes character matrices and solver instances for use in the tests.
- Each test method checks a specific aspect of the solvers, such as handling invalid inputs, comparing tree structures, and ensuring correct edge counts.
- The tests are conditionally executed based on the configuration of the `ccphylo` library.

## Side Effects

- The tests modify the state of the `CassiopeiaTree` instances by solving them with different solvers.
- The configuration file `config.ini` is read to determine if the `ccphylo` library is configured, affecting the execution of tests.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `unittest` | Provides the framework for writing and running tests. |
| `networkx` | Used for handling graph structures representing tree topologies. |
| `numpy`    | Utilized for numerical operations, such as array handling. |
| `pandas`   | Used for creating and manipulating character matrices. |
| `cassiopeia` | The main library being tested, providing tree and solver classes. |

## Configuration

| Option        | Type   | Default | Description                                      |
|:--------------|:-------|:--------|:-------------------------------------------------|
| `ccphylo_path`| string | None    | Path to the `ccphylo` library, specified in `config.ini`. |

## Error Handling

- The tests use `unittest`'s `assertRaises` to check for expected exceptions when invalid inputs are provided to the solvers.

## Logging

- The test suite does not implement explicit logging but relies on `unittest` for reporting test results and errors.

## TODOs

- There are no explicit TODOs in the code, but future improvements could include expanding the test coverage to additional solver configurations or edge cases.