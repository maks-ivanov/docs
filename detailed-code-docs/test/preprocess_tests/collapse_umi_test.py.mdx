---
title: "collapse_umi_test.py"
---

## High-level description

The `collapse_umi_test.py` file is a unit test suite designed to validate the functionality of the UMI (Unique Molecular Identifier) collapsing process in a bioinformatics pipeline. It uses the `unittest` framework to ensure that BAM files are correctly sorted and collapsed based on UMI sequences, with tests covering different scenarios such as uncorrected UMIs, Bayesian collapsing, and header information handling.

## Code Structure

The main class in this file is `TestCollapseUMIs`, which inherits from `unittest.TestCase`. This class contains several test methods that validate different aspects of the UMI collapsing process. The tests rely on utility functions from the `UMI_utils` and `utilities` modules, which handle the sorting and collapsing of BAM files.

## Symbols

### `TestCollapseUMIs`
#### Description
This class contains unit tests for verifying the UMI collapsing functionality. It sets up test files, sorts and collapses them using different methods, and checks the results against expected values.

#### Inputs
- None directly, but it uses test BAM files located in a `test_files` directory.

#### Outputs
- None directly, but it asserts conditions to validate the correctness of the UMI collapsing process.

#### Internal Logic
- **`setUp` Method**: Prepares the test environment by creating necessary directories and files. It sorts and collapses BAM files using different methods and stores the results for use in test methods.
- **`test_sort_bam` Method**: Validates that the sorted BAM file has the expected cell barcodes and UMIs.
- **`test_sort_bam_uncorrected` Method**: Similar to `test_sort_bam`, but for uncorrected BAM files.
- **`test_collapse_bam` Method**: Checks that the collapsed BAM file has the expected number of reads, cell barcodes, UMIs, and quality scores.
- **`test_collapse_bam_bayesian` Method**: Similar to `test_collapse_bam`, but for Bayesian collapsed BAM files.
- **`test_collapse_bam_uncorrected` Method**: Validates the collapsing process for uncorrected BAM files.
- **`test_bam2DF` Method**: Converts a collapsed BAM file to a DataFrame and checks its contents against expected values.
- **`test_collapsing_passes_header` Method**: Ensures that header information is correctly passed during the collapsing process.

## References

- **`UMI_utils.sort_bam`**: Used to sort BAM files based on specified keys.
- **`UMI_utils.form_collapsed_clusters`**: Used to collapse UMIs in BAM files.
- **`utilities.convert_bam_to_df`**: Converts BAM files to Pandas DataFrames for easier manipulation and validation.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `unittest` | Provides the testing framework. |
| `pandas` | Used for data manipulation and validation. |
| `pysam` | Used for reading and writing BAM files. |
| `os`, `pathlib` | Used for file and directory operations. |

## Error Handling

The test methods use assertions to validate expected outcomes. If any assertion fails, it indicates a problem with the UMI collapsing process, and the test will report an error.

## Logging

No explicit logging is implemented in this test suite. The focus is on using assertions to validate functionality.

## TODOs

No TODOs are present in the code.