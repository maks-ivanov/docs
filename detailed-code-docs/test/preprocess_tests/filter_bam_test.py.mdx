---
title: "filter_bam_test.py"
---

## High-level description
The `filter_bam_test.py` file contains unit tests for the `filter_bam` function from the `pipeline` module within the `cassiopeia.preprocess` package. The tests are designed to verify the functionality of filtering BAM files based on a specified threshold, ensuring that the function correctly filters out alignments that do not meet the criteria.

## Code Structure
The code is structured using the `unittest` framework, with a single test class `TestFilterBam` that contains setup and test methods. The `setUp` method prepares the environment by defining file paths, and the `test_filter` method performs the actual testing of the `filter_bam` function.

## Symbols

### `TestFilterBam`
#### Description
`TestFilterBam` is a test class derived from `unittest.TestCase`. It is responsible for setting up the test environment and executing tests to validate the `filter_bam` function.

#### Methods

#### `setUp`
##### Description
The `setUp` method initializes the test environment by setting up file paths required for the tests. It is executed before each test method to ensure a consistent starting state.

##### Inputs
None

##### Outputs
None

##### Internal Logic
- Determines the directory path of the current file.
- Constructs the path to the test files directory.
- Sets the path to a specific BAM file (`10xv3_unmapped.bam`) used in the tests.

#### `test_filter`
##### Description
The `test_filter` method tests the `filter_bam` function to ensure it correctly filters alignments based on a given threshold.

##### Inputs
None

##### Outputs
None

##### Internal Logic
- Calls `pipeline.filter_bam` with a threshold of 10 and checks that the resulting BAM file contains 2 alignments.
- Calls `pipeline.filter_bam` with a threshold of 20 and checks that the resulting BAM file contains 0 alignments.
- Uses `pysam.AlignmentFile` to read the filtered BAM files and verify the number of alignments.

## References
- `pipeline.filter_bam`: The function being tested, which is expected to filter BAM files based on a specified threshold.
- `pysam.AlignmentFile`: Used to read and fetch alignments from BAM files for verification.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `unittest` | Provides the framework for writing and running tests. |
| `os` | Used for file path manipulations. |
| `tempfile` | Used to create temporary directories for storing filtered BAM files. |
| `pysam` | A library for reading and writing SAM/BAM files. |
| `ngs_tools` | Imported but not used directly in the provided code. |

## Error Handling
The test code does not include explicit error handling beyond what is provided by the `unittest` framework. If the assertions fail, `unittest` will report the failure.

## Logging
No logging mechanisms are implemented in this test code.

## TODOs
No TODOs or notes are present in the code.