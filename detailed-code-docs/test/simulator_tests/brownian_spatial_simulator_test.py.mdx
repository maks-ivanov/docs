---
title: "brownian_spatial_simulator_test.py"
---

## High-level description
This file contains unit tests for the `BrownianSpatialDataSimulator` class, which is responsible for simulating spatial data in a Cassiopeia tree using Brownian motion. The tests cover the initialization of the simulator, overlaying data onto a basic tree, and handling trees with existing cell metadata.

## Code Structure
The code defines a `TestBrownianSpatialDataSimulator` class that inherits from `unittest.TestCase`. It contains several test methods that check different aspects of the `BrownianSpatialDataSimulator` functionality.

## Symbols

### TestBrownianSpatialDataSimulator
#### Description
A test class for the `BrownianSpatialDataSimulator`. It sets up a basic tree structure and tests various aspects of the simulator.

#### Internal Logic
1. `setUp`: Initializes a basic tree structure and a tree with cell metadata for use in tests.
2. `test_init`: Tests the initialization of the `BrownianSpatialDataSimulator` with various parameters.
3. `test_overlay_data`: Tests the overlay_data method on a basic tree.
4. `test_overlay_data_without_scale`: Tests the overlay_data method without scaling the coordinates.
5. `test_overlay_data_with_existing_cell_meta`: Tests the overlay_data method on a tree with existing cell metadata.

### setUp
#### Description
Sets up the test environment by creating a basic tree structure and a tree with cell metadata.

#### Internal Logic
1. Creates a directed graph representing the tree topology.
2. Initializes a `CassiopeiaTree` with the topology.
3. Sets node times for the tree.
4. Creates a `DataFrame` for cell metadata.
5. Initializes another `CassiopeiaTree` with the topology and cell metadata.

### test_init
#### Description
Tests the initialization of the `BrownianSpatialDataSimulator` with various parameters.

#### Internal Logic
1. Checks that initializing with invalid dimensions raises a `DataSimulatorError`.
2. Checks that initializing with a negative diffusion coefficient raises a `DataSimulatorError`.
3. Verifies that a valid initialization sets the correct attributes.

### test_overlay_data
#### Description
Tests the `overlay_data` method of `BrownianSpatialDataSimulator` on a basic tree.

#### Internal Logic
1. Initializes a simulator with 2 dimensions and a diffusion coefficient of 1.
2. Overlays data onto the basic tree.
3. Checks that the spatial coordinates are set correctly for each node.
4. Verifies that the cell metadata is updated with the correct spatial coordinates.

### test_overlay_data_without_scale
#### Description
Tests the `overlay_data` method without scaling the coordinates to unit area.

#### Internal Logic
1. Initializes a simulator with `scale_unit_area=False`.
2. Overlays data onto the basic tree.
3. Checks that the spatial coordinates are set correctly for each node.
4. Verifies that the cell metadata is updated with the correct spatial coordinates.

### test_overlay_data_with_existing_cell_meta
#### Description
Tests the `overlay_data` method on a tree with existing cell metadata.

#### Internal Logic
1. Initializes a simulator with default parameters.
2. Overlays data onto the tree with existing cell metadata.
3. Checks that the spatial coordinates are set correctly for each node.
4. Verifies that the cell metadata is updated with the correct spatial coordinates while preserving existing metadata.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| unittest | Provides the testing framework |
| networkx | Used for creating and manipulating graph structures |
| numpy | Used for numerical operations and testing |
| pandas | Used for handling DataFrames and testing |
| cassiopeia | The main package being tested |

## Error Handling
The tests check for proper error handling in the `BrownianSpatialDataSimulator` initialization by asserting that `DataSimulatorError` is raised for invalid input parameters.