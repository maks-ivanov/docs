---
title: "spatial_leaf_subsampler_test.py"
---

## High-level description

The target file `spatial_leaf_subsampler_test.py` is a unit test suite for the `SpatialLeafSubsampler` class from the `cassiopeia.simulator` module. This test suite is designed to verify the functionality of the `SpatialLeafSubsampler`, which is responsible for subsampling leaves from a `CassiopeiaTree` based on spatial attributes. The tests cover various scenarios, including initialization with invalid parameters, subsampling with different spatial configurations, and handling of edge cases like merging cells and maintaining tree structure.

## Code Structure

The main class in this file is `SpatialLeafSubsamplerTest`, which is a subclass of `unittest.TestCase`. This class contains several test methods that each test a specific aspect of the `SpatialLeafSubsampler` class. The tests are organized to check for invalid initialization parameters, invalid subsampling parameters, correct subsampling behavior in both 2D and 3D spaces, and specific features like merging cells and keeping singular root edges.

## References

- `CassiopeiaTree`: Used to create tree structures for testing.
- `LeafSubsamplerError` and `LeafSubsamplerWarning`: Used to handle exceptions and warnings during testing.
- `SpatialLeafSubsampler`: The class being tested.

## Symbols

### `SpatialLeafSubsamplerTest`
#### Description
This class contains unit tests for the `SpatialLeafSubsampler` class. It sets up test trees with spatial attributes and verifies the behavior of the subsampler under various conditions.

#### Inputs
- None directly, but uses trees and spatial configurations set up in the `setUp` method.

#### Outputs
- None directly, but asserts conditions to verify correct behavior.

#### Internal Logic
- **`setUp` Method**: Initializes test data, including balanced trees with spatial attributes in both 2D and 3D configurations. It also sets up bounding boxes and space masks for testing.
- **`test_bad_init_parameters` Method**: Tests invalid initialization scenarios for `SpatialLeafSubsampler`, such as providing both `ratio` and `number_of_leaves`, or neither `space` nor `bounding_box`.
- **`test_bad_subsample_parameters` Method**: Tests invalid subsampling scenarios, such as trees without spatial attributes or incompatible space dimensions.
- **`test_bad_scale` Method**: Tests the handling of small-scale spatial attributes, expecting a warning.
- **`test_subsample_3d_tree` Method**: Tests subsampling in a 3D tree using both bounding box and space mask.
- **`test_subsample_2d_tree` Method**: Tests subsampling in a 2D tree using both bounding box and space mask.
- **`test_keep_singular_root_edge` Method**: Tests the option to keep or collapse a singular root edge in the subsampled tree.
- **`test_subsample_with_ratio` Method**: Tests subsampling using a specified ratio of leaves.
- **`test_subsample_with_number` Method**: Tests subsampling using a specified number of leaves.
- **`test_merge_cells` Method**: Tests the merging of cells within the same spatial pixel, both with and without a character matrix.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `unittest` | Provides the testing framework. |
| `networkx` | Used to create and manipulate graph structures for trees. |
| `numpy` | Used for numerical operations and array manipulations. |
| `pandas` | Used for handling data in DataFrame format. |

## Error Handling

The test suite uses `LeafSubsamplerError` to verify that the `SpatialLeafSubsampler` raises appropriate exceptions when initialized or used with invalid parameters. It also uses `LeafSubsamplerWarning` to check for warnings in specific scenarios, such as when spatial attributes are on a small scale.

## Logging

No explicit logging is implemented in this test suite. The focus is on using assertions to verify expected behavior and exceptions.

## TODOs

No TODOs are present in the code.