---
title: "smoke_test.go"
---

## High-level description
This code implements a smoke test suite for the GPTScript project. It runs a series of tests using the `gptscript` command-line tool, comparing the actual output events with expected events, and uses an AI judge to determine if the outputs are equivalent.

## Code Structure
The main `TestSmoke` function iterates through test cases, runs the `gptscript` command, and compares the actual output events with expected events. It uses a `judge` to determine if the outputs are equivalent, considering specific criteria for comparison.

## References
- `github.com/gptscript-ai/chat-completion-client`
- `github.com/gptscript-ai/gptscript/pkg/runner`
- `github.com/gptscript-ai/gptscript/pkg/tests/judge`
- `github.com/gptscript-ai/gptscript/pkg/types`

## Symbols

### `TestSmoke`
#### Description
The main test function that runs smoke tests for the GPTScript project.

#### Inputs
None (it's a test function)

#### Internal Logic
1. Initializes an OpenAI client and a smoke test judge.
2. Iterates through test cases obtained from `getTestcases`.
3. For each test case:
   - Runs the `gptscript` command with specific arguments.
   - Compares actual events with expected events using the judge.
   - Logs the reasoning and asserts that the outputs are equivalent.

### `getTestcases`
#### Description
Retrieves test cases from the `testdata` directory.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| testcases | []testcase | Slice of test case structures |

#### Internal Logic
1. Reads the `testdata` directory.
2. For each subdirectory, finds the first `.gpt` file.
3. Creates a `testcase` structure for each valid test.

### `getActualEvents`
#### Description
Reads and parses the actual events from the events file generated by the `gptscript` command.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| eventsFile | string | Path to the file containing actual events |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| events | []event | Slice of parsed event structures |

#### Internal Logic
1. Opens and reads the events file.
2. Parses each non-empty line as a JSON event.
3. Appends parsed events to a slice.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| openai | Client for interacting with OpenAI API |
| github.com/gptscript-ai/gptscript/pkg/runner | Provides runner-related types and functions |
| github.com/gptscript-ai/gptscript/pkg/tests/judge | Implements the AI judge for comparing outputs |
| github.com/gptscript-ai/gptscript/pkg/types | Provides common types used in the project |
| github.com/stretchr/testify | Assertion library for testing |
| gotest.tools/v3/icmd | Helps with running and asserting command-line programs |

## Error Handling
The code uses `require.NoError` and `assert.NoError` from the testify package to handle and report errors during the test execution.

## Logging
The test function logs the reasoning provided by the judge using `t.Logf`.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.