---
title: "test_distributor.py"
---

## High-level description

The target file `tests/_utils/test_distributor.py` contains a unit test for the `Distributor` class, which is designed to distribute messages received from a connection to multiple consumer functions. The test verifies that the `Distributor` can correctly add consumers, distribute messages to them, and handle the removal of consumers.

## Code Structure

The test file primarily interacts with the `Distributor` class from the `marimo._utils.distributor` module. It uses the `unittest.mock` library to create mock objects for testing the behavior of the `Distributor` without requiring actual network connections or event loops.

## References

- `Distributor` class from `marimo._utils.distributor`: The main class being tested.
- `asyncio.get_event_loop`: Mocked to simulate the event loop behavior during testing.

## Symbols

### `test_start`
#### Description
This function tests the `Distributor` class's ability to start distributing messages to consumers, handle message reception, and manage consumer addition and removal.

#### Inputs
| Name              | Type | Description |
|:------------------|:-----|:------------|
| `mock_get_event_loop` | `Any` | A mock object for the asyncio event loop. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| None | None | This function does not return any value. |

#### Internal Logic
1. **Mock Setup**: The function begins by setting up a mock for the `asyncio.get_event_loop` function and a mock connection object.
2. **Distributor Initialization**: A `Distributor` instance is created with the mock connection.
3. **Consumer Addition**: Two mock consumer functions are added to the distributor.
4. **Distributor Start**: The distributor is started, which involves setting up the event loop to listen for incoming messages.
5. **Message Distribution**: A test message is simulated to be received by the mock connection, and the `_on_change` method is called to distribute this message to the consumers.
6. **Assertions**: The test asserts that both consumers receive the message.
7. **Consumer Removal**: One consumer is removed, and another message is distributed to verify that only the remaining consumer receives it.
8. **Distributor Stop**: The distributor is stopped, and it is asserted that the connection is closed.

## Side Effects

- The test modifies the state of the `Distributor` instance by adding and removing consumers.
- It also interacts with the mock connection to simulate message reception and distribution.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `unittest.mock` | Used to create mock objects for testing without real connections or event loops. |
| `asyncio` | The event loop is mocked to simulate asynchronous behavior. |

## Error Handling

The test does not explicitly handle errors, as it relies on assertions to verify correct behavior. Any unexpected behavior would result in a test failure.

## Logging

The test itself does not implement logging, but the `Distributor` class being tested uses logging to report errors during message reception.

## TODOs

There are no TODOs or notes left in the code.