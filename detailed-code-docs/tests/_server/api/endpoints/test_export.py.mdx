---
title: "test_export.py"
---

## High-level description

The target file `tests/_server/api/endpoints/test_export.py` contains a suite of tests designed to verify the functionality of various export endpoints in a web application built using the Marimo library. These tests focus on ensuring that the export functionality for HTML, scripts, and markdown works correctly, including handling of session management and token-based authentication.

## Code Structure

The main symbols in the code are test functions that utilize decorators to manage session states. These functions interact with the API endpoints using a `TestClient` to simulate HTTP requests and verify the responses. The tests are organized to cover different scenarios, such as exporting with or without code, handling skew protection, and ensuring that read-only sessions behave as expected.

## Symbols

### `test_export_html`
#### Description
Tests the HTML export functionality of the API, ensuring that the exported HTML includes the code when requested.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Retrieves the session using `get_session_manager`.
- Sets the filename for the session's app file manager.
- Sends a POST request to the `/api/export/html` endpoint with specific headers and JSON payload.
- Asserts that the response body contains the expected code and does not contain hidden code tags.

### `test_export_html_skew_protection`
#### Description
Tests the skew protection mechanism by attempting to export HTML with an invalid server token.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Similar setup as `test_export_html`.
- Sends a POST request with an outdated server token.
- Asserts that the response status code is 401 and the error message indicates an invalid server token.

### `test_export_html_no_code`
#### Description
Tests the HTML export functionality when the code is not included in the export.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Similar setup as `test_export_html`.
- Sends a POST request with `include_code` set to `False`.
- Asserts that the response body contains hidden code tags and does not contain the code.

### `test_export_html_no_code_in_read`
#### Description
Tests the HTML export functionality in a read-only session, ensuring no code is included.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Uses `with_read_session` decorator to simulate a read-only session.
- Sends POST requests to the `/api/export/html` endpoint with different `include_code` settings.
- Asserts that the response body always contains hidden code tags and does not contain the code.

### `test_export_script`
#### Description
Tests the script export functionality of the API.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Sends a POST request to the `/api/export/script` endpoint.
- Asserts that the response status code is 200 and the response text contains a specific marker indicating successful script generation.

### `test_export_markdown`
#### Description
Tests the markdown export functionality of the API.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Sends a POST request to the `/api/export/markdown` endpoint.
- Asserts that the response status code is 200 and the response text contains the Marimo version and a specific markdown format.

### `test_other_exports_dont_work_in_read`
#### Description
Tests that script and markdown exports do not work in a read-only session.

#### Inputs
| Name   | Type       | Description          |
|:-------|:-----------|:---------------------|
| client | TestClient | The test client used to make requests to the API. |

#### Outputs
None

#### Internal Logic
- Uses `with_read_session` decorator to simulate a read-only session.
- Sends POST requests to the `/api/export/markdown` and `/api/export/script` endpoints.
- Asserts that the response status code is 401 for both requests.

## References

- `get_session_manager`: Used to retrieve the session manager for managing session states.
- `uri_encode_component`: Utilized to encode the code component for comparison in tests.
- `token_header`, `with_read_session`, `with_session`: Decorators and utility functions from `tests._server.mocks` to manage session and authentication headers.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `starlette.testclient` | Used to simulate HTTP requests to the API endpoints. |

## Error Handling

The tests assert specific response status codes and error messages to verify correct error handling by the API, such as returning a 401 status code for invalid tokens or unauthorized access.

## Logging

No explicit logging is implemented in the test code. The assertions serve as the primary mechanism for verifying expected behavior.