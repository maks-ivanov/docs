---
title: "test_asgi.py"
---

## High-level description

The target file `tests/_server/test_asgi.py` contains unit tests for the ASGI application builder functionality provided by the `marimo` library. It tests the creation and configuration of ASGI applications using the `ASGIAppBuilder` and `create_asgi_app` functions, ensuring that multiple applications can be served under different paths and that the applications behave as expected when accessed via HTTP requests.

## Code Structure

The main class in this file is `TestASGIAppBuilder`, which is a subclass of `unittest.TestCase`. This class contains several test methods that verify different aspects of the ASGI application building process. The tests use the `TestClient` from the `starlette` library to simulate HTTP requests to the ASGI applications.

## References

- `ASGIAppBuilder` and `create_asgi_app` from `marimo._server.asgi`: These are the primary components being tested, responsible for building and configuring ASGI applications.
- `TestClient` from `starlette.testclient`: Used to simulate HTTP requests to the ASGI applications.

## Symbols

### `TestASGIAppBuilder`
#### Description
This class contains unit tests for the ASGI application builder. It verifies that ASGI applications can be created, configured, and accessed correctly.

#### Inputs
- None directly, but it uses temporary files and directories for testing.

#### Outputs
- None directly, but it asserts various conditions to verify correct behavior.

#### Internal Logic
- **setUp**: Creates temporary Python files with basic application code to be used in tests.
- **tearDown**: Cleans up the temporary files and directories after tests are run.
- **test_create_asgi_app**: Tests the creation of an ASGI app builder and verifies that it returns an instance of `ASGIAppBuilder`.
- **test_app_base**: Tests that an application can be served at the root path and responds correctly.
- **test_app_redirect**: Tests that an application can be served at a non-root path and responds correctly.
- **test_multiple_apps**: Tests that multiple applications can be served under different paths and that requests to undefined paths return 404.
- **test_root_doesnt_conflict_when_root_is_last**: Tests that the root path does not conflict with other paths when added last.
- **test_root_doesnt_conflict_when_root_is_first**: Tests that the root path does not conflict with other paths when added first.
- **test_can_include_code**: Tests that the application can include code when configured to do so.
- **test_can_hit_health**: Tests that a health check endpoint is correctly configured and responds as expected.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `os` | Used for file path operations. |
| `tempfile` | Used to create temporary directories and files for testing. |
| `unittest` | Provides the testing framework. |
| `starlette.testclient` | Used to simulate HTTP requests to the ASGI applications. |

## Error Handling

The tests use assertions to verify expected outcomes. If an assertion fails, it indicates a problem with the ASGI application configuration or behavior.

## Logging

No explicit logging is implemented in the test file. The `unittest` framework will report test results and any assertion failures.

## TODOs

No TODOs or notes are present in the code.