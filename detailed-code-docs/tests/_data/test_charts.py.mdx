---
title: "test_charts.py"
---

## High-level description

The `test_charts.py` file is a test suite designed to validate the functionality of chart-building components within the `marimo` library. It primarily tests the generation of Altair chart code and JSON representations for different data types, ensuring that the generated code is syntactically correct and handles special characters in column names. The tests also verify the integration with optional dependencies like `pandas` and `altair`.

## Code Structure

The main symbols in the code are test functions that utilize the `pytest` framework to perform assertions on the chart-building logic. These functions interact with the `ChartBuilder` class and its methods, such as `altair_code` and `altair_json`, to generate and validate chart representations. The `snapshotter` utility is used to manage and compare test outputs with expected results stored in snapshot files.

## References

- `ChartBuilder` and `get_chart_builder` from `marimo._data.charts`: These are used to create chart builders for different data types.
- `DataType` from `marimo._data.models`: Represents the data types used in the tests.
- `DependencyManager` from `marimo._dependencies.dependencies`: Checks for the presence of optional dependencies like `pandas` and `altair`.
- `snapshotter` from `tests.mocks`: A utility for creating and comparing test snapshots.

## Symbols

### `test_get_chart_builder`
#### Description
Tests the `get_chart_builder` function to ensure it returns an instance of `ChartBuilder` for each data type specified in the `TYPES` list.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| t | DataType | The data type for which a chart builder is requested. |
| should_limit_to_10_items | bool | Indicates if the chart should be limited to 10 items. |

#### Outputs
None

### `test_charts_altair_code`
#### Description
Validates that the Altair code generated by `ChartBuilder` instances is syntactically correct Python code.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| t | DataType | The data type for which Altair code is generated. |
| should_limit_to_10_items | bool | Indicates if the chart should be limited to 10 items. |

#### Outputs
None

#### Internal Logic
- Iterates over each data type in `TYPES`.
- Generates Altair code using `altair_code`.
- Parses the code with `ast.parse` to ensure it is valid Python.
- Appends the code to a list for snapshot comparison.

### `test_charts_bad_characters`
#### Description
Tests the handling of special characters in column names when generating Altair code.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| char | str | A special character to be included in the column name. |
| name | str | A descriptive name for the special character. |

#### Outputs
None

#### Internal Logic
- Uses a predefined set of special characters.
- Generates Altair code for column names containing these characters.
- Compares the output with a snapshot.

### `test_charts_altair_json`
#### Description
Tests the generation of Altair JSON representations for different data types, ensuring they are valid JSON.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| t | DataType | The data type for which Altair JSON is generated. |
| should_limit_to_10_items | bool | Indicates if the chart should be limited to 10 items. |

#### Outputs
None

#### Internal Logic
- Checks for the presence of `pandas` and `altair` dependencies.
- Generates Altair JSON using `altair_json`.
- Validates the JSON using `alt.Chart.from_json`.

### `test_charts_altair_json_bad_data`
#### Description
Tests the generation of Altair JSON for column names with special characters, ensuring the JSON is valid.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| data | DataFrame | A DataFrame with a column name containing special characters. |

#### Outputs
None

#### Internal Logic
- Uses a DataFrame with a specially crafted column name.
- Generates Altair JSON and validates it.

## Dependencies

| Dependency | Purpose |
|:-----------|:--------|
| `pytest` | Used for structuring and running the test cases. |
| `ast` | Used to parse and validate Python code syntax. |
| `pandas` | Optional dependency for handling data frames in tests. |
| `altair` | Optional dependency for generating and validating chart JSON. |

## Error Handling

- The tests raise `SyntaxError` if the generated Python code is invalid.
- JSON validation errors are implicitly handled by `alt.Chart.from_json`.

## Logging

- The `snapshotter` utility provides feedback by printing "Snapshot updated" when snapshots are created or updated.

## TODOs

None